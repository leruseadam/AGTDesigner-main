<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>AGT Label Maker - Professional Cannabis Label Generation - UPDATED</title>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:title" content="AGT Label Maker - Professional Cannabis Label Generation">
  <meta property="og:description" content="Create professional cannabis labels with AGT Label Maker. Generate compliant labels with custom branding, strain information, and regulatory requirements.">
  <meta property="og:image" content="{{ request.url_root }}{{ url_for('static', filename='social-preview.png') }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="AGT Label Maker">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="{{ request.url }}">
  <meta property="twitter:title" content="AGT Label Maker - Professional Cannabis Label Generation">
  <meta property="twitter:description" content="Create professional cannabis labels with AGT Label Maker. Generate compliant labels with custom branding, strain information, and regulatory requirements.">
  <meta property="twitter:image" content="{{ request.url_root }}{{ url_for('static', filename='social-preview.png') }}">
  
  <!-- Additional Meta Tags -->
  <meta name="description" content="Create professional cannabis labels with AGT Label Maker. Generate compliant labels with custom branding, strain information, and regulatory requirements.">
  <meta name="keywords" content="cannabis labels, label maker, AGT, professional labels, cannabis compliance, strain labels">
  <meta name="author" content="AGT">
  <meta name="robots" content="index, follow">
  
  <!-- Stylesheets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v={{ cache_bust }}">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  
  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Performance Optimizations -->
  <script src="{{ url_for('static', filename='js/performance.js') }}?v={{ cache_bust }}"></script>
  
  <!-- Preload critical resources -->
  <link rel="preload" href="{{ url_for('static', filename='css/styles.css') }}" as="style">
  <link rel="preload" href="{{ url_for('static', filename='js/performance.js') }}" as="script">
  
  <!-- Performance hints -->
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="//code.jquery.com">
  
  <!-- Define global functions early -->
  <script>
    console.log('Defining global functions early in head...');
    
    // CRITICAL: Set Bothell as default store IMMEDIATELY - this runs before any other code
    (function() {
      console.log('IMMEDIATE: Setting Bothell as default store...');
      // Set localStorage immediately
      localStorage.setItem('selectedStore', 'AGT_Bothell');
      
      // Try to update display immediately if elements exist
      setTimeout(function() {
        const displayElement = document.getElementById('currentStoreDisplay');
        if (displayElement) {
          displayElement.textContent = 'AGT Bothell';
          displayElement.style.color = '#4ade80';
          console.log('IMMEDIATE: Set display to AGT Bothell');
        }
        
        const statusElement = document.getElementById('storeStatus');
        if (statusElement) {
          statusElement.textContent = 'Store: AGT Bothell';
          statusElement.className = 'store-status active';
          console.log('IMMEDIATE: Set status to AGT Bothell');
        }
      }, 100);
    })();
    
    // VIEWPORT NORMALIZATION FOR CONSISTENT SCALING
    // This ensures viewport units behave identically across local and web environments
    (function() {
      'use strict';
      
      // Normalize viewport units for consistent scaling
      function normalizeViewport() {
        const vw = window.innerWidth / 100;
        const vh = window.innerHeight / 100;
        const vmin = Math.min(vw, vh);
        const vmax = Math.max(vw, vh);
        
        // Set normalized viewport units as CSS custom properties
        document.documentElement.style.setProperty('--vw', vw + 'px');
        document.documentElement.style.setProperty('--vh', vh + 'px');
        document.documentElement.style.setProperty('--vmin', vmin + 'px');
        document.documentElement.style.setProperty('--vmax', vmax + 'px');
        
        // Environment detection and scaling adjustment
        const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
        const isPythonAnywhere = window.location.hostname.includes('pythonanywhere.com');
        
        // Apply environment-specific scaling factors
        let envScaleFactor = 1;
        let envFontMultiplier = 1;
        
        if (isLocal) {
          // Local environment - ensure consistent scaling
          envScaleFactor = 1;
          envFontMultiplier = 1;
        } else if (isPythonAnywhere) {
          // PythonAnywhere - apply normalization
          envScaleFactor = 0.95;
          envFontMultiplier = 1.05;
        }
        
        document.documentElement.style.setProperty('--env-scale-factor', envScaleFactor);
        document.documentElement.style.setProperty('--env-font-multiplier', envFontMultiplier);
        
        console.log(`Viewport normalized: ${vw}px/vw, ${vh}px/vh, env-scale: ${envScaleFactor}, font-mult: ${envFontMultiplier}`);
      }
      
      // Run normalization on load and resize
      normalizeViewport();
      window.addEventListener('resize', normalizeViewport);
      window.addEventListener('orientationchange', normalizeViewport);
      
      // Re-normalize after a short delay to catch any late-loading elements
      setTimeout(normalizeViewport, 100);
      setTimeout(normalizeViewport, 500);
    })();
    
    // Define showDatabaseEditor function immediately to prevent errors
    window.showDatabaseEditor = function() {
      console.log('Opening Edit DB...');
      // Check if the modal exists
      const modalElement = document.getElementById('databaseEditorModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Load products when modal opens
        if (window.loadDatabaseProducts) {
          window.loadDatabaseProducts();
        }
        
        // Setup search functionality
        const searchInput = document.getElementById('dbSearchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            if (window.searchProducts) {
              window.searchProducts(this.value);
            }
          });
        }
      } else {
        console.error('Edit DB Modal not found');
      }
    };
    
    // Define placeholder functions for database editor to prevent errors
    window.searchProducts = window.searchProducts || function() { console.log('searchProducts not yet loaded'); };
    window.displayProducts = window.displayProducts || function() { console.log('displayProducts not yet loaded'); };
    window.updateResultCount = window.updateResultCount || function() { console.log('updateResultCount not yet loaded'); };
    window.addNewProduct = window.addNewProduct || function() { console.log('addNewProduct not yet loaded'); };
    window.editProduct = window.editProduct || function() { console.log('editProduct not yet loaded'); };
    window.deleteProduct = window.deleteProduct || function() { console.log('deleteProduct not yet loaded'); };
    // Consolidated lineage badge color function
    window.getLineageBadgeColor = function(lineage) {
      if (!lineage) return 'secondary';
      const l = lineage.toUpperCase();
      switch(l) {
        case 'SATIVA': return 'danger';
        case 'INDICA': return 'primary';
        case 'HYBRID': return 'success';
        case 'HYBRID/SATIVA': return 'warning';
        case 'HYBRID/INDICA': return 'info';
        case 'CBD': return 'secondary';
        case 'MIXED': return 'dark';
        default: return 'secondary';
      }
    };
    window.showError = window.showError || function() { console.log('showError not yet loaded'); };
    
    
    // Store Management Functions
    function changeStore(storeValue) {
      if (!storeValue) {
        updateStoreStatus('Please select a store', 'inactive');
        return;
      }
      
      // Save store selection to localStorage
      localStorage.setItem('selectedStore', storeValue);
      
      // Update store status
      updateStoreStatus(`Store: ${storeValue.replace(/_/g, ' ')}`, 'active');
      
      // Send store selection to backend
      fetch('/api/set-store', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ store: storeValue })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Store selection saved to backend:', storeValue);
          // Clear any existing data to ensure fresh start with new store
          clearExistingData();
        } else {
          console.error('Failed to save store selection:', data.error);
          updateStoreStatus('Failed to save store selection', 'inactive');
        }
      })
      .catch(error => {
        console.error('Error saving store selection:', error);
        updateStoreStatus('Error saving store selection', 'inactive');
      });
    }
    
    function selectStore(storeValue) {
      // Close the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('storeSelectionModal'));
      if (modal) {
        modal.hide();
      }
      
      // Set the store
      changeStore(storeValue);
      
      // Update the display
      updateCurrentStoreDisplay(storeValue);
    }
    
    function showStoreSelectionModal() {
      try {
        console.log('Attempting to show store selection modal...');
        
        // Check if Bootstrap is available
        if (typeof bootstrap === 'undefined') {
          console.error('Bootstrap not available, cannot show modal');
          return;
        }
        
        const modalElement = document.getElementById('storeSelectionModal');
        if (!modalElement) {
          console.error('Store selection modal element not found');
          return;
        }
        
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Store selection modal shown successfully');
      } catch (error) {
        console.error('Error showing store selection modal:', error);
      }
    }
    
    // Make function globally available for main.js
    window.showStoreSelectionModal = showStoreSelectionModal;
    
    // Function to verify modal element exists
    function verifyModalExists() {
      const modalElement = document.getElementById('storeSelectionModal');
      if (modalElement) {
        console.log('✅ Store selection modal element found');
        return true;
      } else {
        console.error('❌ Store selection modal element NOT found');
        return false;
      }
    }
    
    // Function to force modal display
    function forceShowModal() {
      console.log('Force showing modal...');
      const modalElement = document.getElementById('storeSelectionModal');
      if (modalElement) {
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        modalElement.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
        
        console.log('Modal forced to show');
      } else {
        console.error('Cannot force show modal - element not found');
      }
    }
    
    function updateCurrentStoreDisplay(storeValue) {
      console.log('updateCurrentStoreDisplay called with:', storeValue);
      const displayElement = document.getElementById('currentStoreDisplay');
      console.log('displayElement found:', !!displayElement);
      if (displayElement) {
        if (storeValue) {
          displayElement.textContent = storeValue.replace(/_/g, ' ');
          displayElement.style.color = '#4ade80';
          console.log('Set display to:', storeValue.replace(/_/g, ' '));
        } else {
          displayElement.textContent = 'No store selected';
          displayElement.style.color = '#f87171';
          console.log('Set display to: No store selected');
        }
      } else {
        console.error('currentStoreDisplay element not found!');
      }
    }
    
    function updateStoreStatus(message, status) {
      const statusElement = document.getElementById('storeStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `store-status ${status}`;
      }
    }
    
    function clearExistingData() {
      // Clear selected tags
      if (window.excelProcessor && window.excelProcessor.selected_tags) {
        window.excelProcessor.selected_tags = [];
      }
      
      // Clear session data
      sessionStorage.removeItem('selectedTags');
      
      // Clear any cached data
      if (window.clearJsonMatches) {
        window.clearJsonMatches();
      }
      
      console.log('Cleared existing data for new store selection');
    }
    
    function loadSavedStore() {
      // Always default to Bothell upon loading
      console.log('Setting default store to AGT_Bothell upon loading');
      changeStore('AGT_Bothell');
      updateCurrentStoreDisplay('AGT_Bothell');
      
      // Also check backend for current store status
      updateStoreStatusFromBackend();
    }
    
    function updateStoreStatusFromBackend() {
      fetch('/api/get-store')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.store) {
            // Update the display
            updateCurrentStoreDisplay(data.store);
            updateStoreStatus(`Store: ${data.store.replace(/_/g, ' ')}`, 'active');
          } else {
            // No store set in backend, ensure Bothell is set
            console.log('No store in backend, ensuring AGT_Bothell is set');
            changeStore('AGT_Bothell');
          }
        })
        .catch(error => {
          console.log('Error checking backend, ensuring AGT_Bothell is set');
          // Ensure Bothell is set as default
          changeStore('AGT_Bothell');
        });
    }
    
    function checkStoreRequired() {
      console.log('Checking if store selection is required...');
      fetch('/api/check-store-required')
        .then(response => response.json())
        .then(data => {
          console.log('Store requirement check response:', data);
          if (data.success && data.requires_store) {
            // Store selection is required, show modal
            console.log('Store selection required, showing modal');
            showStoreSelectionModal();
          } else {
            console.log('Store selection not required, current store:', data.store);
          }
        })
        .catch(error => {
          console.log('Error checking store requirement:', error);
          // If there's an error, show modal as fallback
          showStoreSelectionModal();
        });
    }
    
    function generateJsonInventory() {
      const url = document.getElementById('jsonInventoryUrlInput').value.trim();
      if (!url) {
        console.error('Please enter a JSON URL');
        return;
      }
      
      if (!url.toLowerCase().startsWith('http')) {
        console.error('Please enter a valid HTTP URL');
        return;
      }
      
      // Show loading state
      const generateBtn = document.querySelector('#jsonInventoryModal .btn-modern2');
      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
      generateBtn.disabled = true;
      
      fetch('/api/json-inventory', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url })
      })
      .then(response => {
        if (response.ok) {
          // Download the file
          return response.blob().then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.download = `AGT_Inventory_Slips_${timestamp}.docx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Inventory slips generated successfully
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('jsonInventoryModal'));
            if (modal) {
              modal.hide();
            }
          });
        } else {
          return response.json().then(data => {
            throw new Error(data.error || 'Failed to generate inventory slips');
          });
        }
      })
      .catch(error => {
        console.error('Error generating JSON inventory:', error);
      })
      .finally(() => {
        // Reset button state
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
      });
    }
    
    window.openDatabaseAnalytics = function() {
      console.log('openDatabaseAnalytics called');
      
      // Prevent multiple simultaneous calls
      if (window._analyticsLoading) {
        console.log('Analytics already loading, skipping...');
        return;
      }
      window._analyticsLoading = true;
      
      try {
        const loadingHtml = `
          <div class="text-center">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading interactive analytics dashboard...</p>
          </div>
        `;
        showDatabaseModal('Database Analytics Dashboard', loadingHtml);

        // Fetch all data with individual timeout and error handling
        const fetchWithTimeout = (url, timeout = 10000) => {
          console.log(`Fetching: ${url}`);
          return Promise.race([
            fetch(url).then(r => {
              console.log(`Response from ${url}: ${r.status}`);
              if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
              return r.json();
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Timeout after ${timeout}ms`)), timeout)
            )
          ]);
        };

        Promise.allSettled([
          fetchWithTimeout('/api/database-stats').catch(e => ({ error: `Stats: ${e.message}`, total_strains: 0 })),
          fetchWithTimeout('/api/database-vendor-stats').catch(e => ({ 
            error: `Vendor Stats: ${e.message}`, 
            summary: { total_vendors: 0, total_brands: 0 }, 
            vendors: [], 
            product_types: [], 
            vendor_brands: [] 
          })),
          fetchWithTimeout('/api/database-analytics').catch(e => ({ error: `Analytics: ${e.message}` })),
          fetchWithTimeout('/api/available-tags').catch(e => { console.error('Available tags failed:', e); return []; })
        ])
        .then((results) => {
          console.log('All promises settled:', results);
          const [statsResult, vendorStatsResult, analyticsResult, availableTagsResult] = results;
          const stats = statsResult.value || statsResult.reason || { total_strains: 0 };
          const vendorStats = vendorStatsResult.value || vendorStatsResult.reason || { 
            summary: { total_vendors: 0, total_brands: 0 }, 
            vendors: [], 
            product_types: [], 
            vendor_brands: [] 
          };
          const analytics = analyticsResult.value || analyticsResult.reason || {};
          const availableTags = availableTagsResult.value || [];
          
          const totalProducts = Array.isArray(availableTags) ? availableTags.length : 0;
          const totalStrains = stats.total_strains || 0;
          
          console.log('Analytics data loaded:', { 
            products: totalProducts, 
            strains: totalStrains, 
            vendors: vendorStats.summary?.total_vendors || 0,
            brands: vendorStats.summary?.total_brands || 0
          });
        
          const analyticsHtml = `
            <div class="database-analytics">
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="card glass-card text-center">
                    <div class="card-body">
                      <h3 class="text-primary">${totalProducts}</h3>
                      <p class="mb-0">Total Products</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card glass-card text-center">
                    <div class="card-body">
                      <h3 class="text-success">${totalStrains}</h3>
                      <p class="mb-0">Unique Strains</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card glass-card text-center">
                    <div class="card-body">
                      <h3 class="text-warning">${vendorStats.summary?.total_vendors || 0}</h3>
                      <p class="mb-0">Active Vendors</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card glass-card text-center">
                    <div class="card-body">
                      <h3 class="text-info">${vendorStats.summary?.total_brands || 0}</h3>
                      <p class="mb-0">Product Brands</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="card glass-card">
                    <div class="card-header">
                      <h6 class="mb-0">Top Vendors</h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                      ${vendorStats.vendors && vendorStats.vendors.length > 0 ? 
                        vendorStats.vendors.slice(0, 10).map((vendor, index) => 
                          `<div class="d-flex justify-content-between align-items-center py-2 ${index < vendorStats.vendors.length - 1 ? 'border-bottom' : ''}">
                            <div>
                              <strong>${vendor.vendor || 'Unknown'}</strong>
                              <small class="text-muted d-block">${vendor.unique_brands || 0} brands, ${vendor.unique_product_types || 0} types</small>
                            </div>
                            <span class="badge bg-primary">${vendor.product_count || 0}</span>
                          </div>`
                        ).join('') : 
                        '<p class="text-muted">No vendor data available. Upload Excel files to see vendor statistics.</p>'
                      }
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card glass-card">
                    <div class="card-header">
                      <h6 class="mb-0">Top Product Types</h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                      ${vendorStats.product_types && vendorStats.product_types.length > 0 ? 
                        vendorStats.product_types.slice(0, 10).map((type, index) => 
                          `<div class="d-flex justify-content-between align-items-center py-2 ${index < vendorStats.product_types.length - 1 ? 'border-bottom' : ''}">
                            <div>
                              <strong>${type.product_type || 'Unknown'}</strong>
                              <small class="text-muted d-block">${type.unique_vendors || 0} vendors, ${type.unique_brands || 0} brands</small>
                            </div>
                            <span class="badge bg-success">${type.product_count || 0}</span>
                          </div>`
                        ).join('') : 
                        '<p class="text-muted">No product type data available. Upload Excel files to see product analytics.</p>'
                      }
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12">
                  <div class="card glass-card">
                    <div class="card-header">
                      <h6 class="mb-0">Top Vendor-Brand Combinations</h6>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm">
                          <thead class="sticky-top bg-dark">
                            <tr>
                              <th>Vendor</th>
                              <th>Brand</th>
                              <th>Product Types</th>
                              <th>Products</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${vendorStats.vendor_brands && vendorStats.vendor_brands.length > 0 ? 
                              vendorStats.vendor_brands.slice(0, 20).map(combo => 
                                `<tr>
                                  <td><strong>${combo.vendor || 'Unknown'}</strong></td>
                                  <td>${combo.brand || 'Unknown'}</td>
                                  <td><span class="badge bg-info">${combo.unique_product_types || 0} types</span></td>
                                  <td><span class="badge bg-primary">${combo.product_count || 0}</span></td>
                                </tr>`
                              ).join('') : 
                              '<tr><td colspan="4" class="text-muted text-center">No vendor-brand data available. Upload Excel files to see detailed analytics.</td></tr>'
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col-12">
                  <div class="alert alert-info">
                    <h6>Analytics Summary</h6>
                    <p class="mb-0">
                      ${totalProducts > 0 ? 
                        `This comprehensive dashboard shows real-time statistics from your product database with ${totalProducts} products currently loaded. Data is automatically updated each time you upload new Excel files.` :
                        'Upload Excel files to populate the database and unlock detailed vendor analytics, strain statistics, and performance metrics.'
                      }
                    </p>
                    ${stats.error || vendorStats.error || analytics.error ? 
                      `<small class="text-warning d-block mt-2">Some data may be limited due to: ${[stats.error, vendorStats.error, analytics.error].filter(e => e).join(', ')}</small>` : 
                      ''
                    }
                  </div>
                </div>
              </div>
            </div>
          `;
          
          showDatabaseModal('Database Analytics Dashboard', analyticsHtml);
          
          // Reset loading flag
          window._analyticsLoading = false;
        })
        .catch(error => {
          console.error('Error loading database analytics:', error);
          const errorHtml = `
            <div class="alert alert-danger">
              <h6>⚠️ Error Loading Analytics</h6>
              <p>Unable to load database analytics. This might be because:</p>
              <ul class="mb-3">
                <li>No Excel file has been uploaded yet</li>
                <li>Database is still being initialized</li>
                <li>Server connectivity issues</li>
                <li>Database endpoints are not responding</li>
              </ul>
              <p class="mb-0"><strong>Try:</strong> Upload an Excel file first, then wait a moment for the database to populate</p>
              <small class="text-muted">Error: ${error.message}</small>
            </div>
          `;
          showDatabaseModal('Database Analytics Dashboard', errorHtml);
          
          // Reset loading flag
          window._analyticsLoading = false;
        });
      } catch (error) {
        console.error('Error in openDatabaseAnalytics:', error);
        alert('Error opening database analytics: ' + error.message);
        
        // Reset loading flag
        window._analyticsLoading = false;
      }
    };
    
                window.openLineageEditor = function() {
              console.log('Enhanced Lineage Editor called - REDIRECTING to enhanced modals');
              // DIRECTLY call our enhanced function instead of the old modal
              if (window.openEnhancedLineageEditor) {
                window.openEnhancedLineageEditor();
        } else {
                console.log('Enhanced function not ready, waiting...');
                // Wait for it to be available
                const checkInterval = setInterval(() => {
                  if (window.openEnhancedLineageEditor) {
                    clearInterval(checkInterval);
                    window.openEnhancedLineageEditor();
                  }
                }, 100);
              }
            };
    // showDatabaseModal is now handled by our override at the top of the page

                // Enhanced Lineage Editor Functions
            window.createEnhancedLineageEditor = function(browserData, vendorStats) {
              const strains = browserData.strains || [];
              const vendors = browserData.vendors || [];
              const vendorStrains = browserData.vendor_strains || [];
              
              return `
                <div class="enhanced-lineage-editor">
                  <div class="row">
                    <!-- Controls Panel -->
                    <div class="col-md-4">
                      <div class="card mb-3">
                        <div class="card-header">
                          <h6><i class="fas fa-search"></i> Search & Filter</h6>
                        </div>
                        <div class="card-body">
                          <div class="mb-3">
                            <label class="form-label">Search Strains</label>
                            <input type="text" class="form-control" id="strainSearchInput" placeholder="Type strain name...">
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Filter by Vendor</label>
                            <select class="form-select" id="vendorFilter">
                              <option value="">All Vendors</option>
                              ${vendors.map(v => `<option value="${v.vendor}">${v.vendor} (${v.total_products} products)</option>`).join('')}
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Filter by Lineage</label>
                            <select class="form-select" id="lineageFilter">
                              <option value="">All Lineages</option>
                              <option value="SATIVA">SATIVA</option>
                              <option value="INDICA">INDICA</option>
                              <option value="HYBRID">HYBRID</option>
                              <option value="HYBRID/SATIVA">HYBRID/SATIVA</option>
                              <option value="HYBRID/INDICA">HYBRID/INDICA</option>
                              <option value="CBD">CBD</option>
                              <option value="MIXED">MIXED</option>
                            </select>
                          </div>
                          <button class="btn btn-primary w-100" onclick="searchStrains()">
                            <i class="fas fa-search"></i> Search
                          </button>
                          <button class="btn btn-secondary w-100 mt-2" onclick="clearSearchFilters()">
                            <i class="fas fa-times"></i> Clear
                          </button>
                        </div>
                      </div>
                      
                      <div class="card mb-3">
                        <div class="card-header">
                          <h6><i class="fas fa-tools"></i> Bulk Actions</h6>
                        </div>
                        <div class="card-body">
                          <div class="mb-3">
                            <label class="form-label">Bulk Update Lineage</label>
                            <select class="form-select" id="bulkLineageSelect">
                              <option value="">Select lineage...</option>
                              <option value="SATIVA">SATIVA</option>
                              <option value="INDICA">INDICA</option>
                              <option value="HYBRID">HYBRID</option>
                              <option value="HYBRID/SATIVA">HYBRID/SATIVA</option>
                              <option value="HYBRID/INDICA">HYBRID/INDICA</option>
                              <option value="CBD">CBD</option>
                              <option value="MIXED">MIXED</option>
                            </select>
                          </div>
                          <button class="btn btn-warning w-100" onclick="applyBulkLineage()" disabled id="bulkUpdateBtn">
                            <i class="fas fa-edit"></i> Update Selected (<span id="selectedCount">0</span>)
                          </button>
                          <button class="btn btn-outline-secondary w-100 mt-2" onclick="selectAllVisible()">
                            <i class="fas fa-check-square"></i> Select All Visible
                          </button>
                          <button class="btn btn-outline-secondary w-100 mt-1" onclick="clearSelection()">
                            <i class="fas fa-square"></i> Clear Selection
                          </button>
                        </div>
                      </div>
                      
                      <div class="card">
                        <div class="card-header">
                          <h6><i class="fas fa-chart-bar"></i> Summary</h6>
                        </div>
                        <div class="card-body">
                          <div class="row text-center">
                            <div class="col-6">
                              <div class="stat-item">
                                <h4 class="text-primary">${strains.length}</h4>
                                <small>Total Strains</small>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="stat-item">
                                <h4 class="text-success">${vendors.length}</h4>
                                <small>Vendors</small>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Strains List Panel -->
                    <div class="col-md-8">
                      <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <h6><i class="fas fa-list"></i> Strain Database</h6>
                          <span class="badge bg-info" id="resultCount">${strains.length} strains</span>
                        </div>
                        <div class="card-body p-0">
                          <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="strainsTable">
                              <thead class="table-dark sticky-top">
                                <tr>
                                  <th width="40">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                  </th>
                                  <th>Strain Name</th>
                                  <th>Current Lineage</th>
                                  <th>Products</th>
                                  <th>Vendors</th>
                                  <th>Action</th>
                                </tr>
                              </thead>
                              <tbody id="strainsTableBody">
                                ${strains.slice(0, 50).map(strain => createStrainRow(strain)).join('')}
                              </tbody>
                            </table>
                          </div>
                          <div class="p-3 border-top">
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted">Showing first 50 results. Use search to find specific strains.</small>
                              <button class="btn btn-sm btn-outline-primary" onclick="loadMoreStrains()">
                                <i class="fas fa-plus"></i> Load More
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            };
            
            function createStrainRow(strain) {
              const lineage = strain.current_lineage || strain.canonical_lineage || 'Unknown';
              const vendors = strain.vendors ? strain.vendors.split(',').slice(0, 3).join(', ') : 'N/A';
              const vendorCount = strain.vendor_count || 0;
              const productCount = strain.product_count || 0;
              
              return `
                <tr data-strain-name="${strain.strain_name}">
                  <td>
                    <input type="checkbox" class="strain-checkbox" value="${strain.strain_name}" onchange="updateSelectionCount()">
                  </td>
                  <td>
                    <strong>${strain.strain_name}</strong>
                    ${strain.sovereign_lineage ? '<span class="badge bg-success ms-1" title="Manually set">Manual</span>' : ''}
                  </td>
                  <td>
                    <span class="badge bg-${getLineageBadgeColor(lineage)}">${lineage}</span>
                  </td>
                  <td>${productCount}</td>
                  <td title="${strain.vendors || 'N/A'}">
                    ${vendorCount > 0 ? `${vendorCount} vendor${vendorCount > 1 ? 's' : ''}` : 'N/A'}
                  </td>
                  <td>
                    <select class="form-select form-select-sm lineage-dropdown" 
                            onchange="updateStrainLineage('${strain.strain_name}', this.value)"
                            data-strain="${strain.strain_name}">
                      <option value="">Quick Change...</option>
                      <option value="SATIVA" ${lineage === 'SATIVA' ? 'selected' : ''}>SATIVA</option>
                      <option value="INDICA" ${lineage === 'INDICA' ? 'selected' : ''}>INDICA</option>
                      <option value="HYBRID" ${lineage === 'HYBRID' ? 'selected' : ''}>HYBRID</option>
                      <option value="HYBRID/SATIVA" ${lineage === 'HYBRID/SATIVA' ? 'selected' : ''}>HYBRID/SATIVA</option>
                      <option value="HYBRID/INDICA" ${lineage === 'HYBRID/INDICA' ? 'selected' : ''}>HYBRID/INDICA</option>
                      <option value="CBD" ${lineage === 'CBD' ? 'selected' : ''}>CBD</option>
                      <option value="MIXED" ${lineage === 'MIXED' ? 'selected' : ''}>MIXED</option>
                    </select>
                  </td>
                </tr>
              `;
            }
            
            // Use the consolidated function from window scope
            
            window.initializeEnhancedLineageEditor = function() {
              // Store current data globally for functions to access
              window.currentStrainData = [];
              window.selectedStrains = new Set();
              
              // Set up event listeners and initialize functionality
              updateSelectionCount();
              
              // Enable bulk update button when lineage is selected
              document.getElementById('bulkLineageSelect').addEventListener('change', function() {
                const selectedLineage = this.value;
                const selectedCount = window.selectedStrains.size;
                const bulkBtn = document.getElementById('bulkUpdateBtn');
                
                if (selectedLineage && selectedCount > 0) {
                  bulkBtn.disabled = false;
                  bulkBtn.innerHTML = `<i class="fas fa-edit"></i> Update ${selectedCount} strain${selectedCount > 1 ? 's' : ''} to ${selectedLineage}`;
                } else {
                  bulkBtn.disabled = true;
                  bulkBtn.innerHTML = `<i class="fas fa-edit"></i> Update Selected (<span id="selectedCount">0</span>)`;
                }
              });

              // Trigger search when pressing Enter in the search box
              const strainInput = document.getElementById('strainSearchInput');
              if (strainInput) {
                strainInput.addEventListener('keydown', function(e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    if (window.searchStrains) window.searchStrains();
                  }
                });
              }

              // Trigger search when changing vendor/lineage filters
              const vendorSelect = document.getElementById('vendorFilter');
              if (vendorSelect) {
                vendorSelect.addEventListener('change', function() {
                  if (window.searchStrains) window.searchStrains();
                });
              }

              const lineageSelect = document.getElementById('lineageFilter');
              if (lineageSelect) {
                lineageSelect.addEventListener('change', function() {
                  if (window.searchStrains) window.searchStrains();
                });
              }
            };
            
            // Enhanced Lineage Editor Interactive Functions
            window.searchStrains = async function() {
              const searchTerm = document.getElementById('strainSearchInput').value;
              const vendorFilter = document.getElementById('vendorFilter').value;
              const lineageFilter = document.getElementById('lineageFilter').value;
              
              try {
                const response = await fetch('/api/strain-search', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    search: searchTerm,
                    vendor: vendorFilter,
                    lineage: lineageFilter,
                    page: 1,
                    per_page: 100
                  })
                });
                
                const data = await response.json();
                if (data.strains) {
                  updateStrainsTable(data.strains);
                  document.getElementById('resultCount').textContent = `${data.strains.length} of ${data.pagination.total} strains`;
                } else {
                  console.error('Search failed:', data.error);
                }
              } catch (error) {
                console.error('Error searching strains:', error);
              }
            };
            
            window.clearSearchFilters = function() {
              document.getElementById('strainSearchInput').value = '';
              document.getElementById('vendorFilter').value = '';
              document.getElementById('lineageFilter').value = '';
              
              // Reload original data
              window.openLineageEditor();
            };
            
            window.updateStrainsTable = function(strains) {
              const tbody = document.getElementById('strainsTableBody');
              tbody.innerHTML = strains.map(strain => createStrainRow(strain)).join('');
              window.currentStrainData = strains;
              clearSelection();
            };
            
            window.updateStrainLineage = async function(strainName, newLineage) {
              if (!newLineage) return;
              
              try {
                const response = await fetch('/api/set-strain-lineage', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    strain_name: strainName,
                    lineage: newLineage
                  })
                });
                
                const result = await response.json();
                if (result.success) {
                  // Update the table row to reflect the change
                  const row = document.querySelector(`tr[data-strain-name="${strainName}"]`);
                  if (row) {
                    const lineageCell = row.children[2];
                    lineageCell.innerHTML = `<span class="badge bg-${getLineageBadgeColor(newLineage)}">${newLineage}</span>`;
                    
                    // Add manual badge if not already present
                    const nameCell = row.children[1];
                    if (!nameCell.querySelector('.badge')) {
                      nameCell.innerHTML += ' <span class="badge bg-success ms-1" title="Manually set">Manual</span>';
                    }
                  }
                  
                  // Show success toast
                  showToast(`Updated ${strainName} to ${newLineage}`, 'success');
                } else {
                  console.error('Failed to update strain lineage:', result.error);
                  showToast(`Failed to update ${strainName}: ${result.error}`, 'error');
                }
              } catch (error) {
                console.error('Error updating strain lineage:', error);
                showToast(`Error updating ${strainName}: ${error.message}`, 'error');
              }
            };
            
            window.updateSelectionCount = function() {
              const checkboxes = document.querySelectorAll('.strain-checkbox:checked');
              window.selectedStrains = new Set(Array.from(checkboxes).map(cb => cb.value));
              
              const count = window.selectedStrains.size;
              const countSpan = document.getElementById('selectedCount');
              if (countSpan) {
                countSpan.textContent = count;
              }
              
              // Update bulk update button
              const bulkBtn = document.getElementById('bulkUpdateBtn');
              const bulkSelect = document.getElementById('bulkLineageSelect');
              if (bulkBtn && bulkSelect) {
                const selectedLineage = bulkSelect.value;
                if (selectedLineage && count > 0) {
                  bulkBtn.disabled = false;
                  bulkBtn.innerHTML = `<i class="fas fa-edit"></i> Update ${count} strain${count > 1 ? 's' : ''} to ${selectedLineage}`;
                } else {
                  bulkBtn.disabled = true;
                  bulkBtn.innerHTML = `<i class="fas fa-edit"></i> Update Selected (<span id="selectedCount">${count}</span>)`;
                }
              }
            };
            
            window.toggleSelectAll = function() {
              const selectAllCheckbox = document.getElementById('selectAllCheckbox');
              const strainCheckboxes = document.querySelectorAll('.strain-checkbox');
              
              strainCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
              });
              
              updateSelectionCount();
            };
            
            window.selectAllVisible = function() {
              const strainCheckboxes = document.querySelectorAll('.strain-checkbox');
              strainCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
              });
              
              updateSelectionCount();
            };
            
            window.clearSelection = function() {
              const strainCheckboxes = document.querySelectorAll('.strain-checkbox');
              strainCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
              });
              
              const selectAllCheckbox = document.getElementById('selectAllCheckbox');
              if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
              }
              
              updateSelectionCount();
            };
            
            window.applyBulkLineage = async function() {
              const selectedLineage = document.getElementById('bulkLineageSelect').value;
              const selectedStrains = Array.from(window.selectedStrains);
              
              if (!selectedLineage || selectedStrains.length === 0) {
                showToast('Please select a lineage and at least one strain', 'warning');
                return;
              }
              
              // Confirm bulk update
              if (!confirm(`Are you sure you want to update ${selectedStrains.length} strain${selectedStrains.length > 1 ? 's' : ''} to ${selectedLineage}?`)) {
                return;
              }
              
              try {
                const updates = selectedStrains.map(strainName => ({
                  strain_name: strainName,
                  lineage: selectedLineage
                }));
                
                const response = await fetch('/api/bulk-update-lineage', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ updates })
                });
                
                const result = await response.json();
                if (result.success) {
                  // Update the table rows
                  result.results.forEach(update => {
                    if (update.success) {
                      const row = document.querySelector(`tr[data-strain-name="${update.strain_name}"]`);
                      if (row) {
                        const lineageCell = row.children[2];
                        lineageCell.innerHTML = `<span class="badge bg-${getLineageBadgeColor(selectedLineage)}">${selectedLineage}</span>`;
                        
                        // Add manual badge
                        const nameCell = row.children[1];
                        if (!nameCell.querySelector('.badge')) {
                          nameCell.innerHTML += ' <span class="badge bg-success ms-1" title="Manually set">Manual</span>';
                        }
                      }
                    }
                  });
                  
                  showToast(`Bulk update completed: ${result.summary.successful} successful, ${result.summary.failed} failed`, 'success');
                  clearSelection();
                } else {
                  showToast(`Bulk update failed: ${result.error}`, 'error');
                }
              } catch (error) {
                console.error('Error in bulk update:', error);
                showToast(`Bulk update error: ${error.message}`, 'error');
              }
            };
            
            window.loadMoreStrains = function() {
              // This would implement pagination - for now just show a message
              showToast('Use search filters to find specific strains', 'info');
            };
            
            window.showToast = function(message, type = 'info') {
              // Simple toast notification - you could enhance this with a proper toast library
              const alertClass = type === 'success' ? 'alert-success' : 
                               type === 'error' ? 'alert-danger' : 
                               type === 'warning' ? 'alert-warning' : 'alert-info';
              
              const toast = document.createElement('div');
              toast.className = `alert ${alertClass} position-fixed`;
              toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
              toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
              `;
              
              document.body.appendChild(toast);
              
              // Auto-remove after 5 seconds
              setTimeout(() => {
                if (toast.parentElement) {
                  toast.remove();
                }
              }, 5000);
            };
            
            // Excel Strain Editor Functions
            window.initializeExcelStrainEditor = function() {
              console.log('Initializing Excel strain editor...');
            };
            
            // Use the consolidated function from window scope
            
            window.filterStrainBrowser = function() {
              const searchTerm = document.getElementById('strainBrowserSearch').value.toLowerCase();
              const lineageFilter = document.querySelector('input[name="lineageFilter"]:checked').value;
              const sortBy = document.querySelector('input[name="sortBy"]:checked').value;
              const tableBody = document.getElementById('strainTableBody');
              const filteredCounter = document.getElementById('filteredStrains');
              
              if (!window.excelStrainData) {
                console.error('No Excel strain data available');
                return;
              }
              
              let filteredStrains = window.excelStrainData.filter(strain => {
                const matchesSearch = strain.strain_name.toLowerCase().includes(searchTerm);
                const matchesLineage = !lineageFilter || strain.current_lineage.includes(lineageFilter);
                return matchesSearch && matchesLineage;
              });
              
              // Sort strains based on selected criteria
              filteredStrains.sort((a, b) => {
                switch (sortBy) {
                  case 'name':
                    return a.strain_name.localeCompare(b.strain_name);
                  case 'products':
                    return b.product_count - a.product_count;
                  case 'vendors':
                    return b.vendor_count - a.vendor_count;
                  default:
                    return 0;
                }
              });
              
              // Update table content
              tableBody.innerHTML = filteredStrains.map(strain => `
                <tr class="strain-row" data-strain-name="${strain.strain_name.toLowerCase()}" data-lineage="${strain.current_lineage}">
                  <td>
                    <div class="strain-name-cell">
                      <strong>${strain.strain_name}</strong>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-${getLineageBadgeColor(strain.current_lineage)}">${strain.current_lineage}</span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <strong>${strain.product_count}</strong>
                    </div>
                  </td>
                  <td>
                    <div class="vendor-cell" title="${strain.vendors}">
                      <strong>${strain.vendor_count}</strong>
                      <small class="text-muted ms-1">${strain.vendors.length > 30 ? strain.vendors.substring(0, 30) + '...' : strain.vendors}</small>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group">
                      <select class="form-select form-select-sm" style="width: 140px" onchange="quickUpdateLineage('${strain.strain_name}', this.value)">
                        <option value="${strain.current_lineage}" selected>Set Lineage</option>
                        <option value="SATIVA">🌿 Sativa</option>
                        <option value="INDICA">🍇 Indica</option>
                        <option value="HYBRID">🌺 Hybrid</option>
                        <option value="HYBRID/SATIVA">🌺🌿 Hybrid/Sativa</option>
                        <option value="HYBRID/INDICA">🌺🍇 Hybrid/Indica</option>
                        <option value="CBD">💚 CBD</option>
                        <option value="MIXED">🌈 Mixed</option>
                      </select>
                      <button class="btn btn-sm btn-outline-info" onclick="viewStrainDetails('${strain.strain_name}')">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('');
              
              // Update counters
              filteredCounter.textContent = filteredStrains.length;
            };
            
            window.clearStrainBrowserSearch = function() {
              document.getElementById('strainBrowserSearch').value = '';
              document.getElementById('lineageAll').checked = true;
              document.getElementById('sortName').checked = true;
              filterStrainBrowser();
            };
            
            window.updateStrainCardsDisplay = function() {
              const cardsGrid = document.getElementById('strainCardsGrid');
              const loadMoreContainer = document.getElementById('loadMoreContainer');
              const loadMoreBtn = document.getElementById('loadMoreBtn');
              
              const strains = window.filteredStrainData || window.excelStrainData;
              const itemsPerPage = 24;
              const startIndex = 0;
              const endIndex = Math.min(itemsPerPage * (window.currentStrainPage + 1), strains.length);
              const visibleStrains = strains.slice(startIndex, endIndex);
              
              cardsGrid.innerHTML = visibleStrains.map(strain => `
                <div class="col-lg-4 col-md-6 mb-3 strain-card-item" data-strain-name="${strain.strain_name.toLowerCase()}" data-lineage="${strain.current_lineage}">
                  <div class="card strain-card h-100 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0 strain-name">${strain.strain_name}</h6>
                        <span class="badge bg-${getLineageBadgeColor(strain.current_lineage)} lineage-badge">${strain.current_lineage}</span>
                      </div>
                      <div class="strain-stats mb-3">
                        <div class="row text-center">
                          <div class="col-6">
                            <div class="stat-box">
                              <strong class="text-primary">${strain.product_count}</strong>
                              <br><small class="text-muted">Products</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="stat-box">
                              <strong class="text-info">${strain.vendor_count}</strong>
                              <br><small class="text-muted">Vendors</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="strain-vendors mb-2">
                        <small class="text-muted">
                          <i class="fas fa-store"></i> 
                          ${strain.vendors.length > 50 ? strain.vendors.substring(0, 50) + '...' : strain.vendors}
                        </small>
                      </div>
                      <div class="strain-actions">
                        <select class="form-select form-select-sm mb-2" id="lineage-${strain.strain_name.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="quickUpdateLineage('${strain.strain_name}', this.value)">
                          <option value="${strain.current_lineage}" selected>Current: ${strain.current_lineage}</option>
                          <option value="SATIVA">🌿 Sativa</option>
                          <option value="INDICA">🍇 Indica</option>
                          <option value="HYBRID">🌺 Hybrid</option>
                          <option value="HYBRID/SATIVA">🌺🌿 Hybrid/Sativa</option>
                          <option value="HYBRID/INDICA">🌺🍇 Hybrid/Indica</option>
                          <option value="CBD">💚 CBD</option>
                          <option value="MIXED">🌈 Mixed</option>
                        </select>
                        <button class="btn btn-sm btn-outline-info w-100" onclick="viewStrainDetails('${strain.strain_name}')">
                          <i class="fas fa-eye"></i> View Products
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('');
              
              // Update load more button
              const remaining = strains.length - endIndex;
              if (remaining > 0) {
                loadMoreContainer.style.display = 'block';
                loadMoreBtn.innerHTML = `<i class="fas fa-plus-circle"></i> Load More Strains (${remaining} remaining)`;
              } else {
                loadMoreContainer.style.display = 'none';
              }
            };
            
            window.loadMoreStrains = function() {
              window.currentStrainPage = (window.currentStrainPage || 0) + 1;
              
              const strains = window.filteredStrainData || window.excelStrainData;
              const itemsPerPage = 24;
              const startIndex = itemsPerPage * window.currentStrainPage;
              const endIndex = Math.min(itemsPerPage * (window.currentStrainPage + 1), strains.length);
              const newStrains = strains.slice(startIndex, endIndex);
              
              const cardsGrid = document.getElementById('strainCardsGrid');
              const loadMoreContainer = document.getElementById('loadMoreContainer');
              const loadMoreBtn = document.getElementById('loadMoreBtn');
              
              // Append new cards
              newStrains.forEach(strain => {
                const cardHtml = `
                  <div class="col-lg-4 col-md-6 mb-3 strain-card-item" data-strain-name="${strain.strain_name.toLowerCase()}" data-lineage="${strain.current_lineage}">
                    <div class="card strain-card h-100 shadow-sm">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <h6 class="card-title mb-0 strain-name">${strain.strain_name}</h6>
                          <span class="badge bg-${getLineageBadgeColor(strain.current_lineage)} lineage-badge">${strain.current_lineage}</span>
                        </div>
                        <div class="strain-stats mb-3">
                          <div class="row text-center">
                            <div class="col-6">
                              <div class="stat-box">
                                <strong class="text-primary">${strain.product_count}</strong>
                                <br><small class="text-muted">Products</small>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="stat-box">
                                <strong class="text-info">${strain.vendor_count}</strong>
                                <br><small class="text-muted">Vendors</small>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="strain-vendors mb-2">
                          <small class="text-muted">
                            <i class="fas fa-store"></i> 
                            ${strain.vendors.length > 50 ? strain.vendors.substring(0, 50) + '...' : strain.vendors}
                          </small>
                        </div>
                        <div class="strain-actions">
                          <select class="form-select form-select-sm mb-2" id="lineage-${strain.strain_name.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="quickUpdateLineage('${strain.strain_name}', this.value)">
                            <option value="${strain.current_lineage}" selected>Current: ${strain.current_lineage}</option>
                            <option value="SATIVA">🌿 Sativa</option>
                            <option value="INDICA">🍇 Indica</option>
                            <option value="HYBRID">🌺 Hybrid</option>
                            <option value="HYBRID/SATIVA">🌺🌿 Hybrid/Sativa</option>
                            <option value="HYBRID/INDICA">🌺🍇 Hybrid/Indica</option>
                            <option value="CBD">💚 CBD</option>
                            <option value="MIXED">🌈 Mixed</option>
                          </select>
                          <button class="btn btn-sm btn-outline-info w-100" onclick="viewStrainDetails('${strain.strain_name}')">
                            <i class="fas fa-eye"></i> View Products
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                cardsGrid.insertAdjacentHTML('beforeend', cardHtml);
              });
              
              // Update load more button
              const remaining = strains.length - endIndex;
              if (remaining > 0) {
                loadMoreBtn.innerHTML = `<i class="fas fa-plus-circle"></i> Load More Strains (${remaining} remaining)`;
              } else {
                loadMoreContainer.style.display = 'none';
              }
            };
            
            window.quickUpdateLineage = function(strainName, newLineage) {
              if (!newLineage || newLineage.startsWith('Current:')) return;
              
              // Update the strain data
              const strain = window.excelStrainData.find(s => s.strain_name === strainName);
              if (strain) {
                const oldLineage = strain.current_lineage;
                strain.current_lineage = newLineage;
                
                // Update the badge in the card
                const strainCard = document.querySelector(`[data-strain-name="${strainName.toLowerCase()}"]`);
                if (strainCard) {
                  const badge = strainCard.querySelector('.lineage-badge');
                  if (badge) {
                    badge.textContent = newLineage;
                    badge.className = `badge bg-${getLineageBadgeColor(newLineage)} lineage-badge`;
                  }
                  
                  // Update the dropdown to show current selection
                  const dropdown = strainCard.querySelector('select');
                  if (dropdown) {
                    dropdown.options[0].text = `Current: ${newLineage}`;
                    dropdown.options[0].value = newLineage;
                    dropdown.selectedIndex = 0;
                  }
                }
                
                showToast(`🌿 Updated "${strainName}" from ${oldLineage} → ${newLineage}`, 'success');
              }
            };
            window.viewStrainDetails = function(strainName) {
              const strain = window.excelStrainData.find(s => s.strain_name === strainName);
              if (!strain) {
                showToast(`Strain "${strainName}" not found`, 'error');
                return;
              }
              
              const detailsHtml = `
                <div class="strain-details">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">${strain.strain_name}</h4>
                    <span class="badge bg-${getLineageBadgeColor(strain.current_lineage)} fs-6">${strain.current_lineage}</span>
                  </div>
                  
                  <div class="row mb-4">
                    <div class="col-md-4 text-center">
                      <div class="stat-card p-3 bg-primary text-white rounded">
                        <h3 class="mb-0">${strain.product_count}</h3>
                        <small>Products</small>
                      </div>
                    </div>
                    <div class="col-md-4 text-center">
                      <div class="stat-card p-3 bg-info text-white rounded">
                        <h3 class="mb-0">${strain.vendor_count}</h3>
                        <small>Vendors</small>
                      </div>
                    </div>
                    <div class="col-md-4 text-center">
                      <div class="stat-card p-3 bg-success text-white rounded">
                        <h3 class="mb-0">${strain.brand_count}</h3>
                        <small>Brands</small>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <h6><i class="fas fa-store"></i> Available from these vendors:</h6>
                    <div class="vendor-list p-3 bg-light rounded">
                      ${strain.vendors.split(', ').map(vendor => `<span class="badge bg-secondary me-1 mb-1">${vendor.trim()}</span>`).join('')}
                    </div>
                  </div>
                  
                  ${strain.brands && strain.brands.trim() ? `
                    <div class="mb-3">
                      <h6><i class="fas fa-tag"></i> Available brands:</h6>
                      <div class="brand-list p-3 bg-light rounded">
                        ${strain.brands.split(', ').map(brand => `<span class="badge bg-outline-primary me-1 mb-1">${brand.trim()}</span>`).join('')}
                      </div>
                    </div>
                  ` : ''}
                  
                  <div class="mt-4">
                    <h6>Quick Lineage Update:</h6>
                    <select class="form-select" onchange="quickUpdateLineage('${strain.strain_name}', this.value); this.selectedIndex = 0;">
                      <option value="">Choose new lineage...</option>
                      <option value="SATIVA">🌿 Sativa</option>
                      <option value="INDICA">🍇 Indica</option>
                      <option value="HYBRID">🌺 Hybrid</option>
                      <option value="HYBRID/SATIVA">🌺🌿 Hybrid/Sativa</option>
                      <option value="HYBRID/INDICA">🌺🍇 Hybrid/Indica</option>
                      <option value="CBD">💚 CBD</option>
                      <option value="MIXED">🌈 Mixed</option>
                    </select>
                  </div>
                </div>
              `;
              
              showDatabaseModal(`${strain.strain_name} - Strain Details`, detailsHtml);
            };
            window.editExcelStrainLineage = function(strainName, currentLineage) {
              const newLineage = prompt(`Edit lineage for "${strainName}":\n\nCurrent: ${currentLineage}\n\nEnter new lineage (SATIVA, INDICA, HYBRID, HYBRID/SATIVA, HYBRID/INDICA, CBD, MIXED):`, currentLineage);
              
              if (newLineage && newLineage !== currentLineage) {
                // Update via the existing strain lineage API
                fetch('/api/set-strain-lineage', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    strain_name: strainName,
                    lineage: newLineage
                  })
                })
                .then(response => response.json())
                .then(result => {
                  if (result.success) {
                    // Update the table row
                    const row = document.querySelector(`tr[data-strain-name="${strainName}"]`);
                    if (row) {
                      const lineageCell = row.children[1];
                      lineageCell.innerHTML = `<span class="badge bg-${getLineageBadgeColor(newLineage)}">${newLineage}</span>`;
                    }
                    showToast(`Updated ${strainName} to ${newLineage}`, 'success');
                  } else {
                    showToast(`Failed to update ${strainName}: ${result.error}`, 'error');
                  }
                })
                .catch(error => {
                  console.error('Error updating strain:', error);
                  showToast(`Error updating ${strainName}: ${error.message}`, 'error');
                });
              }
            };
            
            console.log('Global functions defined:', {
              openDatabaseAnalytics: typeof window.openDatabaseAnalytics,
              openLineageEditor: typeof window.openLineageEditor,
              showDatabaseModal: typeof window.showDatabaseModal,
              createEnhancedLineageEditor: typeof window.createEnhancedLineageEditor,
              initializeEnhancedLineageEditor: typeof window.initializeEnhancedLineageEditor
            });
            
            // Enhanced Product Database Manager
            window.showProductDatabaseManager = function() {
              console.log('showProductDatabaseManager function called!');
              
              // Show loading state first
              const loadingHtml = `
                <div class="text-center">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-3">Loading Data & Analytics...</p>
                </div>
              `;
              
              showDatabaseModal('Data & Analytics', loadingHtml, 'database-modal');
              
              // Fetch database statistics and display enhanced interface
              fetch('/api/database-stats')
                .then(response => response.json())
                .then(data => {
                  const stats = data.stats || {};
                  const vendorStats = data.vendor_stats || {};
                  
                  const modalBody = document.querySelector('#databaseModal .modal-body');
                  if (modalBody) {
                    modalBody.innerHTML = `
                      <div class="container-fluid">
                        <div class="row mb-4">
                          <div class="col-12">
                            <h4 class="text-center mb-4">Database Statistics Overview</h4>
                          </div>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div class="row mb-4">
                          <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stats-card text-center h-100">
                              <div class="stats-content">
                                <h3 class="stats-number mb-2">${stats.total_products || 0}</h3>
                                <p class="stats-label mb-0">Total Products</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stats-card text-center h-100">
                              <div class="stats-content">
                                <h3 class="stats-number mb-2">${stats.unique_vendors || 0}</h3>
                                <p class="stats-label mb-0">Unique Vendors</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stats-card text-center h-100">
                              <div class="stats-content">
                                <h3 class="stats-number mb-2">${stats.unique_brands || 0}</h3>
                                <p class="stats-label mb-0">Unique Brands</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stats-card text-center h-100">
                              <div class="stats-content">
                                <h3 class="stats-number mb-2">${stats.unique_product_types || 0}</h3>
                                <p class="stats-label mb-0">Product Types</p>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Top Vendors and Brands -->
                        <div class="row mb-2">
                          <div class="col-md-6 mb-2">
                            <div class="card border-0 h-100" style="
                              background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                              border: 1px solid rgba(0, 212, 170, 0.3); 
                              border-radius: 12px;
                            ">
                              <div class="card-header py-1" style="background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(0, 212, 170, 0.4);">
                                <h6 class="mb-0 text-white">
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                  </svg>
                                  Top Vendors
                                  <button class="btn btn-sm btn-outline-info float-end" onclick="sortTable('vendorsTable', 1)" style="border-color: rgba(0, 212, 170, 0.6); color: rgba(0, 212, 170, 0.8);">Sort by Count</button>
                                </h6>
                              </div>
                              <div class="card-body p-1">
                                <div class="table-responsive" style="max-height: 160px; overflow-y: auto;">
                                  <table class="table table-sm table-hover mb-0" id="vendorsTable">
                                    <thead class="sticky-top" style="background: rgba(15, 23, 42, 0.9);">
                                      <tr>
                                        <th class="text-white" style="padding: 6px 8px;">Vendor</th>
                                        <th class="text-white" style="padding: 6px 8px;">Count</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${vendorStats.vendors ? vendorStats.vendors.slice(0, 5).map(vendor => 
                                        `<tr style="background: rgba(255, 255, 255, 0.05);">
                                          <td style="color: white !important; padding: 4px 8px;">${vendor.vendor}</td>
                                          <td style="padding: 4px 8px;"><span class="badge" style="background: rgba(0, 212, 170, 0.8); color: white; padding: 2px 6px; border-radius: 4px;">${vendor.product_count}</span></td>
                                        </tr>`
                                      ).join('') : '<tr><td colspan="2">No vendor data available</td></tr>'}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <div class="col-md-6 mb-2">
                            <div class="card border-0 h-100" style="
                              background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                              border: 1px solid rgba(0, 212, 170, 0.3); 
                              border-radius: 12px;
                            ">
                              <div class="card-header py-1" style="background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(0, 212, 170, 0.4);">
                                <h6 class="mb-0 text-white">
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                  </svg>
                                  Top Brands
                                  <button class="btn btn-sm btn-outline-info float-end" onclick="sortTable('brandsTable', 1)" style="border-color: rgba(0, 212, 170, 0.6); color: rgba(0, 212, 170, 0.8);">Sort by Count</button>
                                </h6>
                              </div>
                              <div class="card-body p-1">
                                <div class="table-responsive" style="max-height: 160px; overflow-y: auto;">
                                  <table class="table table-sm table-hover mb-0" id="brandsTable">
                                    <thead class="sticky-top" style="background: rgba(15, 23, 42, 0.9);">
                                      <tr>
                                        <th class="text-white" style="padding: 6px 8px;">Brand</th>
                                        <th class="text-white" style="padding: 6px 8px;">Count</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${vendorStats.brands ? vendorStats.brands.slice(0, 5).map(brand => 
                                        `<tr style="background: rgba(255, 255, 255, 0.05);">
                                          <td style="color: white !important; padding: 4px 8px;">${brand.brand}</td>
                                          <td style="padding: 4px 8px;"><span class="badge" style="background: rgba(0, 212, 170, 0.8); color: white; padding: 2px 6px; border-radius: 4px;">${brand.product_count}</span></td>
                                        </tr>`
                                      ).join('') : '<tr><td colspan="2">No brand data available</td></tr>'}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Product Type Distribution -->
                        <div class="row mb-2">
                          <div class="col-12">
                            <div class="card glass-card">
                              <div class="card-header py-1">
                                <h6 class="mb-0">
                                  <i class="bi bi-pie-chart me-2"></i>
                                  Product Type Distribution
                                </h6>
                              </div>
                              <div class="card-body p-2">
                                <div class="product-type-grid" style="
                                  max-height: 200px; 
                                  overflow-y: auto; 
                                  overflow-x: hidden;
                                ">
                                  ${stats.product_type_distribution ? Object.entries(stats.product_type_distribution).map(([type, count]) => {
                                    const percentage = Math.round((count / Object.values(stats.product_type_distribution).reduce((a, b) => a + b, 0)) * 100);
                                    const barWidth = Math.max(20, percentage * 2); // Minimum 20px width
                                    return `
                                      <div class="product-type-item" style="
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: space-between; 
                                        padding: 4px 6px; 
                                        margin-bottom: 2px; 
                                        background: linear-gradient(90deg, rgba(23, 162, 184, 0.1) 0%, rgba(23, 162, 184, 0.05) 100%); 
                                        border: 1px solid rgba(23, 162, 184, 0.3); 
                                        border-radius: 4px; 
                                        transition: all 0.3s ease;
                                        min-height: 24px;
                                        max-height: 28px;
                                        overflow: hidden;
                                      ">
                                        <div class="d-flex align-items-center">
                                          <span class="badge bg-info me-2" style="background-color: #17a2b8 !important; color: white !important; font-size: 0.7rem !important; padding: 0.2rem 0.4rem !important;">${type}</span>
                                          <span class="text-white-50" style="font-size: 0.75rem !important;">${count} products</span>
                                      </div>
                                        <div class="progress-bar-container" style="
                                          width: 70px; 
                                          height: 3px; 
                                          background: rgba(255, 255, 255, 0.1); 
                                          border-radius: 2px; 
                                          overflow: hidden;
                                          flex-shrink: 0;
                                          margin: 0 8px;
                                        ">
                                          <div class="progress-bar" style="
                                            width: ${barWidth}px; 
                                            height: 100%; 
                                            background: linear-gradient(90deg, #17a2b8, #20c997); 
                                            border-radius: 2px; 
                                            transition: width 0.5s ease;
                                          "></div>
                                </div>
                                        <span class="text-info" style="
                                          font-size: 0.65rem !important; 
                                          font-weight: 600; 
                                          min-width: 20px; 
                                          text-align: right;
                                          flex-shrink: 0;
                                        ">${percentage}%</span>
                                      </div>
                                    `;
                                  }).join('') : '<div class="col-12"><p class="text-muted">No product type data available</p></div>'}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Database Upload Section -->
                        <div class="row mt-2">
                          <div class="col-12">
                            <div class="card border-0" style="
                              background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                              border: 1px solid rgba(0, 212, 170, 0.3); 
                              border-radius: 12px;
                            ">
                              <div class="card-header py-2" style="background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(0, 212, 170, 0.4);">
                                <h6 class="mb-0 text-white">
                                  <i class="bi bi-database-gear me-2 text-info"></i>
                                  Database Upload & Management
                                </h6>
                              </div>
                              <div class="card-body p-3">
                                <!-- Upload Area -->
                                <div class="row mb-2">
                                  <div class="col-12">
                                    <div class="upload-area p-2 border-2 border-dashed rounded text-center" style="
                                      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(15, 23, 42, 0.7) 100%); 
                                      border-color: rgba(0, 212, 170, 0.4) !important; 
                                      border-radius: 12px;
                                    ">
                                      <div class="mb-2">
                                        <i class="bi bi-cloud-upload display-5 text-info"></i>
                                    </div>
                                      <h6 class="mb-2 text-white">Upload New Database File</h6>
                                      <p class="text-white-50 mb-2">Drag and drop your Excel file here, or click to browse</p>
                                      
                                      <div class="mb-2">
                                        <label for="databaseFile" class="form-label visually-hidden">Select Excel File</label>
                                        <div class="input-group justify-content-center">
                                          <input type="file" class="form-control" id="databaseFile" accept=".xlsx" style="
                                            max-width: 300px; 
                                            background: rgba(15, 23, 42, 0.9); 
                                            color: white; 
                                            border-color: rgba(0, 212, 170, 0.6);
                                            border-radius: 8px;
                                          " />
                                        </div>
                                        <div class="form-text mt-1 text-white-50">
                                          <i class="bi bi-info-circle me-1"></i>
                                          Only .xlsx files supported • Maximum size: 20MB
                                        </div>
                                      </div>
                                      
                                      <div class="d-flex gap-2 justify-content-center mb-2">
                                        <button class="btn btn-modern" onclick="uploadDatabase()" id="uploadBtn" style="
                                          background: linear-gradient(135deg, #28a745, #20c997); 
                                          border: none; 
                                          color: white; 
                                          padding: 8px 20px; 
                                          border-radius: 6px;
                                          font-weight: 600;
                                        ">
                                          <i class="bi bi-upload me-2"></i> Upload Database
                                        </button>
                                        
                                        <button class="btn btn-modern" onclick="exportDatabase()" style="
                                          background: rgba(108, 117, 125, 0.8); 
                                          border: 1px solid rgba(108, 117, 125, 0.6); 
                                          color: white; 
                                          padding: 8px 20px; 
                                          border-radius: 6px;
                                          font-weight: 600;
                                        ">
                                          <i class="bi bi-download me-2"></i> Export Database
                                        </button>
                                      </div>
                                      
                                    <div id="uploadStatus" class="mt-2"></div>
                                  </div>
                                  </div>
                                </div>
                                
                                <!-- Settings, Actions, and Tools -->
                                <div class="row">
                                                                     <div class="col-md-4 mb-2">
                                     <div class="card border-0" style="
                                       background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                                       border: 1px solid rgba(0, 212, 170, 0.3); 
                                       border-radius: 12px;
                                     ">
                                       <div class="card-body p-2">
                                         <h6 class="mb-2 text-white">
                                           <i class="bi bi-gear me-2 text-info"></i>Integration Settings
                                         </h6>
                                    <div class="form-check form-switch mb-3">
                                           <div class="d-flex align-items-start">
                                             <input class="form-check-input mt-1 me-3" type="checkbox" id="databaseIntegration" checked>
                                             <div class="flex-grow-1">
                                               <label class="form-check-label fw-bold text-white d-block" for="databaseIntegration">
                                                 <i class="bi bi-database-check me-2 text-success"></i>Enable Product Database Integration
                                      </label>
                                               <div class="form-text text-white-50 mt-1">
                                                 Use database for enhanced product matching and functionality
                                               </div>
                                             </div>
                                           </div>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                           <div class="d-flex align-items-start">
                                             <input class="form-check-input mt-1 me-3" type="checkbox" id="autoRefresh" checked>
                                             <div class="flex-grow-1">
                                               <label class="form-check-label fw-bold text-white d-block" for="autoRefresh">
                                                 <i class="bi bi-arrow-clockwise me-2 text-info"></i>Auto-refresh on Changes
                                      </label>
                                               <div class="form-text text-white-50 mt-1">
                                                 Automatically update UI when database changes
                                    </div>
                                  </div>
                                </div>
                              </div>
                                         <button class="btn btn-modern w-100" onclick="saveIntegrationSettings()" style="
                                           background: linear-gradient(135deg, #17a2b8, #20c997); 
                                           border: none; 
                                           color: white; 
                                           padding: 6px 12px; 
                                           border-radius: 6px;
                                         ">
                                           <i class="bi bi-save me-2"></i> Save Settings
                                         </button>
                            </div>
                          </div>
                        </div>
                        
                                   <div class="col-md-4 mb-2">
                                     <div class="card border-0" style="
                                       background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                                       border: 1px solid rgba(0, 212, 170, 0.3); 
                                       border-radius: 12px;
                                     ">
                                       <div class="card-body p-2">
                                         <h6 class="mb-2 text-white">
                                           <i class="bi bi-tools me-2 text-info"></i>Quick Actions
                                         </h6>
                                         <div class="d-grid gap-1">
                                           <button class="btn btn-modern" onclick="refreshDatabaseStats()" style="
                                             background: rgba(23, 162, 184, 0.8); 
                                             border: 1px solid rgba(23, 162, 184, 0.6); 
                                             color: white; 
                                             padding: 5px 10px; 
                                             border-radius: 6px;
                                           ">
                                             <i class="bi bi-arrow-clockwise me-2"></i> Refresh Stats
                            </button>
                                           <button class="btn btn-modern" onclick="openDatabaseAnalytics()" style="
                                             background: rgba(255, 193, 7, 0.8); 
                                             border: 1px solid rgba(255, 193, 7, 0.6); 
                                             color: white; 
                                             padding: 5px 10px; 
                                             border-radius: 6px;
                                           ">
                                             <i class="bi bi-graph-up me-2"></i> View Analytics
                            </button>
                                         </div>
                                       </div>
                                     </div>
                                   </div>
                                   
                                   <div class="col-md-4 mb-2">
                                     <div class="card border-0" style="
                                       background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%); 
                                       border: 1px solid rgba(0, 212, 170, 0.3); 
                                       border-radius: 12px;
                                     ">
                                       <div class="card-body p-2">
                                         <h6 class="mb-2 text-white">
                                           <i class="bi bi-tools me-2 text-info"></i>Advanced Tools
                                         </h6>
                                         <div class="d-grid gap-1">
                                           <button class="btn btn-modern" onclick="openDatabaseAnalytics()" style="
                                             background: rgba(23, 162, 184, 0.8); 
                                             border: 1px solid rgba(23, 162, 184, 0.6); 
                                             color: white; 
                                             padding: 5px 10px; 
                                             border-radius: 6px;
                                           ">
                                             <i class="bi bi-graph-up me-2"></i> Advanced Analytics
                                           </button>
                                           <button class="btn btn-modern" id="lineageEditorBtn" type="button" onclick="openEnhancedLineageEditor()" style="
                                             background: rgba(40, 167, 69, 0.8); 
                                             border: 1px solid rgba(40, 167, 69, 0.6); 
                                             color: white; 
                                             padding: 5px 10px; 
                                             border-radius: 6px;
                                           ">
                                             <i class="bi bi-diagram-3 me-2"></i> Lineage Editor
                            </button>
                                         </div>
                                       </div>
                                     </div>
                                   </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                })
                .catch(error => {
                  console.error('Error fetching database stats:', error);
                  const modalBody = document.querySelector('#databaseModal .modal-body');
                  if (modalBody) {
                    modalBody.innerHTML = `
                      <div class="text-center text-danger">
                        <h5>Error Loading Database Statistics</h5>
                        <p>Failed to load database information. Please try again.</p>
                        <button class="btn btn-modern" onclick="showProductDatabaseManager()">
                          <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                      </div>
                    `;
                  }
                });
            };
            // Database Upload Function
            window.uploadDatabase = function() {
              const fileInput = document.getElementById('databaseFile');
              const uploadStatus = document.getElementById('uploadStatus');
              const uploadBtn = document.querySelector('button[onclick="uploadDatabase()"]');
              
              if (!fileInput.files[0]) {
                uploadStatus.innerHTML = '<div class="alert alert-warning">Please select a file first.</div>';
                return;
              }
              
              const file = fileInput.files[0];
              
              // Validate file type
              if (!file.name.toLowerCase().endsWith('.xlsx')) {
                uploadStatus.innerHTML = '<div class="alert alert-danger">Only .xlsx files are allowed. Please select an Excel file.</div>';
                return;
              }
              
              // Validate file size (20MB limit)
              const maxSize = 20 * 1024 * 1024; // 20MB
              if (file.size > maxSize) {
                uploadStatus.innerHTML = '<div class="alert alert-danger">File too large. Maximum size is 20MB.</div>';
                return;
              }
              
              const formData = new FormData();
              formData.append('file', file);
              
              // Show loading state
              const originalBtnText = uploadBtn.innerHTML;
              uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
              uploadBtn.disabled = true;
              uploadStatus.innerHTML = '<div class="alert alert-info">Uploading database file...</div>';
              
              fetch('/api/product-db/upload', {
                method: 'POST',
                body: formData
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  uploadStatus.innerHTML = `
                    <div class="alert alert-success">
                      <i class="bi bi-check-circle me-2"></i>
                      <strong>Database uploaded successfully!</strong><br>
                      File: ${data.filename}<br>
                      Size: ${(data.size / 1024 / 1024).toFixed(2)} MB<br>
                      <small class="text-muted">Refreshing statistics...</small>
                    </div>
                  `;
                  fileInput.value = '';
                  
                  // Refresh the database statistics
                  setTimeout(() => {
                    showProductDatabaseManager();
                  }, 2000);
                } else {
                  uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Upload failed: ${data.error || 'Unknown error'}</div>`;
                }
              })
              .catch(error => {
                console.error('Upload error:', error);
                let errorMessage = 'Upload failed. Please try again.';
                
                if (error.message.includes('413')) {
                  errorMessage = 'File too large. Please select a smaller file.';
                } else if (error.message.includes('400')) {
                  errorMessage = 'Invalid file format. Please select a valid Excel file.';
                } else if (error.message.includes('500')) {
                  errorMessage = 'Server error. Please try again later.';
                } else if (error.message.includes('507')) {
                  errorMessage = 'Insufficient disk space. Please free up space and try again.';
                }
                
                uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${errorMessage}</div>`;
              })
              .finally(() => {
                // Reset button state
                uploadBtn.innerHTML = originalBtnText;
                uploadBtn.disabled = false;
              });
            };
            
            // Save Integration Settings
            window.saveIntegrationSettings = function() {
              const databaseIntegration = document.getElementById('databaseIntegration').checked;
              const autoRefresh = document.getElementById('autoRefresh').checked;
              const saveBtn = document.querySelector('button[onclick="saveIntegrationSettings()"]');
              
              // Show loading state
              const originalBtnText = saveBtn.innerHTML;
              saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
              saveBtn.disabled = true;
              
              const settings = {
                database_integration: databaseIntegration,
                auto_refresh: autoRefresh
              };
              
              // Store settings in localStorage
              localStorage.setItem('databaseIntegration', databaseIntegration);
              localStorage.setItem('autoRefresh', autoRefresh);
              
              // Send settings to backend if endpoint exists
              fetch('/api/product-db/settings', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
              })
              .then(response => {
                if (response.ok) {
                  return response.json();
                }
                throw new Error('Failed to save settings');
              })
              .then(data => {
                  // Show success message
                  const modalBody = document.querySelector('#databaseModal .modal-body');
                  if (modalBody) {
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success alert-dismissible fade show';
                    successDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Settings Saved!</strong> Integration preferences have been updated successfully.
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    modalBody.insertBefore(successDiv, modalBody.firstChild);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                      if (successDiv.parentNode) {
                        successDiv.remove();
                      }
                    }, 3000);
                }
              })
              .catch(error => {
                console.error('Error saving settings:', error);
                // Show warning that settings were saved locally
                const modalBody = document.querySelector('#databaseModal .modal-body');
                if (modalBody) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'alert alert-warning alert-dismissible fade show';
                  warningDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Settings Saved Locally!</strong> Integration preferences have been updated in your browser.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  `;
                  modalBody.insertBefore(warningDiv, modalBody.firstChild);
                  
                  // Auto-dismiss after 5 seconds
                  setTimeout(() => {
                    if (warningDiv.parentNode) {
                      warningDiv.remove();
                    }
                  }, 5000);
                }
              })
              .finally(() => {
                // Reset button state
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
              });
            };
            
            // Export Database Function
            window.exportDatabase = function() {
              const exportBtn = document.querySelector('button[onclick="exportDatabase()"]');
              
              // Show loading state
              const originalBtnText = exportBtn.innerHTML;
              exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exporting...';
              exportBtn.disabled = true;
              
              // Create a temporary link to trigger download
              const link = document.createElement('a');
              link.href = '/api/database-export';
              link.download = `AGT_Product_Database_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
              
              // Trigger download
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              // Reset button state after a short delay
              setTimeout(() => {
                exportBtn.innerHTML = originalBtnText;
                exportBtn.disabled = false;
              }, 1000);
            };
            
            // Refresh Database Stats Function
            window.refreshDatabaseStats = function() {
              const refreshBtn = document.querySelector('button[onclick="refreshDatabaseStats()"]');
              
              // Show loading state
              const originalBtnText = refreshBtn.innerHTML;
              refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
              refreshBtn.disabled = true;
              
              // Refresh the database statistics
              showProductDatabaseManager();
              
              // Reset button state after a short delay
              setTimeout(() => {
                refreshBtn.innerHTML = originalBtnText;
                refreshBtn.disabled = false;
              }, 1000);
            };
            
            // Load Integration Settings on Page Load
            document.addEventListener('DOMContentLoaded', function() {
              // Load saved settings from localStorage or use defaults
              const databaseIntegration = document.getElementById('databaseIntegration');
              const autoRefresh = document.getElementById('autoRefresh');
              
              if (databaseIntegration) {
                const savedIntegration = localStorage.getItem('databaseIntegration');
                databaseIntegration.checked = savedIntegration !== null ? savedIntegration === 'true' : true;
              }
              if (autoRefresh) {
                const savedRefresh = localStorage.getItem('autoRefresh');
                autoRefresh.checked = savedRefresh !== null ? savedRefresh === 'true' : true;
              }
              
              // Try to load settings from backend
              loadBackendSettings();
            });
            
            // Load settings from backend
            function loadBackendSettings() {
              fetch('/api/product-db/settings')
                .then(response => {
                  if (response.ok) {
                    return response.json();
                  }
                  throw new Error('Failed to load settings');
                })
                .then(data => {
                  if (data.success && data.settings) {
                    const databaseIntegration = document.getElementById('databaseIntegration');
                    const autoRefresh = document.getElementById('autoRefresh');
                    
                    if (databaseIntegration && data.settings.database_integration !== undefined) {
                      databaseIntegration.checked = data.settings.database_integration;
                      localStorage.setItem('databaseIntegration', data.settings.database_integration);
                    }
                    if (autoRefresh && data.settings.auto_refresh !== undefined) {
                      autoRefresh.checked = data.settings.auto_refresh;
                      localStorage.setItem('autoRefresh', data.settings.auto_refresh);
                    }
                    
                    console.log('Backend settings loaded successfully');
                  }
                })
                .catch(error => {
                  console.log('Using local settings (backend not available):', error.message);
                });
            }
            
            // File validation function
            function validateDatabaseFile(file) {
              const maxSize = 20 * 1024 * 1024; // 20MB
              const allowedTypes = ['.xlsx'];
              
              // Check file size
              if (file.size > maxSize) {
                return {
                  valid: false,
                  error: `File too large. Maximum size is ${(maxSize / 1024 / 1024).toFixed(0)}MB.`
                };
              }
              
              // Check file type
              const fileName = file.name.toLowerCase();
              const hasValidExtension = allowedTypes.some(ext => fileName.endsWith(ext));
              if (!hasValidExtension) {
                return {
                  valid: false,
                  error: 'Only .xlsx files are allowed.'
                };
              }
              
              return { valid: true };
            }
            
            // Add file input change handler and drag-and-drop functionality
            document.addEventListener('DOMContentLoaded', function() {
              const fileInput = document.getElementById('databaseFile');
              const uploadArea = document.querySelector('.upload-area');
              
              if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                  const file = e.target.files[0];
                  if (file) {
                    const validation = validateDatabaseFile(file);
                    if (!validation.valid) {
                      const uploadStatus = document.getElementById('uploadStatus');
                      uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${validation.error}</div>`;
                      fileInput.value = ''; // Clear the invalid file
                    } else {
                      const uploadStatus = document.getElementById('uploadStatus');
                      uploadStatus.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</div>`;
                    }
                  }
                });
              }
              
              // Add drag and drop functionality
              if (uploadArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                  uploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                  e.preventDefault();
                  e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                  uploadArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                  uploadArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight(e) {
                  uploadArea.classList.add('upload-area-highlight');
                }
                
                function unhighlight(e) {
                  uploadArea.classList.remove('upload-area-highlight');
                }
                
                uploadArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                  const dt = e.dataTransfer;
                  const files = dt.files;
                  
                  if (files.length > 0) {
                    const file = files[0];
                    fileInput.files = files;
                    
                    // Trigger change event
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                  }
                }
              }
            });
          </script>
  <style>
    /* Store Selection Styles */
    .store-selection-container {
      text-align: center;
      margin: 0 auto;
      max-width: 400px;
    }
    
    .store-label {
      display: inline-block;
      color: #e0e0e0;
      font-size: 0.9rem;
      font-weight: 500;
      margin-right: 0.5rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .current-store-display {
      color: #4ade80;
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .store-status {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #a0a0a0;
      min-height: 1.2rem;
    }
    
    .store-status.active {
      color: #4ade80;
    }
    
    .store-status.inactive {
      color: #f87171;
    }
    
    /* Store Selection Modal Styles */
    .store-options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .btn-store-option {
      background: linear-gradient(135deg, rgba(45, 34, 58, 0.9), rgba(60, 45, 75, 0.9));
      border: 2px solid rgba(160, 132, 232, 0.3);
      border-radius: 12px;
      color: #e0e0e0;
      padding: 1.5rem 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-store-option:hover {
      background: linear-gradient(135deg, rgba(45, 34, 58, 0.95), rgba(60, 45, 75, 0.95));
      border-color: rgba(160, 132, 232, 0.8);
      box-shadow: 0 4px 15px rgba(160, 132, 232, 0.3);
      transform: translateY(-2px);
      color: #ffffff;
    }
    
    .btn-store-option:active {
      transform: translateY(0);
    }
    
    .store-option-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }
    
    .store-name {
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
    }
    
    .store-location {
      font-size: 0.8rem;
      color: #a0a0a0;
      font-weight: 400;
    }

    /* Enhanced Product Database Manager Styles */
          .stats-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 0.5rem;
      }
      
      .stats-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        border-color: rgba(255, 255, 255, 0.5);
      }
      
      .stats-number {
        color: #2c3e50;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 1;
      }
      
      .stats-label {
        color: #34495e;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin: 0;
      }
    
    .database-modal .modal-content {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      
      /* Upload Area Styles */
      .upload-area {
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      .upload-area:hover {
        background-color: rgba(0, 123, 255, 0.05) !important;
        border-color: var(--primary-color) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
      }
      
      .upload-area-highlight {
        background-color: rgba(0, 123, 255, 0.1) !important;
        border-color: var(--success-color) !important;
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.25);
      }
      
      .upload-area .bi-cloud-upload {
        font-size: 3rem;
        color: var(--primary-color);
        transition: all 0.3s ease;
      }
      
      .upload-area:hover .bi-cloud-upload {
        transform: scale(1.1);
        color: var(--success-color);
      }
      
      /* Card Enhancements */
      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      }
      
      .card-header.bg-primary {
        background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
      }
      
      .card-header.bg-secondary {
        background: linear-gradient(135deg, var(--secondary-color), #545b62) !important;
      }
      
      /* Button Enhancements */
      .btn-modern {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        border: none;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
      }
      
      .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 123, 255, 0.4);
        background: linear-gradient(135deg, #0056b3, var(--primary-color));
      }
      
      .btn-outline-modern {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .btn-outline-modern:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }
      
      /* Form Switch Enhancements */
      .form-check-input:checked {
        background-color: var(--success-color);
        border-color: var(--success-color);
      }
      
      .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }
      
      /* Status Messages */
      #uploadStatus .alert {
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* Table Styling - Inverted Colors - FORCE WHITE TEXT */
      .table thead.bg-dark th {
        background-color: #212529 !important;
        color: white !important;
        border-color: #495057;
      }
      
      /* Force white text in table body - ALL SELECTORS */
      .table tbody tr,
      .table tbody tr td,
      .table tbody td,
      #vendorsTable tbody tr,
      #vendorsTable tbody td,
      #brandsTable tbody tr,
      #brandsTable tbody td {
        color: white !important;
      }
      
      .table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
      }
      
      /* Specific table styling */
      .table tbody td {
        color: white !important;
        border-color: #495057;
      }
      
      /* Force white text in specific tables */
      #vendorsTable tbody tr td,
      #brandsTable tbody tr td {
        color: white !important;
      }
      
      /* Product Type Compact Layout - TRULY HORIZONTAL & COMPACT - FORCE NO WRAP */
      .product-type-compact {
        display: flex !important;
        flex-wrap: nowrap !important;
        gap: 4px !important;
        max-height: 45px !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        padding: 4px !important;
        align-items: center !important;
        white-space: nowrap !important;
        flex-direction: row !important;
        width: max-content !important;
        min-width: 100% !important;
        flex-shrink: 0 !important;
        flex-basis: auto !important;
        /* Force horizontal layout with highest specificity */
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        flex-shrink: 0 !important;
        flex-basis: auto !important;
        /* Override any Bootstrap or conflicting CSS */
        display: -webkit-flex !important;
        display: -ms-flexbox !important;
        display: flex !important;
        -webkit-flex-wrap: nowrap !important;
        -ms-flex-wrap: nowrap !important;
        flex-wrap: nowrap !important;
      }
      
      /* Force container to not wrap */
      .product-type-compact * {
        flex-wrap: nowrap !important;
        white-space: nowrap !important;
      }
      
      /* Override any Bootstrap container styles that might interfere */
      .product-type-compact.container,
      .product-type-compact.row,
      .product-type-compact.col,
      .product-type-compact.col-12 {
        display: flex !important;
        flex-wrap: nowrap !important;
        flex-direction: row !important;
        width: max-content !important;
        max-width: none !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
      }
      
      /* Override Bootstrap card-body padding that's interfering */
      .card-body.p-1 {
        padding: 0.25rem !important;
      }
      
      .card-body.p-2 {
        padding: 0.5rem !important;
      }
      
      /* Force Product Type Distribution to be compact */
      .card-body .product-type-compact {
        max-height: 28px !important;
        padding: 2px !important;
        gap: 2px !important;
        flex-wrap: wrap !important;
        overflow-y: auto !important;
      }
      
      /* Ultra-aggressive override for Product Type Distribution */
      div[style*="product-type-compact"] {
        max-height: 28px !important;
        padding: 2px !important;
        gap: 2px !important;
        flex-wrap: wrap !important;
        overflow-y: auto !important;
        height: 28px !important;
        min-height: 28px !important;
      }
      
      /* Override any Bootstrap flexbox rules */
      .product-type-compact,
      div[class*="product-type-compact"] {
        display: flex !important;
        flex-wrap: wrap !important;
        max-height: 28px !important;
        height: 28px !important;
        min-height: 28px !important;
        padding: 2px !important;
        gap: 2px !important;
        overflow-y: auto !important;
        align-items: center !important;
      }
      
      /* Override Bootstrap badge styles */
      .product-type-compact .badge {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
        font-weight: 500 !important;
        color: white !important;
      }
      
      /* Ultra-compact Advanced Database Tools */
      .card-header.py-1 {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
      }
      
      .card-body.py-1 {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
      }
      
      .btn-sm.py-1 {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
        font-size: 0.8rem !important;
        line-height: 1.2 !important;
      }
      
      .product-type-badge {
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        padding: 3px 6px !important;
        background: #f8f9fa !important;
        border-radius: 12px !important;
        border: 1px solid #dee2e6 !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        min-width: fit-content !important;
      }
      
      .product-type-badge:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-1px);
      }
      
      .product-type-badge .badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        font-weight: 500;
      }
      
      .product-type-badge .badge.bg-info {
        background-color: #17a2b8 !important;
        color: white !important;
        /* Force white text with highest specificity */
        color: white !important;
        color: #ffffff !important;
        color: rgb(255, 255, 255) !important;
        color: rgba(255, 255, 255, 1) !important;
      }
      
      .product-type-badge .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
        /* Force white text with highest specificity */
        color: white !important;
        color: #ffffff !important;
        color: rgb(255, 255, 255) !important;
        color: rgba(255, 255, 255, 1) !important;
      }
      
      /* Product Type Distribution Grid Containment */
      .product-type-grid {
        max-height: 200px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding-right: 4px !important;
      }
      
      .product-type-item {
        min-height: 24px !important;
        max-height: 28px !important;
        overflow: hidden !important;
        flex-shrink: 0 !important;
      }
      
      .product-type-item .badge {
        max-width: 80px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      .product-type-item .text-white-50 {
        max-width: 100px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      /* Force all badges in product type section to have white text */
      .product-type-compact .badge {
        color: white !important;
        color: #ffffff !important;
        color: rgb(255, 255, 255) !important;
        color: rgba(255, 255, 255, 1) !important;
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .upload-area {
          min-height: 150px;
          padding: 2rem 1rem !important;
        }
        
        .upload-area .bi-cloud-upload {
          font-size: 2rem;
        }
        
        .btn-lg {
          padding: 0.5rem 1rem;
          font-size: 1rem;
        }
        
        .product-type-compact {
          max-height: 40px;
          gap: 3px;
          flex-wrap: nowrap;
          overflow-x: auto;
          overflow-y: hidden;
          padding: 3px;
        }
        
        .product-type-badge {
          padding: 2px 4px;
        }
        
        .product-type-badge .badge {
          font-size: 0.65rem;
          padding: 0.15rem 0.3rem;
        }
      }
      border: none;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }
    
    .database-modal .modal-header {
      background: linear-gradient(135deg, #495057 0%, #343a40 100%);
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px 20px 0 0;
    }
    
    .database-modal .modal-body {
      background: #ffffff;
      color: white !important;
    }
    
    .database-modal .card {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    .database-modal .card-header {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px 12px 0 0;
    }
    
    .database-modal .table {
      color: #95a5a6;
    }
    
    .database-modal .table thead th {
      background: #495057;
      color: white;
      border: none;
      font-weight: 600;
    }
    
    .database-modal .table tbody tr {
      color: #95a5a6;
    }
    
    .database-modal .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    /* Override for glass cards to ensure white text */
    .database-modal .glass-card .table,
    .database-modal .glass-card .table tbody tr,
    .database-modal .glass-card .table tbody td,
    .database-modal .glass-card .card-body {
      color: white !important;
    }
    
    /* Force white text in all glass card elements */
    .database-modal .glass-card * {
      color: white !important;
    }
    
    /* Make stats cards ultra-compact */
    .stats-card {
      padding: 0.25rem !important;
      min-height: auto !important;
    }
    
    .stats-number {
      font-size: 1.5rem !important;
      margin-bottom: 0.1rem !important;
      line-height: 1 !important;
    }
    
    .stats-label {
      font-size: 0.65rem !important;
      margin: 0 !important;
      line-height: 1 !important;
    }
    
    .stats-content {
      padding: 0.25rem !important;
    }
    
    .database-modal .glass-card {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    .database-modal .glass-card .card-header {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px 12px 0 0;
    }
    

    
    .database-modal .btn-modern {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border: none;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .database-modal .btn-modern:hover {
      background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .database-modal .btn-outline-modern {
      background: transparent;
      border: 2px solid #007bff;
      color: #007bff;
      border-radius: 8px;
      font-weight: 600;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .database-modal .btn-outline-modern:hover {
      background: #007bff;
      color: white;
      transform: translateY(-1px);
    }
    
    .database-modal .form-control {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .database-modal .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .database-modal .form-check-input:checked {
      background-color: #007bff;
      border-color: #007bff;
    }
    
    .database-modal .badge {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
    }
    
    .database-modal .badge.bg-info {
      background: #17a2b8 !important;
      color: white;
    }
    
    .database-modal .badge.bg-secondary {
      background: #6c757d !important;
      color: white;
    }

    /* Database Editor Modal Styles */
    #databaseEditorModal .modal-content {
      background: rgba(22, 33, 62, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 212, 170, 0.3);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 212, 170, 0.1);
    }

    #databaseEditorModal .modal-header {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 212, 170, 0.05));
      border-bottom: 1px solid rgba(0, 212, 170, 0.2);
      border-radius: 20px 20px 0 0;
    }

    #databaseEditorModal .modal-title {
      color: #ffffff;
      font-weight: 600;
    }

    #databaseEditorModal .table {
      color: #ffffff;
    }

    #databaseEditorModal .table thead th {
      background: rgba(0, 212, 170, 0.2);
      border: none;
      color: #ffffff;
      font-weight: 600;
    }

    #databaseEditorModal .table tbody tr {
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(0, 212, 170, 0.1);
      color: #ffffff;
    }

    #databaseEditorModal .table tbody tr:hover {
      background: rgba(0, 212, 170, 0.1);
      color: #ffffff;
    }

    #databaseEditorModal .table tbody td {
      color: #ffffff;
    }

    #databaseEditorModal .text-muted {
      color: rgba(255, 255, 255, 0.7) !important;
    }

    #databaseEditorModal .btn {
      border-radius: 8px;
      font-weight: 500;
    }

    #databaseEditorModal .btn-primary {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.8), rgba(0, 212, 170, 0.6));
      border: 1px solid rgba(0, 212, 170, 0.5);
      color: #ffffff;
    }

    #databaseEditorModal .btn-primary:hover {
      background: linear-gradient(135deg, rgba(0, 212, 170, 1), rgba(0, 212, 170, 0.8));
      border: 1px solid rgba(0, 212, 170, 0.7);
    }

    #databaseEditorModal .btn-success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.8), rgba(40, 167, 69, 0.6));
      border: 1px solid rgba(40, 167, 69, 0.5);
      color: #ffffff;
    }

    #databaseEditorModal .btn-danger {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(220, 53, 69, 0.6));
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: #ffffff;
    }

    #databaseEditorModal .form-control {
      background: rgba(22, 33, 62, 0.8);
      border: 1px solid rgba(0, 212, 170, 0.3);
      color: #ffffff;
    }

    #databaseEditorModal .form-control:focus {
      background: rgba(22, 33, 62, 0.9);
      border-color: rgba(0, 212, 170, 0.5);
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25);
      color: #ffffff;
    }

    #databaseEditorModal .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    #databaseEditorModal .input-group-text {
      background: rgba(0, 212, 170, 0.2);
      border: 1px solid rgba(0, 212, 170, 0.3);
      color: #ffffff;
    }

    #databaseEditorModal .btn-outline-primary {
      border: 1px solid rgba(0, 212, 170, 0.5);
      color: rgba(0, 212, 170, 0.9);
    }

    #databaseEditorModal .btn-outline-primary:hover {
      background: rgba(0, 212, 170, 0.2);
      border-color: rgba(0, 212, 170, 0.7);
      color: #ffffff;
    }

    #databaseEditorModal .btn-outline-danger {
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: rgba(220, 53, 69, 0.9);
    }

    #databaseEditorModal .btn-outline-danger:hover {
      background: rgba(220, 53, 69, 0.2);
      border-color: rgba(220, 53, 69, 0.7);
      color: #ffffff;
    }
    /* Enhanced Lineage Editor Styles */
                /* Strain Browser Styles */
            .strain-browser {
              display: flex;
              height: 75vh;
              max-height: 800px;
              background: #fff;
              border-radius: 8px;
              overflow: hidden;
              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            }
            
            .strain-browser-sidebar {
              width: 280px;
              background: #f8f9fa;
              border-right: 1px solid #e9ecef;
              padding: 1.5rem;
              overflow-y: auto;
            }
            
            .strain-browser-content {
              flex: 1;
              overflow-y: auto;
              background: #fff;
            }
            
            .filter-section {
              display: flex;
              flex-direction: column;
              gap: 1rem;
            }
            
            .filter-title {
              font-size: 0.875rem;
              font-weight: 600;
              color: #495057;
              margin-bottom: 0.5rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            
            .filter-options {
              display: flex;
              flex-direction: column;
              gap: 0.5rem;
              padding-left: 0.5rem;
            }
            
            .form-check-label {
              font-size: 0.875rem;
              color: #495057;
            }
            
            .stats-summary {
              margin-top: auto;
              padding-top: 1rem;
              border-top: 1px solid #e9ecef;
              display: flex;
              justify-content: space-between;
            }
            
            .stats-summary .stat-item {
              text-align: center;
            }
            
            .strain-table {
              margin: 0;
              border-collapse: separate;
              border-spacing: 0;
            }
            
            .strain-table thead {
              position: sticky;
              top: 0;
              background: #fff;
              z-index: 1;
            }
            
            .strain-table th {
              padding: 1rem;
              font-weight: 600;
              color: #495057;
              border-bottom: 2px solid #e9ecef;
            }
            
            .strain-row {
              transition: background-color 0.15s ease;
            }
            
            .strain-row:hover {
              background-color: #f8f9fa;
            }
            
            .strain-row td {
              padding: 0.75rem 1rem;
              vertical-align: middle;
              border-bottom: 1px solid #e9ecef;
            }
            
            .strain-name-cell {
              font-weight: 500;
              color: #212529;
            }
            
            .vendor-cell {
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            
            .btn-group {
              display: flex;
              gap: 0.5rem;
            }
            
            .form-select-sm {
              padding: 0.25rem 0.5rem;
              font-size: 0.875rem;
    }
    
    /* Make all form-select elements have darker backgrounds */
    .form-select {
      background: rgba(15, 23, 42, 0.9);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .form-select:focus {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(0, 212, 170, 0.6);
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25);
    }
    
    .form-select option {
      background: rgba(15, 23, 42, 0.95);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .form-select option:hover {
      background: rgba(30, 41, 59, 0.95);
            }
            
            .badge {
              font-size: 0.75rem;
              font-weight: 600;
              padding: 0.35rem 0.65rem;
              border-radius: 20px;
            }
            
            /* Custom scrollbar for sidebar and content */
            .strain-browser-sidebar::-webkit-scrollbar,
            .strain-browser-content::-webkit-scrollbar {
              width: 8px;
            }
            
            .strain-browser-sidebar::-webkit-scrollbar-track,
            .strain-browser-content::-webkit-scrollbar-track {
              background: #f1f1f1;
            }
            
            .strain-browser-sidebar::-webkit-scrollbar-thumb,
            .strain-browser-content::-webkit-scrollbar-thumb {
              background: #ccc;
              border-radius: 4px;
            }
            
            .strain-browser-sidebar::-webkit-scrollbar-thumb:hover,
            .strain-browser-content::-webkit-scrollbar-thumb:hover {
              background: #999;
            }
            
            .enhanced-lineage-editor {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .enhanced-lineage-editor .card {
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .enhanced-lineage-editor .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px 12px 0 0 !important;
      border: none;
    }
    
    .enhanced-lineage-editor .card-header h6 {
      margin: 0;
      font-weight: 600;
    }
    
    .enhanced-lineage-editor .form-control,
    .enhanced-lineage-editor .form-select {
      border-radius: 8px;
      border: 1px solid #e1e5e9;
      transition: all 0.3s ease;
      background: rgba(15, 23, 42, 0.9);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .enhanced-lineage-editor .form-control:focus,
    .enhanced-lineage-editor .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .enhanced-lineage-editor .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .enhanced-lineage-editor .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
    
    .enhanced-lineage-editor .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .enhanced-lineage-editor .btn-warning {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
      border: none;
      color: #2d3436;
    }
    
    .enhanced-lineage-editor .btn-warning:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 234, 167, 0.4);
    }
    
    .enhanced-lineage-editor .table {
      border-radius: 8px;
      overflow: hidden;
    }
    
    .enhanced-lineage-editor .table thead th {
      background: #f8f9fa;
      border: none;
      font-weight: 600;
      color: #2d3436;
      padding: 1rem;
    }
    
    .enhanced-lineage-editor .table tbody tr {
      transition: all 0.2s ease;
    }
    
    .enhanced-lineage-editor .table tbody tr:hover {
      background-color: rgba(102, 126, 234, 0.05);
    }
    
    .enhanced-lineage-editor .table tbody td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
    }
    
    .enhanced-lineage-editor .badge {
      font-size: 0.75em;
      padding: 0.375rem 0.5rem;
      border-radius: 6px;
    }
    
    .enhanced-lineage-editor .stat-item h4 {
      margin: 0;
      font-weight: 700;
    }
    
    .enhanced-lineage-editor .stat-item small {
      color: #6c757d;
      font-weight: 500;
    }
    
    .enhanced-lineage-editor .lineage-dropdown {
      min-width: 140px;
    }
    
    .enhanced-lineage-editor .alert {
      border-radius: 8px;
      border: none;
    }
    
    .enhanced-lineage-editor .spinner-border {
      color: #667eea;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .enhanced-lineage-editor .col-md-4,
      .enhanced-lineage-editor .col-md-8 {
        margin-bottom: 1rem;
      }
      
      .enhanced-lineage-editor .table-responsive {
        max-height: 400px;
      }
    }
    
    /* Custom scrollbar for table */
    .enhanced-lineage-editor .table-responsive::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .enhanced-lineage-editor .table-responsive::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .enhanced-lineage-editor .table-responsive::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }
    
    .enhanced-lineage-editor .table-responsive::-webkit-scrollbar-thumb:hover {
      background: #5a67d8;
    }

    /* Ensure content remains readable */
    .glass-card {
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Enhanced Lineage Editor Modal Styles */
    .glass-alert {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .form-control-modern,
    .form-select-modern {
      background: rgba(22, 33, 62, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .form-control-modern:focus,
    .form-select-modern:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 212, 170, 0.6);
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25);
      color: rgba(255, 255, 255, 1);
      outline: none;
    }
    
    .form-control-modern::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .form-select-modern option {
      background: rgba(15, 23, 42, 0.95);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .form-select-modern option:hover {
      background: rgba(30, 41, 59, 0.95);
    }
    
    .btn-glass {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      color: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }
    
    .btn-modern2 {
      background: linear-gradient(135deg, #00d4aa 0%, #0099cc 100%);
      border: none;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    
    .btn-modern2:hover {
      background: linear-gradient(135deg, #00b894 0%, #0077b3 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 212, 170, 0.4);
    }
    
    .btn-modern2:disabled {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Lineage Editor Modal Specific Styles */
    #lineageEditorModal .modal-content,
    #strainLineageEditorModal .modal-content,
    #quickLineageUpdateModal .modal-content {
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid rgba(0, 212, 170, 0.3);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(0, 212, 170, 0.1);
    }
    
    /* Ensure ALL form elements in lineage editor modals have proper styling */
    #unifiedLineageEditorModal .form-control,
    #unifiedLineageEditorModal .form-select {
      background: rgba(15, 23, 42, 0.9) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 8px !important;
    }
    
    /* Modern Tab Styling */
    .nav-tabs-modern {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .nav-tabs-modern .nav-link {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      padding: 0.75rem 1.5rem;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .nav-tabs-modern .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
      border: none;
    }
    
    .nav-tabs-modern .nav-link.active {
      background: rgba(0, 212, 170, 0.2);
      color: rgba(0, 212, 170, 1);
      border: none;
      border-bottom: 3px solid rgba(0, 212, 170, 0.8);
    }
    
    .nav-tabs-modern .nav-link i {
      margin-right: 0.5rem;
    }
    
    /* Search result item styling */
    .strain-result-item,
    .vendor-result-item,
    .product-result-item {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .strain-result-item:hover,
    .vendor-result-item:hover,
    .product-result-item:hover {
      background: rgba(0, 212, 170, 0.2) !important;
      border-color: rgba(0, 212, 170, 0.6) !important;
      transform: translateY(-1px);
    }
    
    .strain-result-item:active,
    .vendor-result-item:active,
    .product-result-item:active {
      transform: translateY(0);
    }
    
    #unifiedLineageEditorModal .form-control:focus,
    #unifiedLineageEditorModal .form-select:focus {
      background: rgba(15, 23, 42, 0.95) !important;
      border-color: rgba(0, 212, 170, 0.6) !important;
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25) !important;
      color: rgba(255, 255, 255, 1) !important;
    }
    
    #unifiedLineageEditorModal .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    #unifiedLineageEditorModal .form-select option {
      background: rgba(15, 23, 42, 0.95) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    #unifiedLineageEditorModal .form-select option:hover {
      background: rgba(30, 41, 59, 0.95) !important;
    }
    
    /* Lineage Editor Modal Form Styling */
    #lineageEditorModal .form-control,
    #lineageEditorModal .form-select,
    #lineageEditorModal input,
    #lineageEditorModal select {
      background: rgba(15, 23, 42, 0.9) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 8px !important;
    }
    
    #lineageEditorModal .form-control:focus,
    #lineageEditorModal .form-select:focus,
    #lineageEditorModal input:focus,
    #lineageEditorModal select:focus {
      background: rgba(15, 23, 42, 0.95) !important;
      border-color: rgba(0, 212, 170, 0.6) !important;
      box-shadow: 0 0 0 0.2rem rgba(0, 212, 170, 0.25) !important;
      color: rgba(255, 255, 255, 1) !important;
    }
    
    #lineageEditorModal .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    #lineageEditorModal .form-select option,
    #lineageEditorModal select option {
      background: rgba(15, 23, 42, 0.95) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    #lineageEditorModal .form-select option:hover,
    #lineageEditorModal select option:hover {
      background: rgba(30, 41, 59, 0.95) !important;
    }
    
    #lineageEditorModal .modal-header,
    #strainLineageEditorModal .modal-header,
    #quickLineageUpdateModal .modal-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    #lineageEditorModal .modal-footer,
    #strainLineageEditorModal .modal-footer,
    #quickLineageUpdateModal .modal-footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Form label enhancements */
    .form-label.fw-semibold {
      font-weight: 600 !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .text-white-50 {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    /* Icon colors for better visual hierarchy */
    .text-info {
      color: #17a2b8 !important;
    }
    
    .text-success {
      color: #28a745 !important;
    }
    
    .text-warning {
      color: #ffc107 !important;
    }
    
    .text-primary {
      color: #007bff !important;
    }
    
    /* Loading spinner enhancements */
    .spinner-border.text-primary {
      color: #00d4aa !important;
    }
    
    /* Form text helper */
    .form-text {
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    /* Hide conflicting background elements */
    .animated-bg, .orb {
      display: none !important;
    }
    
    /* Fallback morphing background */
    .morphing-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      transition: background 2s ease;
    }
    .sticky-filter-bar .form-label {
      margin-bottom: 2px !important;
      margin-top: 2px !important;
    }
    .sticky-filter-bar select.form-select-sm {
      margin-bottom: 2px !important;
      margin-top: 0 !important;
    }
    .sticky-filter-bar > div {
      margin-bottom: 2px !important;
      margin-top: 0 !important;
      padding: 0 !important;
    }

    /* Application Loading Splash Screen */
    .app-loading-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease-out;
    }

    .app-loading-splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .app-loading-container {
      position: relative;
      width: 600px;
      height: 400px;
      border-radius: 24px;
      overflow: hidden;
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid rgba(0, 212, 170, 0.2);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(0, 212, 170, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      transform: translateX(0);
    }

    .app-loading-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      color: white;
      text-align: center;
    }

    .app-loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #00d4aa, #0099cc);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 
        0 15px 35px rgba(0, 212, 170, 0.3),
        0 0 0 1px rgba(0, 212, 170, 0.2);
      animation: logo-float 3s ease-in-out infinite;
      margin-bottom: 30px;
    }

    @keyframes logo-float {
      0%, 100% { 
        transform: translateY(0px) scale(1);
      }
      50% { 
        transform: translateY(-8px) scale(1.02);
      }
    }

    .app-loading-title {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #00d4aa, #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
      text-shadow: 
        0 2px 8px rgba(0,0,0,0.4),
        0 4px 16px rgba(0,0,0,0.3),
        0 1px 2px rgba(160,132,232,0.3),
        0 0 20px rgba(160,132,232,0.2);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }

    .app-loading-subtitle {
      font-size: 18px;
      font-weight: 600;
      opacity: 1;
      margin-bottom: 40px;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow: 
        0 2px 6px rgba(0,0,0,0.4),
        0 3px 12px rgba(0,0,0,0.3),
        0 1px 2px rgba(139,92,246,0.3),
        0 0 15px rgba(139,92,246,0.2);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .app-loading-progress {
      width: 100%;
      max-width: 400px;
      margin-bottom: 30px;
    }

    .app-loading-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
    }

    .app-loading-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d4aa, #0099cc, #00d4aa);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }

    .app-loading-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .app-loading-text {
      font-size: 16px;
      font-weight: 500;
      opacity: 0.8;
      margin-bottom: 25px;
      transition: opacity 0.3s ease;
      min-height: 24px;
    }

    .app-loading-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .app-loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(0, 212, 170, 0.6);
      animation: dot-pulse 1.6s ease-in-out infinite both;
    }
    .app-loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .app-loading-dot:nth-child(2) { animation-delay: -0.16s; }
    .app-loading-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes dot-pulse {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.4;
      }
      40% {
        transform: scale(1.2);
        opacity: 1;
      }
    }

    .app-loading-status {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 212, 170, 0.15);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 212, 170, 0.2);
      color: #00d4aa;
    }

    .app-loading-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #00d4aa;
      animation: status-pulse 2s ease-in-out infinite;
    }

    @keyframes status-pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .app-loading-version {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 212, 170, 0.15);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 212, 170, 0.2);
      color: #00d4aa;
    }

    /* Responsive design for app loading */
    @media (max-width: 1200px) {
      .app-loading-container {
        transform: translateX(0);
        width: 90vw;
        max-width: 600px;
      }
    }

    @media (max-width: 900px) {
      .app-loading-container {
        transform: translateX(0);
        width: 90vw;
        max-width: 500px;
      }
    }

    /* Action Splash Screen */
    .action-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease-out;
    }

    /* Center the splash over the main content area */
    .action-splash::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      pointer-events: none;
    }

    .action-splash-content {
      position: relative;
      z-index: 10000;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s ease-out;
      /* Center the splash content */
      transform: none;
      margin: 0 auto;
    }

    .action-splash-message {
      color: #ffffff;
      font-size: 18px;
      font-weight: 500;
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Hide main content while loading */
    .main-content {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    .main-content.loaded {
      opacity: 1;
    }

    /* Sparkle animation for special thanks */
    @keyframes sparkle {
      0%, 100% { 
        transform: scale(1) rotate(0deg); 
        opacity: 1;
      }
      50% { 
        transform: scale(1.2) rotate(180deg); 
        opacity: 0.8;
      }
    }


  </style>
</head>
<body>
  <!-- Application Loading Splash Screen -->
  <div id="appLoadingSplash" class="app-loading-splash">
    <div class="app-loading-container">
      <div class="app-loading-content">
        <div class="app-loading-logo">🏷️</div>
        
        <h1 class="app-loading-title">AGT DESIGNER</h1>
        <p class="app-loading-subtitle">Auto-Generating Tag Designer</p>
        
        <div class="app-loading-progress">
          <div class="app-loading-bar">
            <div class="app-loading-fill" id="appLoadingFill"></div>
          </div>
        </div>
        <div class="app-loading-text" id="appLoadingText">Initializing application...</div>
        
        <div class="app-loading-dots">
          <div class="app-loading-dot"></div>
          <div class="app-loading-dot"></div>
          <div class="app-loading-dot"></div>
        </div>
      </div>
      
      <div class="app-loading-status">
        <div class="app-loading-status-dot"></div>
        <span id="appLoadingStatus">Initializing</span>
      </div>
      <div class="app-loading-version">v2.0.0</div>
    </div>
  </div>

  <!-- Main Content (initially hidden) -->
  <div class="main-content" id="mainContent">
    <canvas id="lava-lamp-canvas" style="position:fixed;top:0;left:0;z-index:0;pointer-events:none;"></canvas>
    <!-- Psychedelic Background Effects -->
    <div class="psychedelic-orbs">
      <div class="orb"></div>
      <div class="orb"></div>
      <div class="orb"></div>
      <div class="orb"></div>
      <div class="orb"></div>
    </div>
    
    <div class="psychedelic-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>

    <!-- Excel Loading Splash Screen -->
    <div id="excelLoadingSplash" class="excel-loading-splash" style="display: none;">
      <div class="excel-loading-container">
        <div class="excel-loading-content">
          <div class="excel-loading-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <polyline points="9 9 15 9 15 15 9 15 9 9"></polyline>
            </svg>
          </div>
          <h3 class="excel-loading-title">Processing Excel File</h3>
          <p class="excel-loading-subtitle" id="excelLoadingFilename">Processing...</p>
          <div class="excel-loading-status" id="excelLoadingStatus">Processing...</div>
          <div class="excel-loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>

    <div class="w-100 py-2" style="z-index:1; position:relative;">
      <!-- Title and Subtitle centered above tag panels -->

      <div class="centerframe" style="width:100%; margin:0 auto; text-align:center; position:relative;">
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 1rem;">
          <div style="text-align: center; background: rgba(45, 34, 58, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 2px solid rgba(160, 132, 232, 0.3); border-radius: 18px; padding: 2rem; box-shadow: 0 4px 24px rgba(80, 40, 160, 0.18); max-width: 600px;">
            <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
              <h1 class="vibrant-title mb-0" data-text="AGT Designer">
                AGT Designer
              </h1>
            </div>
            <p class="vibrant-subtitle">
              <span class="larger-letter">A</span>uto-<span class="larger-letter">G</span>enerating <span class="larger-letter">T</span>ag Designer
            </p>
            <p class="copyright-text">
              ©2025 Created by Adam Cordova for A Greener Today
            </p>

            <!-- Store Selection -->
            <div class="store-selection-container mt-3 mb-3 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <span class="store-label">Store:</span>
                <span class="current-store-display" id="currentStoreDisplay">No store selected</span>
                <button class="btn btn-sm btn-outline-primary" onclick="showStoreSelectionModal()" title="Change store">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Change
                </button>
              </div>
              <button class="big-glow-help-btn p-0" id="help-btn" title="Click for help with downloading LOTs data and using the application" data-bs-toggle="modal" data-bs-target="#helpModal">
                <span style="font-size: 16px; font-weight: bold; color: white;">?</span>
              </button>
            </div>
            <div class="store-status text-center" id="storeStatus"></div>

            <!-- IMMEDIATE STORE SETTING SCRIPT -->
            <script>
              // Set Bothell as default store IMMEDIATELY after elements are created
              (function() {
                console.log('INLINE: Setting Bothell as default store immediately...');
                const displayElement = document.getElementById('currentStoreDisplay');
                const statusElement = document.getElementById('storeStatus');
                
                if (displayElement) {
                  displayElement.textContent = 'AGT Bothell';
                  displayElement.style.color = '#4ade80';
                  console.log('INLINE: Set display to AGT Bothell');
                }
                
                if (statusElement) {
                  statusElement.textContent = 'Store: AGT Bothell';
                  statusElement.className = 'store-status active';
                  console.log('INLINE: Set status to AGT Bothell');
                }
                
                // Also set localStorage
                localStorage.setItem('selectedStore', 'AGT_Bothell');
              })();
            </script>

            <!-- Database and Lineage Management Buttons -->
            <div class="header-buttons-container mt-3 d-flex justify-content-center gap-3">
              <button class="btn btn-header-action" onclick="showProductDatabaseManager()" title="Open Data & Analytics">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <path d="M12 8v8"></path>
                  <path d="M8 12h8"></path>
                </svg>
                Data & Analytics
              </button>
              <button class="btn btn-header-action" onclick="showDatabaseEditor()" title="Open Edit DB">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit DB
              </button>
              <button class="btn btn-header-action" onclick="openLineageEditor()" title="Open lineage editor for strain management">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                  <path d="M2 17l10 5 10-5"></path>
                  <path d="M2 12l10 5 10-5"></path>
                </svg>
                Lineage Editor
              </button>
              <button class="btn btn-header-action" data-bs-toggle="modal" data-bs-target="#jsonMatchModal" title="Match products from JSON URL">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Match JSON
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="w-100">
        <!-- Upload bar positioned above filter column -->
        <div class="row mb-1 mt-0 fade-in" style="animation-delay: 0.2s;">
          <div class="col-lg-2 mb-1">
            <div class="modern-upload-bar" style="display: inline-flex; align-items: center; min-height: 28px; padding: 0.25rem 0.5rem; border-radius: 10px; background: rgba(45,34,58,0.85);">
              <button type="button" class="upload-btn-modern d-flex align-items-center justify-content-center" onclick="console.log('Upload button clicked'); document.getElementById('fileInput').click();" aria-label="Upload Excel file" style="padding:0.15rem 0.6rem; font-size:0.82rem;">
                <svg class="me-2" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span class="fw-bold">Upload</span>
              </button>
              <input type="file" id="fileInput" accept=".xlsx" style="display:none;" onchange="console.log('File input changed:', this.files[0]);">
              <span class="file-info-modern d-flex align-items-center gap-1 ms-2" id="currentFileInfo" style="min-width:200px; max-width:none; font-size:0.82rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <polyline points="9 9 15 9 15 15 9 15 9 9"></polyline>
                </svg>
                <span class="file-info-text" id="fileInfoText" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">No file selected</span>
              </span>
              <!-- Auto check functionality removed -->
              <button class="btn btn-sm btn-outline-warning ms-2" onclick="clearStuckUploads()" title="Clear stuck uploads" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </button>
              <button class="btn btn-sm btn-outline-danger ms-1" onclick="emergencyLineageModalCleanup()" title="Emergency cleanup for stuck lineage editor" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                  <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
              <!-- Manual auto upload trigger button removed -->
            </div>
          </div>
        </div>

        <!-- Tag-list containers row (now includes filter bar for alignment) -->
        <div class="row fade-in g-1" style="animation-delay: 0.4s; display: flex; justify-content: space-between;">
          <!-- Filter Bar as a column -->
          <div class="mb-1" data-container-type="filter" style="flex: 1; margin-right: 0.5rem;">
              <div class="sticky-filter-bar d-flex flex-row align-items-center justify-content-between" style="height: auto; width: 100%; border-radius: 24px; padding: 1.5rem; margin: 0;">
                                              <div class="d-flex flex-row gap-3" style="height: 100%; align-items: center;">
                  <!-- Clear Filters Button -->
                  <div class="mt-3">
                    <button id="clearFiltersBtn" class="btn btn-sm w-100" onclick="TagManager.clearAllFilters()" title="Clear all filters" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(220, 53, 69, 0.6)); border: 1.5px solid rgba(220, 53, 69, 0.8); color: #fff; border-radius: 8px; font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.6rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                      Clear Filters
                    </button>
                  </div>
                  <div>
                    <label for="vendorFilter" class="filter-category-label mb-0">VENDOR</label>
                    <select id="vendorFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by vendor" style="width: 100%;">
                      <option value="All">All Vendors</option>
                    </select>
                  </div>
                  <div>
                    <label for="brandFilter" class="filter-category-label mb-0">BRAND</label>
                    <select id="brandFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by brand" style="width: 100%;">
                      <option value="All">All Brands</option>
                    </select>
                  </div>
                  <div>
                    <label for="productTypeFilter" class="filter-category-label mb-0">PRODUCT TYPE</label>
                    <select id="productTypeFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by product type" style="width: 100%;">
                      <option value="All">All Product Types</option>
                    </select>
                  </div>
                  <div>
                    <label for="lineageFilter" class="filter-category-label mb-0">LINEAGE</label>
                    <select id="lineageFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by lineage" style="width: 100%;">
                      <option value="All">All Lineages</option>
                    </select>
                  </div>
                  <div>
                    <label for="weightFilter" class="filter-category-label mb-0">WEIGHT</label>
                    <select id="weightFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by weight" style="width: 100%;">
                      <option value="All">All Weights</option>
                    </select>
                  </div>
                  <div>
                    <label for="dohFilter" class="filter-category-label mb-0">DOH COMPLIANCE</label>
                    <select id="dohFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by DOH compliance" style="width: 100%;">
                      <option value="All">All Products</option>
                      <option value="Yes">DOH Compliant (Yes)</option>
                      <option value="No">Not DOH Compliant (No)</option>
                      <option value="Pending">DOH Status Pending</option>
                      <option value="Unknown">DOH Status Unknown</option>
                    </select>
                  </div>
                  <div>
                    <label for="highCbdFilter" class="filter-category-label mb-0">HIGH CBD</label>
                    <select id="highCbdFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by High CBD products" style="background: #2a2040; color: #fff; border-radius: 8px; border: 1.5px solid #a084e8; width: 100%;">
                      <option value="All">All Products</option>
                    </select>
                  </div>
              </div>
            </div>
          </div>
          <!-- Available Tags -->
          <div class="mb-1" data-container-type="available" style="flex: 1; margin-right: 0.5rem;">
            <div class="glass-card d-flex flex-column">
              <div class="card-header border-0 bg-transparent p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="filter-label mb-0">CURRENT INVENTORY</h5>
                </div>
                <div class="search-input-container">
                  <input type="text" id="availableTagsSearch" class="form-control form-control-modern" placeholder="Search available tags...">
                </div>
              </div>
              <div class="card-body p-2 pt-0 d-flex flex-column flex-grow-1">
                <div id="availableTags" class="tag-list-container">
                  <div class="tag-list">
                    <div class="d-flex align-items-center gap-3 mb-2">
                      <label class="d-flex align-items-center gap-2 cursor-pointer mb-0 select-all-container">
                        <input type="checkbox" id="selectAllAvailable" class="custom-checkbox">
                        <span class="filter-subcategory-label mb-0">SELECT ALL</span>
                      </label>
                    </div>
                    
                    <!-- Instructional blurb for dropdown usage -->
                    <div id="dropdownInstructionBlurb" class="dropdown-instruction-blurb mb-3">
                      <div class="instruction-content">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="instruction-icon">
                          <path d="M7 10l5 5 5-5z"/>
                        </svg>
                        <span class="instruction-text">Click the dropdown arrows (▶) to reveal products in each category</span>
                      </div>
                    </div>
                    
                    <div class="tag-entry">Loading Tags...</div>
                   
                    <!-- more tags -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Center Column with Controls -->
          <div class="mb-1 mt-0 d-flex flex-column justify-content-start align-items-center" style="flex: 1; margin-right: 0.5rem; padding-top: 0; margin-top: 0; padding-left: 0.25rem; padding-right: 0.25rem;" data-container-type="center">
            <!-- Controls -->
            <div class="control-panel">
              <!-- Controls Header -->
              <div class="d-flex flex-column w-100">
                <label class="filter-label">Template</label>
                <select id="templateSelect" class="form-select form-select-modern" aria-label="Template">
                  <option value="horizontal">Horizontal</option>
                  <option value="vertical">Vertical</option>
                  <option value="mini">Mini</option>
                  <option value="double">Double</option>
                  <option value="inventory">Inventory</option>
                </select>

                <button id="generateBtn" class="btn-modern2" title="Generate labels based on selected tags" onclick="TagManager.debouncedGenerate()">
                  Generate Tags
                </button>

                <select id="fontSelect" class="d-none" aria-label="Font">
                  <option value="Arial">Arial</option>
                  <option value="Helvetica">Helvetica</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                  <option value="Courier New">Courier New</option>
                  <option value="Impact">Impact</option>
                  <option value="Comic Sans MS">Comic Sans MS</option>
                </select>
              </div>
              <!-- Controls Section -->
              <div class="mb-3">
                <label class="filter-label">Controls</label>
                <div class="d-grid gap-2 w-100">
                  <button id="undo-move-btn" class="btn btn-glass btn-sm" title="Undo last move">
                  <span class="icon-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="1 4 1 10 7 10"></polyline>
                      <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    Undo
                  </span>
                </button>
                <button id="clear-filters-btn" class="btn btn-glass btn-sm" title="Clear selected tags">
                  <span class="icon-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear
                  </span>
                </button>
                <button class="btn btn-glass btn-sm" onclick="TagManager.downloadExcel()" title="Download selected tags as Excel file">
                  <span class="icon-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Data
                  </span>
                </button>
                  <button class="btn btn-glass btn-sm" data-bs-toggle="modal" data-bs-target="#editTemplateModal" title="Edit template settings">
                    <span class="icon-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                      Edit Template
                    </span>
                  </button>
                </div>
              </div>

              <!-- JSON Tools -->
              <div class="mb-3">
                <label class="filter-label">JSON Tools</label>
                <div class="d-grid gap-2">
                  <button class="btn btn-glass btn-sm" data-bs-toggle="modal" data-bs-target="#jsonInventoryModal" title="Generate inventory slips from JSON">
                    <span class="icon-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                      </svg>
                      JSON Inventory
                    </span>
                  </button>
                  <button class="btn btn-glass btn-sm" onclick="openManualProductModal()" title="Manually add a new product">
                    <span class="icon-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                      </svg>
                      Add Product
                    </span>
                  </button>
                  <button class="btn btn-glass btn-sm" onclick="clearJsonMatches()" title="Clear JSON matches">
                    <span class="icon-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                      Clear JSON
                    </span>
                  </button>
                  <button class="btn btn-glass btn-sm" id="jsonFilterToggleBtn" onclick="toggleJsonFilter()" title="Toggle between JSON matched items and full Excel list" style="display: none;">
                    <span class="icon-btn">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"></path>
                        <path d="M7 12h14"></path>
                        <path d="M11 18h10"></path>
                      </svg>
                      <span id="jsonFilterToggleText">Toggle Filter</span>
                    </span>
                  </button>
                </div>
              </div>


            </div>
          </div>
          
          <!-- Selected Tags -->
          <div class="mb-2" data-container-type="selected" style="flex: 1; margin-right: 0.5rem;">
            <div class="glass-card d-flex flex-column">
              <div class="card-header border-0 bg-transparent p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="filter-label mb-0">SELECTED TAGS</h5>
                  <span class="badge badge-modern" id="selectedTagsCount">(0)</span>
                </div>
                <div class="search-input-container">
                  <input type="text" id="selectedTagsSearch" class="form-control form-control-modern" placeholder="Search selected tags...">
                </div>
              </div>
              <div class="card-body p-2 pt-0 d-flex flex-column flex-grow-1">
                <div id="selectedTags" class="tag-list-container">
                  <div class="tag-list">
                    <!-- more tags -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="errorToast" class="toast toast-modern" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close toast"></button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="spinnerOverlay">
    <div class="spinner-modern"></div>
  </div>

  <!-- Hidden inputs -->
  <input type="hidden" id="current-filepath" value="{{ initial_data.filepath if initial_data else '' }}">
  <div id="initialData" data-initial='{{ initial_data|tojson if initial_data else "{}" }}'></div>

  <!-- Modals -->
  
  <!-- Store Selection Modal -->
  <div class="modal fade" id="storeSelectionModal" tabindex="-1" aria-labelledby="storeSelectionModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="storeSelectionModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-primary">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Select Your Store
          </h5>
        </div>
        <div class="modal-body text-center">
          <p class="mb-4 text-light">Please select your store location to continue. This selection will be saved and remembered for future visits.</p>
          
          <div class="store-options-grid">
            <button class="btn btn-store-option" onclick="selectStore('AGT_Bothell')">
              <div class="store-option-content">
                <div class="store-name">AGT Bothell</div>
                <div class="store-location">Bothell, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Burien')">
              <div class="store-option-content">
                <div class="store-name">AGT Burien</div>
                <div class="store-location">Burien, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Goldbar')">
              <div class="store-option-content">
                <div class="store-name">AGT Goldbar</div>
                <div class="store-location">Goldbar, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Lynnwood')">
              <div class="store-option-content">
                <div class="store-name">AGT Lynnwood</div>
                <div class="store-location">Lynnwood, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Shoreline')">
              <div class="store-option-content">
                <div class="store-name">AGT Shoreline</div>
                <div class="store-location">Shoreline, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Seattle')">
              <div class="store-option-content">
                <div class="store-name">AGT Seattle</div>
                <div class="store-location">Seattle, WA</div>
              </div>
            </button>
            
            <button class="btn btn-store-option" onclick="selectStore('AGT_Walla_Walla')">
              <div class="store-option-content">
                <div class="store-name">AGT Walla Walla</div>
                <div class="store-location">Walla Walla, WA</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel">
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="helpModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Help & Instructions
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close help modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-info mb-3">📥 How to Download LOTs Data</h6>
              <ol class="mb-0">
                <li class="mb-2">Log in to <a href="https://app.posabit.com/" target="_blank" rel="noopener" class="text-info">app.posabit.com</a></li>
                <li class="mb-2">Navigate to <strong>Inventory</strong> → <strong>LOTs</strong></li>
                <li class="mb-2">Set "Select State" to <strong>Active</strong></li>
                <li class="mb-2">Click the green <strong>Search</strong> button</li>
                <li class="mb-2">Click the blue <strong>Download CSV</strong> button</li>
                <li class="mb-2">Upload the downloaded file here using the "Upload Data" button</li>
              </ol>
            </div>
            <div class="col-md-6">
              <h6 class="text-info mb-3">🎯 Key Features</h6>
              <ul class="mb-0">
                <li class="mb-2"><strong>Smart Filtering:</strong> Filter by vendor, brand, type, lineage, and weight</li>
                <li class="mb-2"><strong>Tag Management:</strong> Move tags between available and selected panels</li>
                <li class="mb-2"><strong>Multiple Templates:</strong> Choose from Horizontal, Vertical, Mini, and Inventory layouts</li>
                <li class="mb-2"><strong>Customizable Scale:</strong> Adjust label size for different printer requirements</li>
                <li class="mb-2"><strong>Lineage Control:</strong> Modify tag colors based on cannabis lineage</li>
                <li class="mb-2"><strong>Batch Generation:</strong> Create multiple labels at once</li>
              </ul>
            </div>
          </div>
          
          <div class="mt-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 8px;">
            <h6 class="text-warning mb-2">💡 Pro Tips & Best Practices</h6>
            <div class="row">
              <div class="col-md-6">
                <ul class="mb-0 small">
                  <li>Use search boxes to quickly find specific tags</li>
                  <li>"Select All" checkboxes work for entire categories</li>
                  <li>Tags auto-organize by vendor, brand, and product type</li>
                  <li>Use the Undo button to reverse your last action</li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul class="mb-0 small">
                  <li>Different templates work best for different label sizes</li>
                  <li>Export data to Excel for external record keeping</li>
                  <li>Use the Edit Template button for advanced customization</li>
                  <li>Clear filters to see all available tags</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="mt-4 p-3" style="background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea;">
            <h6 class="text-info mb-2">🔧 Quick Actions Guide</h6>
            <div class="row">
              <div class="col-md-4">
                <strong>Upload:</strong> Click "Upload Data" to load your LOTs CSV file
              </div>
              <div class="col-md-4">
                <strong>Filter:</strong> Use dropdowns to narrow down available tags
              </div>
              <div class="col-md-4">
                <strong>Select:</strong> Check tags and use arrow buttons to move them
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-4">
                <strong>Template:</strong> Choose the best layout for your labels
              </div>
              <div class="col-md-4">
                <strong>Generate:</strong> Click "Generate Tags" to create your labels
              </div>
              <div class="col-md-4">
                <strong>Export:</strong> Download selected data as Excel file
              </div>
            </div>
          </div>
          

          
          <div class="mt-4 p-3" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.15)); border-radius: 8px; border-left: 4px solid #ffc107; border-right: 4px solid #ff9800; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);">
            <h6 class="text-warning mb-3" style="text-align: center; font-size: 1.1rem;">
              <span style="font-size: 1.3rem; animation: sparkle 2s ease-in-out infinite;">🌟</span> Special Thanks <span style="font-size: 1.3rem; animation: sparkle 2s ease-in-out infinite 1s;">🌟</span>
            </h6>
            <div class="text-center mb-3">
              
            </div>
            <div class="row text-center">
              <div class="col-md-6">
                <div class="mb-2">
                  <strong style="color: #ffc107;">Taylor Rowland</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Donna Wilner</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Madison Ostman</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Brett Hulet</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">James Van Dyke</strong>
             
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Hema Lee</strong>
             
                </div>
              </div>
              <div class="col-md-6">
        
                <div class="mb-2">
                  <strong style="color: #ffc107;">Jason Ruiz</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Chris Campagnano</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Sean Puigmire</strong>
                  
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Brie Dyson</strong>
                
                </div>
                <div class="mb-2">
                  <strong style="color: #ffc107;">Jared Dyson</strong>
                
                </div>
              </div>
            </div>
            <div class="text-center mt-3">
              <p class="mb-0" style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); font-style: italic;">
                Thank you to the following individuals for their input and testing of this application!
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Got it!</button>
          <button type="button" class="btn btn-outline-light" onclick="closeHelpModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fix Lineage Modal -->
  <div class="modal fade" id="fixLineageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);">
        <div class="modal-header border-0">
          <h5 class="modal-title">Fix Lineage</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close fix lineage modal"></button>
        </div>
        <div class="modal-body">
          <label class="filter-label">Select New Lineage</label>
          <select class="form-select form-select-sm lineage-dropdown lineage-dropdown-mini" id="editLineageSelect" aria-label="Select lineage">
            <option value="SATIVA">S</option>
            <option value="INDICA">I</option>
            <option value="HYBRID">H</option>
            <option value="HYBRID/SATIVA">H/S</option>
            <option value="HYBRID/INDICA">H/I</option>
            <option value="CBD">CBD</option>
            <option value="MIXED">THC</option>
            <option value="PARA">P</option>
          </select>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" title="Close modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveLineageBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Template Modal -->
  <div class="modal fade" id="editTemplateModal" tabindex="-1" aria-labelledby="editTemplateModalLabel">
    <div class="modal-dialog">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="editTemplateModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit Template Settings
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close edit template modal"></button>
        </div>
        <div class="modal-body">
          <!-- Template Type Selection -->
          <div class="mb-4">
            <label class="filter-label">Template Type</label>
            <select id="templateSelectModal" class="form-select form-select-modern" aria-label="Template">
              <option value="horizontal">Horizontal</option>
              <option value="vertical">Vertical</option>
              <option value="mini">Mini</option>
              <option value="double">Double</option>
              <option value="inventory">Inventory</option>
            </select>
          </div>
          
          <!-- Font Settings -->
          <div class="mb-4">
            <label class="filter-label">Font Family</label>
            <select id="fontSelectModal" class="form-select form-select-modern" aria-label="Font">
              <option value="Arial">Arial</option>
              <option value="Helvetica">Helvetica</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Georgia">Georgia</option>
              <option value="Verdana">Verdana</option>
              <option value="Courier New">Courier New</option>
              <option value="Impact">Impact</option>
              <option value="Comic Sans MS">Comic Sans MS</option>
              <option value="Calibri">Calibri</option>
              <option value="Cambria">Cambria</option>
              <option value="Candara">Candara</option>
              <option value="Consolas">Consolas</option>
              <option value="Constantia">Constantia</option>
              <option value="Corbel">Corbel</option>
              <option value="Franklin Gothic">Franklin Gothic</option>
              <option value="Garamond">Garamond</option>
              <option value="Lucida Console">Lucida Console</option>
              <option value="Palatino">Palatino</option>
              <option value="Tahoma">Tahoma</option>
              <option value="Trebuchet MS">Trebuchet MS</option>
            </select>
          </div>
          
          <!-- Scale Factor -->
          <div class="mb-4">
            <label class="filter-label">Scale Factor</label>
            <input type="number" id="scaleInputModal" class="form-control form-control-modern" 
                   value="1.0" min="0.5" max="2.0" step="0.1" aria-label="Scale">
            <div class="form-text">Adjust the scale factor for label sizing (0.5x to 2.0x)</div>
          </div>
          
          <!-- Font Sizing Configuration -->
          <div class="mb-4">
            <label class="filter-label">Font Sizing Mode</label>
            <select id="fontSizingModeModal" class="form-select form-select-modern" aria-label="Font Sizing Mode">
              <option value="auto">Auto (Dynamic)</option>
              <option value="fixed">Fixed Sizes</option>
              <option value="custom">Custom Thresholds</option>
            </select>
            <div class="form-text">Choose how font sizes are calculated</div>
          </div>
          
          <!-- Field-Specific Font Sizes -->
          <div class="mb-4" id="fieldFontSizesSection" style="display: none;">
            <label class="filter-label">Field-Specific Font Sizes</label>
            <div class="row">
              <div class="col-6">
                <label class="form-label small">Description</label>
                <input type="number" id="descriptionFontSize" class="form-control" value="16" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
              <div class="col-6">
                <label class="form-label small">Brand</label>
                <input type="number" id="brandFontSize" class="form-control" value="14" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <label class="form-label small">Price</label>
                <input type="number" id="priceFontSize" class="form-control" value="18" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
              <div class="col-6">
                <label class="form-label small">Lineage</label>
                <input type="number" id="lineageFontSize" class="form-control" value="12" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <label class="form-label small">Ratio/THC-CBD</label>
                <input type="number" id="ratioFontSize" class="form-control" value="10" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
              <div class="col-6">
                <label class="form-label small">Vendor</label>
                <input type="number" id="vendorFontSize" class="form-control" value="8" min="6" max="48" style="min-width: 80px; width: 100%;">
              </div>
            </div>
          </div>
          
          <!-- Layout Options -->
          <div class="mb-4">
            <label class="filter-label">Layout Options</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableLineBreaksModal" checked>
              <label class="form-check-label" for="enableLineBreaksModal">
                Enable automatic line breaks
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableTextWrappingModal" checked>
              <label class="form-check-label" for="enableTextWrappingModal">
                Enable text wrapping
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableBoldTextModal">
              <label class="form-check-label" for="enableBoldTextModal">
                Use bold text for headers
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableItalicTextModal">
              <label class="form-check-label" for="enableItalicTextModal">
                Use italic text for descriptions
              </label>
            </div>
          </div>
          
          <!-- Spacing Options -->
          <div class="mb-4">
            <label class="filter-label">Spacing Options</label>
            <div class="row">
              <div class="col-6">
                <label class="form-label small">Line Spacing</label>
                <select id="lineSpacingModal" class="form-select" style="min-width: 120px; width: 100%;">
                  <option value="1.0">Single (1.0)</option>
                  <option value="1.15">1.15</option>
                  <option value="1.5">1.5</option>
                  <option value="2.0">Double (2.0)</option>
                  <option value="2.5">2.5</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label small">Paragraph Spacing</label>
                <select id="paragraphSpacingModal" class="form-select" style="min-width: 120px; width: 100%;">
                  <option value="0">None (0pt)</option>
                  <option value="6">6pt</option>
                  <option value="12">12pt</option>
                  <option value="18">18pt</option>
                  <option value="24">24pt</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Color Options -->
          <div class="mb-4">
            <label class="filter-label">Color Options</label>
            <div class="row">
              <div class="col-6">
                <label class="form-label small">Text Color</label>
                <input type="color" id="textColorModal" class="form-control" value="#000000" style="min-width: 80px; width: 100%; height: 40px;">
              </div>
              <div class="col-6">
                <label class="form-label small">Background Color</label>
                <input type="color" id="backgroundColorModal" class="form-control" value="#ffffff" style="min-width: 80px; width: 100%; height: 40px;">
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <label class="form-label small">Header Color</label>
                <input type="color" id="headerColorModal" class="form-control" value="#333333" style="min-width: 80px; width: 100%; height: 40px;">
              </div>
              <div class="col-6">
                <label class="form-label small">Accent Color</label>
                <input type="color" id="accentColorModal" class="form-control" value="#007bff" style="min-width: 80px; width: 100%; height: 40px;">
              </div>
            </div>
          </div>
          
          <!-- Advanced Options -->
          <div class="mb-4">
            <label class="filter-label">Advanced Options</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableAutoResizeModal" checked>
              <label class="form-check-label" for="enableAutoResizeModal">
                Auto-resize text to fit
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableSmartTruncationModal" checked>
              <label class="form-check-label" for="enableSmartTruncationModal">
                Smart text truncation
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="enableOptimizationModal">
              <label class="form-check-label" for="enableOptimizationModal">
                Enable performance optimization
              </label>
            </div>
          </div>
          
          <!-- Template Preview -->
          <div class="mb-4">
            <label class="filter-label">Template Preview</label>
            <div id="templatePreviewModal" class="border rounded p-3 bg-light" style="min-height: 100px;">
              <div class="text-center text-muted">
                <small>Preview will appear here</small>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="updateTemplatePreview()">
              Refresh Preview
            </button>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveTemplateBtn">Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Generation Splash Modal Overlay -->
  <div id="generationSplashModal" class="generation-splash-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
    <div class="generation-splash-popup" style="background: rgba(22, 33, 62, 0.95); border-radius: 24px; padding: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.2); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
      <canvas class="inner-canvas" id="generation-splash-canvas" style="width: 500px; height: 350px; border-radius: 10px; display: block;"></canvas>
    </div>
  </div>
  <!-- CRITICAL: Override showDatabaseModal BEFORE main.js loads -->
  <script>
    // OVERRIDE showDatabaseModal IMMEDIATELY to prevent old modals from opening
    console.log('Setting up showDatabaseModal override...');
    
    // Store the original function if it exists
    const originalShowDatabaseModal = window.showDatabaseModal;
    
    // Override the function
    window.showDatabaseModal = function(title, content) {
      console.log('showDatabaseModal called with title:', title);
      
      // If it's trying to open the old "Strain Browser" modal, redirect to enhanced modals
      if (title === 'Strain Browser' || title === 'Enhanced Strain Lineage Editor') {
        console.log('BLOCKING old modal - redirecting to enhanced lineage editor modals...');
        // Call enhanced function when it's available
        if (window.openEnhancedLineageEditor) {
          window.openEnhancedLineageEditor();
        } else {
          console.log('Enhanced function not ready yet, will redirect when available');
          // Wait for it to be available
          const checkInterval = setInterval(() => {
            if (window.openEnhancedLineageEditor) {
              clearInterval(checkInterval);
              window.openEnhancedLineageEditor();
            }
          }, 100);
        }
        return;
      }
      
      // For all other modals, use the original function
      if (originalShowDatabaseModal) {
        return originalShowDatabaseModal.call(this, title, content);
      }
    };
    
    console.log('showDatabaseModal override installed successfully');
    
    // DEFINE ENHANCED FUNCTIONS IMMEDIATELY so they're available when called
    window.openEnhancedLineageEditor = function() {
      console.log('Opening enhanced lineage editor...');
      
      // Create a comprehensive lineage editor modal with product search
      const modalHtml = `
        <div class="modal fade" id="lineageEditorModal" tabindex="-1">
          <div class="modal-dialog modal-xl">
            <div class="modal-content glass-card">
              <div class="modal-header border-0 bg-transparent">
                <h5 class="modal-title text-white">
                  <i class="fas fa-dna me-2 text-info"></i>
                  Enhanced Lineage Editor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs nav-tabs-modern mb-4" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="product-search-tab" data-bs-toggle="tab" data-bs-target="#product-search" type="button" role="tab">
                      <i class="fas fa-search me-2"></i>Product Search
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="strain-bulk-tab" data-bs-toggle="tab" data-bs-target="#strain-bulk" type="button" role="tab">
                      <i class="fas fa-seedling me-2"></i>Bulk Strain Update
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                  <!-- Product Search Tab -->
                  <div class="tab-pane fade show active" id="product-search" role="tabpanel">
                    <div class="alert alert-info glass-alert mb-4">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>Product Search:</strong> Find specific products by vendor and update their lineage individually.
                    </div>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label text-white">
                            <i class="fas fa-building me-2 text-primary"></i>Vendor
                          </label>
                          <input type="text" class="form-control form-control-modern" id="vendorSearch" 
                                 placeholder="Search vendors..." oninput="searchVendors(this.value)">
                        </div>
                        <div id="vendorResults" class="glass-card p-3" style="max-height: 200px; overflow-y: auto;">
                          <div class="text-center text-white-50">
                            <i class="fas fa-search me-2"></i>
                            Start typing to search vendors
                          </div>
                        </div>

                      </div>
                      
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label text-white">
                            <i class="fas fa-seedling me-2 text-success"></i>Strain Search
                          </label>
                          <input type="text" class="form-control form-control-modern" id="productSearch" 
                                 placeholder="Search strains..." oninput="searchProducts(this.value)" disabled>
                        </div>
                        <div id="productResults" class="glass-card p-3" style="max-height: 200px; overflow-y: auto;">
                          <div class="text-center text-white-50">
                            <i class="fas fa-info-circle me-2"></i>
                            Select a vendor first
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label text-white">
                            <i class="fas fa-leaf me-2 text-warning"></i>New Lineage
                          </label>
                          <select class="form-select form-select-modern" id="productLineageSelect">
                            <option value="">Select Lineage</option>
                            <option value="INDICA">INDICA</option>
                            <option value="SATIVA">SATIVA</option>
                            <option value="HYBRID">HYBRID</option>
                            <option value="HYBRID/SATIVA">HYBRID/SATIVA</option>
                            <option value="HYBRID/INDICA">HYBRID/INDICA</option>
                            <option value="CBD">CBD</option>
                            <option value="CBD_BLEND">CBD_BLEND</option>
                            <option value="MIXED">MIXED</option>
                            <option value="PARA">PARA</option>
                          </select>
                        </div>
                        <button class="btn btn-modern2 w-100" onclick="updateProductLineage()" disabled id="updateProductBtn">
                          <i class="fas fa-save me-2"></i> Update Product
                        </button>
                      </div>
                    </div>
                    
                    <!-- Selected Product Info -->
                    <div id="selectedProductInfo" class="glass-card p-3 mt-3" style="display: none;">
                      <h6 class="text-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>Selected Product Details
                      </h6>
                      <div class="row">
                        <div class="col-md-3">
                          <strong class="text-white-50">Vendor:</strong>
                          <div class="text-white" id="selectedVendor"></div>
                        </div>
                        <div class="col-md-3">
                          <strong class="text-white-50">Product:</strong>
                          <div class="text-white" id="selectedProduct"></div>
                        </div>
                        <div class="col-md-3">
                          <strong class="text-white-50">Current Lineage:</strong>
                          <div class="text-white" id="currentLineage"></div>
                        </div>
                        <div class="col-md-3">
                          <strong class="text-white-50">New Lineage:</strong>
                          <div class="text-white" id="newLineage"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Bulk Strain Update Tab -->
                  <div class="tab-pane fade" id="strain-bulk" role="tabpanel">
                    <div class="alert alert-warning glass-alert mb-4">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Bulk Update:</strong> Update ALL products with a specific strain across your entire database.
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label text-white">Strain Name</label>
                          <input type="text" class="form-control form-control-modern" id="strainName" placeholder="Enter strain name">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label text-white">New Lineage</label>
                          <select class="form-select form-select-modern" id="strainLineageSelect">
                            <option value="">Select Lineage</option>
                            <option value="INDICA">INDICA</option>
                            <option value="SATIVA">SATIVA</option>
                            <option value="HYBRID">HYBRID</option>
                            <option value="MIXED">MIXED</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-modern2 w-100" onclick="updateBulkStrainLineage()">
                      <i class="fas fa-save me-2"></i> Update All Products
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if present
      const existingModal = document.getElementById('lineageEditorModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add new modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('lineageEditorModal'));
      modal.show();
      
             // Force Product Type Distribution height after modal loads
       setTimeout(() => {
         const productTypeContainers = document.querySelectorAll('.product-type-compact');
         productTypeContainers.forEach(container => {
           container.style.maxHeight = '28px';
           container.style.height = '28px';
           container.style.minHeight = '28px';
           container.style.padding = '2px';
           container.style.gap = '2px';
           container.style.flexWrap = 'wrap';
           container.style.overflowY = 'auto';
         });
       }, 100);
    };
    
    // Function to update single product lineage
    window.updateSingleProductLineage = function() {
      const productName = document.getElementById('editTagName').value;
      const lineage = document.getElementById('editLineageSelect').value;
      
      if (!productName || !lineage) {
        alert('Please enter both product name and lineage');
        return;
      }
      
      console.log(`Updating product "${productName}" to lineage "${lineage}"`);
      alert(`Product "${productName}" updated to lineage "${lineage}"\n\nNote: This is a demo. In production, this would update the database.`);
      
      // Close the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('lineageEditorModal'));
      if (modal) {
        modal.hide();
      }
    };
    
         // Function to update bulk strain lineage
     window.updateBulkStrainLineage = function() {
       const strainName = document.getElementById('strainName').value;
       const lineage = document.getElementById('strainLineageSelect').value;
       
       if (!strainName || !lineage) {
         alert('Please enter both strain name and lineage');
         return;
       }
       
       console.log(`Updating all products with strain "${strainName}" to lineage "${lineage}"`);
       alert(`All products with strain "${strainName}" updated to lineage "${lineage}"\n\nNote: This is a demo. In production, this would update the database.`);
       
       // Close the modal
       const modal = bootstrap.Modal.getInstance(document.getElementById('lineageEditorModal'));
       if (modal) {
         modal.hide();
       }
     };
     

     
           // Function to force Product Type Distribution height
      window.forceProductTypeHeight = function() {
        const productTypeContainers = document.querySelectorAll('.product-type-compact');
        productTypeContainers.forEach(container => {
          container.style.maxHeight = '28px';
          container.style.height = '28px';
          container.style.minHeight = '28px';
          container.style.padding = '2px';
          container.style.gap = '2px';
          container.style.flexWrap = 'wrap';
          container.style.overflowY = 'auto';
          console.log('🔧 Forced Product Type Distribution height:', container);
        });
      };
      
           // Function to search vendors from real database
     window.searchVendors = function(searchTerm) {
       console.log('searchVendors called with:', searchTerm);
       
       try {
         // Check if vendorResults element exists
         const vendorResults = document.getElementById('vendorResults');
         if (!vendorResults) {
           console.error('vendorResults element not found!');
           return;
         }
         
         // Show loading state immediately
         if (searchTerm.length === 0) {
           vendorResults.innerHTML = `
             <div class="text-center text-white-50">
               <i class="fas fa-search me-2"></i>
               Start typing to search vendors
             </div>
           `;
           return;
         }
         
         if (searchTerm.length === 1) {
           vendorResults.innerHTML = `
             <div class="text-center text-white-50">
               <i class="fas fa-spinner fa-spin me-2"></i>
               Type more characters...
             </div>
           `;
           return;
         }
         
         // Show loading state
         vendorResults.innerHTML = `
           <div class="text-center text-white-50">
             <i class="fas fa-spinner fa-spin me-2"></i>
             Searching database...
           </div>
         `;
         
         // Fetch real vendor data from database
         fetch('/api/database-vendor-stats')
           .then(response => {
             if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
             }
             return response.json();
           })
           .then(data => {
             console.log('Database vendor data received:', data);
             
             if (data.error) {
               throw new Error(data.error);
             }
             
             if (!data.vendors || !Array.isArray(data.vendors)) {
               throw new Error('No vendor data available');
             }
             
             // Extract vendor names from the database data
             const allVendors = data.vendors.map(v => v.vendor).filter(v => v && v.trim() !== '');
             console.log('Available vendors from database:', allVendors);
             
             // Filter vendors (case-insensitive, partial match)
             const filteredVendors = allVendors.filter(vendor => 
               vendor.toLowerCase().includes(searchTerm.toLowerCase())
             );
             
             console.log(`Found ${filteredVendors.length} vendors matching "${searchTerm}":`, filteredVendors);
             
             if (filteredVendors.length > 0) {
               const resultsHtml = filteredVendors.map(vendor => {
                 // Find vendor stats for this vendor
                 const vendorStats = data.vendors.find(v => v.vendor === vendor);
                 const productCount = vendorStats ? vendorStats.product_count : '?';
                 
                 return `
                   <div class="vendor-result-item p-2 mb-2 rounded cursor-pointer" 
                        style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);"
                        data-vendor="${vendor.replace(/"/g, '&quot;')}"
                        onclick="selectVendorFromElement(this)">
                     <i class="fas fa-building me-2 text-primary"></i>
                     <span class="text-white">${vendor}</span>
                     <small class="text-white-50 ms-2">${productCount} products</small>
                     <small class="text-white-50 ms-2">Click to select</small>
                   </div>
                 `;
               }).join('');
               
               vendorResults.innerHTML = resultsHtml;
               console.log('Vendor results updated successfully');
             } else {
               vendorResults.innerHTML = `
                 <div class="text-center text-white-50">
                   <i class="fas fa-exclamation-triangle me-2"></i>
                   No vendors found matching "${searchTerm}"
                 </div>
               `;
               console.log('No vendors found');
             }
           })
           .catch(error => {
             console.error('Error fetching vendor data:', error);
             vendorResults.innerHTML = `
               <div class="text-center text-danger">
                 <i class="fas fa-exclamation-triangle me-2"></i>
                 Error loading vendors: ${error.message}
               </div>
             `;
           });
         
       } catch (error) {
         console.error('Error in searchVendors:', error);
         const vendorResults = document.getElementById('vendorResults');
         if (vendorResults) {
           vendorResults.innerHTML = `
             <div class="text-center text-danger">
               <i class="fas fa-exclamation-triangle me-2"></i>
               Error: ${error.message}
             </div>
           `;
         }
       }
     };
     
     // Function to select a vendor from element (more reliable)
     window.selectVendorFromElement = function(element) {
       const vendorName = element.getAttribute('data-vendor');
       console.log('selectVendorFromElement called with vendor:', vendorName);
       
       if (!vendorName) {
         console.error('No vendor name found in element data');
         return;
       }
       
       // Call the original selectVendor function
       window.selectVendor(vendorName);
     };
     
     // Function to select a vendor
     window.selectVendor = function(vendorName) {
       console.log('selectVendor called with:', vendorName);
       
       if (!vendorName || vendorName.trim() === '') {
         console.error('Invalid vendor name:', vendorName);
         return;
       }
       
       // Update vendor search input
       document.getElementById('vendorSearch').value = vendorName;
       
       // Show vendor selection confirmation
       document.getElementById('vendorResults').innerHTML = `
         <div class="text-center text-success">
           <i class="fas fa-check-circle me-2"></i>
           <strong>Selected:</strong> ${vendorName}
         </div>
       `;
       
       // Enable strain search
       document.getElementById('productSearch').disabled = false;
       document.getElementById('productSearch').placeholder = `Search strains from ${vendorName}...`;
       
       // Clear previous strain results
       document.getElementById('productResults').innerHTML = `
         <div class="text-center text-white-50">
           <i class="fas fa-search me-2"></i>
           Now search for strains from ${vendorName}
         </div>
       `;
       
       // Store selected vendor for later use
       window.selectedVendor = vendorName;
       
       console.log('Vendor selection complete. selectedVendor:', window.selectedVendor);
     };
     
     // Function to search products by vendor from real database
     window.searchProducts = function(searchTerm) {
       console.log('🔍 searchProducts called with:', searchTerm);
       
       if (!window.selectedVendor) {
         document.getElementById('productResults').innerHTML = `
           <div class="text-center text-warning">
             <i class="fas fa-exclamation-triangle me-2"></i>
             Please select a vendor first
           </div>
         `;
         return;
       }
       
       // Show loading state immediately
       if (searchTerm.length === 0) {
         document.getElementById('productResults').innerHTML = `
           <div class="text-center text-white-50">
             <i class="fas fa-search me-2"></i>
             Start typing to search products from ${window.selectedVendor}
           </div>
         `;
         return;
       }
       
       if (searchTerm.length === 1) {
         document.getElementById('productResults').innerHTML = `
           <div class="text-center text-white-50">
             <i class="fas fa-spinner fa-spin me-2"></i>
             Type more characters...
           </div>
         `;
         return;
       }
       
       // Show loading state
       document.getElementById('productResults').innerHTML = `
         <div class="text-center text-white-50">
           <i class="fas fa-spinner fa-spin me-2"></i>
           Searching products...
         </div>
       `;
       
       // Fetch real product data from database using the new products search API
       const searchUrl = `/api/products/search?vendor=${encodeURIComponent(window.selectedVendor)}&q=${encodeURIComponent(searchTerm)}`;
       console.log('🔍 Searching products with URL:', searchUrl);
       console.log('🔍 Selected vendor:', window.selectedVendor);
       console.log('🔍 Search term:', searchTerm);
       
       fetch(searchUrl)
         .then(response => {
           if (!response.ok) {
             throw new Error(`HTTP error! status: ${response.status}`);
           }
           return response.json();
         })
         .then(data => {
           console.log('🔍 Strain search results received:', data);
           console.log('🔍 Data type:', typeof data);
           console.log('🔍 Data keys:', Object.keys(data));
           console.log('🔍 Strains array:', data.strains);
           console.log('🔍 Total found:', data.total_found);
           
           if (data.error) {
             console.error('❌ API returned error:', data.error);
             throw new Error(data.error);
           }
           
           if (!data.strains || !Array.isArray(data.strains)) {
             console.error('❌ No strain data available. Data structure:', data);
             throw new Error('No strain data available');
           }
           
           console.log(`Found ${data.total_found} unique strains from ${window.selectedVendor}:`, data.strains);
           
           if (data.strains.length > 0) {
             // Group strains by brand for better organization
             const strainsByBrand = {};
             data.strains.forEach(strain => {
               if (!strainsByBrand[strain.brand]) {
                 strainsByBrand[strain.brand] = [];
               }
               strainsByBrand[strain.brand].push(strain);
             });
             
             const resultsHtml = Object.entries(strainsByBrand).map(([brand, strains]) => {
                               const brandStrainsHtml = strains.map(strain => {
                  const strainName = strain.strain_name || 'Unknown Strain';
                  const productType = strain.product_type || '';
                  const lineage = strain.lineage || '';
                  const productCount = strain.product_count || 1;
                  const products = strain.products || [];
                  const lineages = strain.lineages || [];
                  
                  // Show multiple lineages if they exist
                  let lineageDisplay = '';
                  if (lineages && lineages.length > 0) {
                    const uniqueLineages = [...new Set([lineage, ...lineages])].filter(l => l);
                    if (uniqueLineages.length > 1) {
                      lineageDisplay = `<small class="text-warning ms-2">⚠️ Multiple lineages: ${uniqueLineages.join(', ')}</small>`;
                    } else {
                      lineageDisplay = `<small class="text-white-50 ms-2">Current: ${uniqueLineages[0]}</small>`;
                    }
                  } else if (lineage) {
                    lineageDisplay = `<small class="text-white-50 ms-2">Current: ${lineage}</small>`;
                  }
                  
                  return `
                    <div class="strain-result-item p-2 mb-1 rounded cursor-pointer" 
                         style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); margin-left: 20px;"
                         data-strain="${strainName.replace(/"/g, '&quot;')}"
                         data-brand="${brand.replace(/"/g, '&quot;')}"
                         data-product-type="${productType.replace(/"/g, '&quot;')}"
                         data-lineage="${lineage.replace(/"/g, '&quot;')}"
                         onclick="selectStrainFromElement(this)">
                      <i class="fas fa-seedling me-2 text-success"></i>
                      <span class="text-white fw-bold">${strainName}</span>
                      ${productType ? `<small class="text-white-50 ms-2">${productType}</small>` : ''}
                      ${lineageDisplay}
                      <small class="text-white-50 ms-2">(${productCount} products)</small>
                      <small class="text-white-50 ms-2">Click to select</small>
                      ${products.length > 0 ? `
                        <div class="mt-1" style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">
                          <small>Products: ${products.map(p => p.product_name).join(', ')}</small>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('');
               
               return `
                 <div class="brand-section mb-3">
                   <div class="brand-header p-2 rounded" style="background: rgba(0, 212, 170, 0.2); border: 1px solid rgba(0, 212, 170, 0.4);">
                     <i class="fas fa-tag me-2 text-info"></i>
                     <span class="text-white fw-bold">${brand}</span>
                     <small class="text-white-50 ms-2">(${strains.length} unique strains)</small>
                   </div>
                   ${brandStrainsHtml}
                 </div>
               `;
             }).join('');
             
             document.getElementById('productResults').innerHTML = resultsHtml;
             console.log('Strain results updated successfully');
           } else {
             document.getElementById('productResults').innerHTML = `
               <div class="text-center text-white-50">
                 <i class="fas fa-exclamation-triangle me-2"></i>
                 No strains found matching "${searchTerm}" from ${window.selectedVendor}
               </div>
             `;
             console.log('No strains found');
           }
         })
         .catch(error => {
           console.error('Error fetching product data:', error);
           document.getElementById('productResults').innerHTML = `
             <div class="text-center text-danger">
               <i class="fas fa-exclamation-triangle me-2"></i>
               Error loading products: ${error.message}
             </div>
           `;
         });
     };
     
     // Function to select a strain from the lineage editor
     window.selectStrainFromLineageEditor = function(strainName, brand, productType, lineage) {
       console.log('Selected strain from lineage editor:', { strainName, brand, productType, lineage });
       
       // Update the bulk strain fields
       const bulkStrainName = document.getElementById('bulkStrainName');
       if (bulkStrainName) {
         bulkStrainName.value = strainName;
       }
       
       // Update the single product search field to show the selected strain
       const singleProductSearch = document.getElementById('singleProductSearch');
       if (singleProductSearch) {
         singleProductSearch.value = strainName;
       }
       
       // Show success message
       const strainSearchResults = document.getElementById('strainSearchResults');
       if (strainSearchResults) {
         strainSearchResults.innerHTML = `
           <div class="text-center text-success">
             <i class="fas fa-check-circle me-2"></i>
             <strong>${strainName}</strong> selected from ${brand}
             ${productType ? `<br><small class="text-white-50">${productType}</small>` : ''}
             ${lineage ? `<br><small class="text-white-50">Current lineage: ${lineage}</small>` : ''}
           </div>
         `;
       }
       
       // Show toast notification
       if (window.showToast) {
         window.showToast(`Selected strain: ${strainName}`, 'success');
       }
     };
     
     // Function to select a strain from element (more reliable)
     window.selectStrainFromElement = function(element) {
       const strainName = element.getAttribute('data-strain');
       const brand = element.getAttribute('data-brand');
       const productType = element.getAttribute('data-product-type');
       const lineage = element.getAttribute('data-lineage');
       
       console.log('selectStrainFromElement called with strain:', strainName, 'brand:', brand, 'type:', productType, 'lineage:', lineage);
       
       if (!strainName) {
         console.error('No strain name found in element data');
         return;
       }
       
       // Store additional strain info for later use
       window.selectedStrainInfo = {
         name: strainName,
         brand: brand,
         type: productType,
         lineage: lineage
       };
       
       // Call the original selectProduct function (keeping the same flow for now)
       window.selectProduct(strainName);
     };
     
     // Function to select a product from element (more reliable)
     window.selectProductFromElement = function(element) {
       const productName = element.getAttribute('data-product');
       const productType = element.getAttribute('data-product-type');
       const lineage = element.getAttribute('data-lineage');
       
       console.log('selectProductFromElement called with product:', productName, 'type:', productType, 'lineage:', lineage);
       
       if (!productName) {
         console.error('No product name found in element data');
         return;
       }
       
       // Store additional product info for later use
       window.selectedProductInfo = {
         name: productName,
         type: productType,
         lineage: lineage
       };
       
       // Call the original selectProduct function
       window.selectProduct(productName);
     };
     
     // Function to select a product
     window.selectProduct = function(productName) {
       console.log('✅ selectProduct called with:', productName);
       
       if (!productName || productName.trim() === '') {
         console.error('❌ Invalid product name:', productName);
         return;
       }
       
       // Update product search input
       document.getElementById('productSearch').value = productName;
       
       // Show product selection confirmation
       document.getElementById('productResults').innerHTML = `
         <div class="text-center text-success">
           <i class="fas fa-check-circle me-2"></i>
           <strong>Selected:</strong> ${productName}
         </div>
       `;
       
       // Enable lineage selection and update button
       document.getElementById('productLineageSelect').disabled = false;
       document.getElementById('updateProductBtn').disabled = false;
       
       // Show selected product info
       document.getElementById('selectedProductInfo').style.display = 'block';
       document.getElementById('selectedVendor').textContent = window.selectedVendor;
       document.getElementById('selectedProduct').textContent = productName;
       document.getElementById('currentLineage').textContent = 'Unknown';
       
       // Store selected product for later use
       window.selectedProduct = productName;
     };
     
     // Function to update product lineage
     window.updateProductLineage = function() {
       const vendor = window.selectedVendor;
       const product = window.selectedProduct;
       const lineage = document.getElementById('productLineageSelect').value;
       
       if (!vendor || !product || !lineage) {
         alert('Please select vendor, product, and lineage');
         return;
       }
       
       // Update the new lineage display
       document.getElementById('newLineage').textContent = lineage;
       
       console.log(`Updating product "${product}" from vendor "${vendor}" to lineage "${lineage}"`);
       alert(`Product "${product}" from vendor "${vendor}" updated to lineage "${lineage}"\n\nNote: This is a demo. In production, this would update the database.`);
       
       // Close the modal
       const modal = bootstrap.Modal.getInstance(document.getElementById('lineageEditorModal'));
       if (modal) {
         modal.hide();
       }
     };
    // Add search functionality for unified lineage editor
    function initializeUnifiedLineageSearch() {
      console.log('Initializing unified lineage search...');
      
      // Single Product Tab - Strain Search
      const singleProductSearch = document.getElementById('singleProductSearch');
      const strainSearchResults = document.getElementById('strainSearchResults');
      const singleProductLineage = document.getElementById('singleProductLineage');
      
      console.log('Found elements:', {
        singleProductSearch: !!singleProductSearch,
        strainSearchResults: !!strainSearchResults,
        singleProductLineage: !!singleProductLineage
      });
      
      if (singleProductSearch && strainSearchResults) {
        console.log('Adding event listener to strain search...');
        singleProductSearch.addEventListener('input', function() {
          console.log('Search input event fired, value:', this.value);
          const searchTerm = this.value;
          
          if (searchTerm.length < 2) {
            strainSearchResults.innerHTML = `
              <div class="text-center text-white-50">
                <i class="fas fa-search me-2"></i>
                Type at least 2 characters to search for strains
              </div>
            `;
            return;
          }
          
          // Show loading state
          strainSearchResults.innerHTML = `
            <div class="text-center text-white-50">
              <i class="fas fa-spinner fa-spin me-2"></i>
              Searching strains...
            </div>
          `;
          
          // Use the real searchProducts function to search for strains
          if (window.selectedVendor) {
            // Call the real API endpoint
            const searchUrl = `/api/products/search?vendor=${encodeURIComponent(window.selectedVendor)}&q=${encodeURIComponent(searchTerm)}`;
            console.log('🔍 Searching strains with URL:', searchUrl);
            
            fetch(searchUrl)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                console.log('🔍 Strain search results received:', data);
                
                if (data.error) {
                  throw new Error(data.error);
                }
                
                if (!data.strains || !Array.isArray(data.strains)) {
                  throw new Error('No strain data available');
                }
                
                if (data.strains.length > 0) {
                  // Group strains by brand for better organization
                  const strainsByBrand = {};
                  data.strains.forEach(strain => {
                    if (!strainsByBrand[strain.brand]) {
                      strainsByBrand[strain.brand] = [];
                    }
                    strainsByBrand[strain.brand].push(strain);
                  });
                  
                  const resultsHtml = Object.entries(strainsByBrand).map(([brand, strains]) => {
                    const brandStrainsHtml = strains.map(strain => {
                      const strainName = strain.strain_name || 'Unknown Strain';
                      const productType = strain.product_type || '';
                      const lineage = strain.lineage || '';
                      const productCount = strain.product_count || 1;
                      const products = strain.products || [];
                      const lineages = strain.lineages || [];
                      
                      // Show multiple lineages if they exist
                      let lineageDisplay = '';
                      if (lineages && lineages.length > 0) {
                        const uniqueLineages = [...new Set([lineage, ...lineages])].filter(l => l);
                        if (uniqueLineages.length > 1) {
                          lineageDisplay = `<small class="text-warning ms-2">⚠️ Multiple lineages: ${uniqueLineages.join(', ')}</small>`;
                        } else {
                          lineageDisplay = `<small class="text-white-50 ms-2">Current: ${uniqueLineages[0]}</small>`;
                        }
                      } else if (lineage) {
                        lineageDisplay = `<small class="text-white-50 ms-2">Current: ${lineage}</small>`;
                      }
                      
                      return `
                        <div class="strain-result-item p-2 mb-1 rounded cursor-pointer" 
                             style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); margin-left: 20px;"
                             data-strain="${strainName.replace(/"/g, '&quot;')}"
                             data-brand="${brand.replace(/"/g, '&quot;')}"
                             data-product-type="${productType.replace(/"/g, '&quot;')}"
                             data-lineage="${lineage.replace(/"/g, '&quot;')}"
                             onclick="selectStrainFromLineageEditor('${strainName.replace(/'/g, '\\\'')}', '${brand.replace(/'/g, '\\\'')}', '${productType.replace(/'/g, '\\\'')}', '${lineage.replace(/'/g, '\\\'')}')">
                          <i class="fas fa-seedling me-2 text-success"></i>
                          <span class="text-white fw-bold">${strainName}</span>
                          ${productType ? `<small class="text-white-50 ms-2">${productType}</small>` : ''}
                          ${lineageDisplay}
                          <small class="text-white-50 ms-2">(${productCount} products)</small>
                          <small class="text-white-50 ms-2">Click to select</small>
                          ${products.length > 0 ? `
                            <div class="mt-1" style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">
                              <small>Products: ${products.map(p => p.product_name).join(', ')}</small>
                            </div>
                          ` : ''}
                        </div>
                      `;
                    }).join('');
                    
                    return `
                      <div class="brand-section mb-3">
                        <div class="brand-header p-2 rounded" style="background: rgba(0, 212, 170, 0.2); border: 1px solid rgba(0, 212, 170, 0.4);">
                          <i class="fas fa-tag me-2 text-info"></i>
                          <span class="text-white fw-bold">${brand}</span>
                          <small class="text-white-50 ms-2">(${strains.length} unique strains)</small>
                        </div>
                        ${brandStrainsHtml}
                      </div>
                    `;
                  }).join('');
                  
                  strainSearchResults.innerHTML = resultsHtml;
                  console.log('Strain results updated successfully');
                } else {
                  strainSearchResults.innerHTML = `
                    <div class="text-center text-white-50">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      No strains found matching "${searchTerm}" from ${window.selectedVendor}
                    </div>
                  `;
                  console.log('No strains found');
                }
              })
              .catch(error => {
                console.error('Error fetching strain data:', error);
                strainSearchResults.innerHTML = `
                  <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading strains: ${error.message}
                  </div>
                `;
              });
          } else {
            strainSearchResults.innerHTML = `
              <div class="text-center text-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Please select a vendor first
              </div>
            `;
          }
        });
        console.log('Event listener added successfully');
      } else {
        console.error('Required elements not found for strain search');
      }
      
      // Lineage Options Filter
      const lineageOptionsSearch = document.getElementById('lineageOptionsSearch');
      if (lineageOptionsSearch && singleProductLineage) {
        lineageOptionsSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const options = singleProductLineage.querySelectorAll('option');
          
          options.forEach(option => {
            if (option.value === '') return; // Skip placeholder option
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
      
      // Bulk Strain Tab Search
      const bulkStrainSearch = document.getElementById('bulkStrainSearch');
      const bulkStrainLineage = document.getElementById('bulkStrainLineage');
      
      if (bulkStrainSearch && bulkStrainLineage) {
        bulkStrainSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const options = bulkStrainLineage.querySelectorAll('option');
          
          options.forEach(option => {
            if (option.value === '') return; // Skip placeholder option
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
      
      // Multi-Strain Tab Search
      const multiStrainSearch = document.getElementById('multiStrainSearch');
      const multiStrainLineage = document.getElementById('multiStrainLineage');
      
      if (multiStrainSearch && multiStrainLineage) {
        multiStrainSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const options = multiStrainLineage.querySelectorAll('option');
          
          options.forEach(option => {
            if (option.value === '') return; // Skip placeholder option
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
    }
    
    // Function to select a strain from search results
    window.selectStrain = function(strainName) {
      console.log('Selected strain:', strainName);
      
      // Update the search input with selected strain
      const searchInput = document.getElementById('singleProductSearch');
      if (searchInput) {
        searchInput.value = strainName;
      }
      
      // Show confirmation in results area
      const resultsArea = document.getElementById('strainSearchResults');
      if (resultsArea) {
        resultsArea.innerHTML = `
          <div class="text-center text-success">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Selected:</strong> ${strainName}
          </div>
        `;
      }
      
      // You can add additional logic here to load strain details
      // or populate other fields as needed
    };
    
    console.log('Enhanced lineage editor functions defined and ready!');
    
    // Function to select a strain from the lineage editor
    window.selectStrainFromLineageEditor = function(strainName, brand, productType, lineage) {
      console.log('Selected strain from lineage editor:', { strainName, brand, productType, lineage });
      
      // Update the bulk strain fields
      const bulkStrainName = document.getElementById('bulkStrainName');
      if (bulkStrainName) {
        bulkStrainName.value = strainName;
      }
      
      // Update the single product search field to show the selected strain
      const singleProductSearch = document.getElementById('singleProductSearch');
      if (singleProductSearch) {
        singleProductSearch.value = strainName;
      }
      
      // Show success message
      const strainSearchResults = document.getElementById('strainSearchResults');
      if (strainSearchResults) {
        strainSearchResults.innerHTML = `
          <div class="text-center text-success">
            <i class="fas fa-check-circle me-2"></i>
            <strong>${strainName}</strong> selected from ${brand}
            ${productType ? `<br><small class="text-white-50">${productType}</small>` : ''}
            ${lineage ? `<br><small class="text-white-50">Current lineage: ${lineage}</small>` : ''}
          </div>
        `;
      }
      
      // Show toast notification
      if (window.showToast) {
        window.showToast(`Selected strain: ${strainName}`, 'success');
      }
    };
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}?v={{ cache_bust }}"></script>
  
  <!-- Debug Script -->
  <script>
    // Debug script to test filter functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DEBUG FILTERS ===');
      
      // Check if filter elements exist
      const filterIds = ['vendorFilter', 'brandFilter', 'productTypeFilter', 'lineageFilter', 'weightFilter', 'dohFilter', 'highCbdFilter'];
      
      filterIds.forEach(filterId => {
          const element = document.getElementById(filterId);
          console.log(`${filterId}:`, element ? 'FOUND' : 'NOT FOUND');
          if (element) {
              console.log(`  - Value: "${element.value}"`);
              console.log(`  - Options:`, element.options.length);
          }
      });
      
      // Test if we can attach event listeners
      filterIds.forEach(filterId => {
          const element = document.getElementById(filterId);
          if (element) {
              console.log(`Testing event listener for ${filterId}...`);
              element.addEventListener('change', (e) => {
                  console.log(`FILTER CHANGED: ${filterId} = "${e.target.value}"`);
              });
              console.log(`Event listener attached to ${filterId}`);
          }
      });
      
      // Test tag checkboxes
      setTimeout(() => {
        console.log('=== TESTING TAG CHECKBOXES ===');
        const checkboxes = document.querySelectorAll('.tag-checkbox');
        console.log(`Found ${checkboxes.length} tag checkboxes`);
        
        checkboxes.forEach((checkbox, index) => {
            console.log(`Checkbox ${index}:`, checkbox.value, 'checked:', checkbox.checked);
            checkbox.addEventListener('change', (e) => {
                console.log(`TAG CHECKBOX CHANGED: ${checkbox.value} = ${e.target.checked}`);
            });
        });
      }, 2000);
      

      
      console.log('=== DEBUG COMPLETE ===');
    });
  </script>
  <script src="{{ url_for('static', filename='js/enhanced-ui.js') }}"></script>
  <script src="{{ url_for('static', filename='js/generation-splash.js') }}"></script>
  <script src="{{ url_for('static', filename='js/drag-and-drop-manager.js') }}"></script>
  <script src="{{ url_for('static', filename='js/lava-lamp.js') }}"></script>
  <script src="{{ url_for('static', filename='js/debug_advanced_features.js') }}"></script>
  <script src="{{ url_for('static', filename='js/fix_template_preview.js') }}"></script>
  <script>
    // Function to scroll to top
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        left: 0,
        behavior: 'smooth'
      });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      // Remove toast element after it's hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }
    
    // Create toast container if it doesn't exist
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      return container;
    }
    
    // Scroll to top on DOM content loaded
    document.addEventListener('DOMContentLoaded', function () {
      scrollToTop();
    });
    
    // Scroll to top on window load (handles reloads)
    window.addEventListener('load', function () {
      scrollToTop();
      
      // Sync store with backend and update display
      setTimeout(() => {
        console.log('Window load: Starting store sync...');
        // First check what store the backend has
        fetch('/api/get-store')
          .then(response => response.json())
          .then(data => {
            console.log('Window load: Backend store data:', data);
            if (data.success && data.store) {
              console.log('Window load: Backend store:', data.store);
              // Force update the display directly
              const displayElement = document.getElementById('currentStoreDisplay');
              if (displayElement) {
                displayElement.textContent = data.store.replace(/_/g, ' ');
                displayElement.style.color = '#4ade80';
                console.log('Window load: Updated display to:', data.store.replace(/_/g, ' '));
              }
              // Also update the store status
              updateStoreStatus(`Store: ${data.store.replace(/_/g, ' ')}`, 'active');
              // Also save to localStorage for consistency
              localStorage.setItem('selectedStore', data.store);
              console.log('Window load: Store sync completed');
            } else {
              // No store in backend, default to Bothell
              console.log('No store in backend, defaulting to AGT_Bothell');
              changeStore('AGT_Bothell');
            }
          })
          .catch(error => {
            console.error('Error checking backend store:', error);
            // Fallback to localStorage or default
            const savedStore = localStorage.getItem('selectedStore');
            if (savedStore) {
              const displayElement = document.getElementById('currentStoreDisplay');
              if (displayElement) {
                displayElement.textContent = savedStore.replace(/_/g, ' ');
                displayElement.style.color = '#4ade80';
              }
              updateStoreStatus(`Store: ${savedStore.replace(/_/g, ' ')}`, 'active');
            } else {
              console.log('No store saved, defaulting to AGT_Bothell');
              changeStore('AGT_Bothell');
            }
          });
      }, 1000);
      
      // Additional sync after 3 seconds to ensure it works
      setTimeout(() => {
        console.log('Delayed sync: Checking store again...');
        const displayElement = document.getElementById('currentStoreDisplay');
        if (displayElement && displayElement.textContent === 'No store selected') {
          console.log('Delayed sync: Still showing no store, forcing update...');
          fetch('/api/get-store')
            .then(response => response.json())
            .then(data => {
              if (data.success && data.store) {
                displayElement.textContent = data.store.replace(/_/g, ' ');
                displayElement.style.color = '#4ade80';
                updateStoreStatus(`Store: ${data.store.replace(/_/g, ' ')}`, 'active');
                console.log('Delayed sync: Forced update to:', data.store.replace(/_/g, ' '));
              }
            });
        }
      }, 3000);
      
      // Emergency fallback - default to Bothell after 3 seconds if still no store
      setTimeout(() => {
        const savedStore = localStorage.getItem('selectedStore');
        if (!savedStore) {
          console.log('Emergency fallback: No store saved after 3 seconds, defaulting to AGT_Bothell');
          changeStore('AGT_Bothell');
        }
      }, 3000);
    });
    
    // Scroll to top on page show (handles back/forward navigation)
    window.addEventListener('pageshow', function () {
      scrollToTop();
    });
    
    // Set Bothell as default store IMMEDIATELY - before DOMContentLoaded
    console.log('Setting Bothell as default store IMMEDIATELY...');
    updateCurrentStoreDisplay('AGT_Bothell');
    updateStoreStatus('Store: AGT Bothell', 'active');
    localStorage.setItem('selectedStore', 'AGT_Bothell');

    // Define TagManager object
    window.TagManager = {
      state: {
        tags: [],
        originalTags: [],
        persistentSelectedTags: []
      },
      
      init: function() {
        console.log('TagManager.init() called');
        this.loadAvailableTags();
      },
      
      loadAvailableTags: function() {
        console.log('Loading available tags from API...');
        fetch('/api/available-tags')
          .then(response => response.json())
          .then(data => {
            console.log('Available tags loaded:', data.tags.length);
            this.state.tags = data.tags || [];
            this.state.originalTags = [...this.state.tags];
            this._updateAvailableTags();
          })
          .catch(error => {
            console.error('Error loading tags:', error);
          });
      },
      
      _updateAvailableTags: function(tags) {
        console.log('_updateAvailableTags called with', (tags || this.state.tags).length, 'tags');
        const tagsToUse = tags || this.state.tags;
        const container = document.getElementById('availableTags');
        if (!container) {
          console.error('availableTags container not found');
          return;
        }
        
        console.log('Found availableTags container, rendering', tagsToUse.length, 'tags with DOH dropdowns');
        
        // Clear container
        container.innerHTML = '';
        
        // Create tags with DOH dropdown
        tagsToUse.forEach((tag, index) => {
          console.log(`Creating tag element ${index + 1}:`, tag.ProductName || tag['Product Name*']);
          const tagElement = this.createTagElement(tag);
          container.appendChild(tagElement);
        });
        
        console.log('Finished rendering', tagsToUse.length, 'tag elements with DOH dropdowns');
      },
      
      createTagElement: function(tag) {
        const tagDiv = document.createElement('div');
        tagDiv.className = 'tag-item mb-3 p-3 border rounded';
        tagDiv.style.backgroundColor = '#f0f8ff';
        tagDiv.style.border = '3px solid #007bff';
        
        // Get DOH status - check multiple possible field names
        const dohStatus = tag['DOH Compliant (Yes/No)'] || tag.DOH || tag.doh || 'Unknown';
        const productName = tag.ProductName || tag['Product Name*'] || tag['Product Name'] || 'Unknown Product';
        
        console.log('Creating tag for:', productName, 'DOH status:', dohStatus);
        
        tagDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong style="color: #000;">${productName}</strong><br>
              <small style="color: #666;">${tag.Vendor || 'Unknown Vendor'} - ${tag['Product Type*'] || tag.productType || 'Unknown Type'}</small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-secondary">${tag.Lineage || 'Unknown'}</span>
              <label style="font-weight: bold; color: red;">DOH:</label>
              <select class="doh-dropdown form-select form-select-sm" style="width: 100px;" 
                      onchange="TagManager.updateDohStatus('${productName}', this.value)">
                <option value="Yes" ${dohStatus === 'Yes' ? 'selected' : ''}>Yes</option>
                <option value="No" ${dohStatus === 'No' ? 'selected' : ''}>No</option>
                <option value="Pending" ${dohStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Unknown" ${dohStatus === 'Unknown' ? 'selected' : ''}>Unknown</option>
              </select>
              <button class="btn btn-sm btn-primary" onclick="TagManager.addToSelected('${productName}')">Add</button>
            </div>
          </div>
        `;
        
        return tagDiv;
      },
      
      updateDohStatus: function(productName, dohValue) {
        console.log('Updating DOH status for:', productName, 'to:', dohValue);
        
        fetch('/api/update-doh', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            product_name: productName,
            doh_status: dohValue
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('DOH status updated successfully');
            // Update local state
            const tag = this.state.tags.find(t => (t.ProductName || t['Product Name*']) === productName);
            if (tag) {
              tag.DOH = dohValue;
            }
          } else {
            console.error('Failed to update DOH status:', data.message);
          }
        })
        .catch(error => {
          console.error('Error updating DOH status:', error);
        });
      },
      
      addToSelected: function(productName) {
        console.log('Adding to selected:', productName);
        if (!this.state.persistentSelectedTags.includes(productName)) {
          this.state.persistentSelectedTags.push(productName);
          this._updateSelectedTags();
        }
      },
      
      _updateSelectedTags: function() {
        console.log('_updateSelectedTags called with:', this.state.persistentSelectedTags.length, 'tags');
        const container = document.getElementById('selectedTags');
        if (container) {
          container.innerHTML = this.state.persistentSelectedTags.map(name => 
            `<span class="badge bg-primary me-1 mb-1">${name}</span>`
          ).join('');
        }
      },
      
      clearAllFilters: function() {
        console.log('Clearing all filters');
        // Reset filters and reload tags
        this._updateAvailableTags();
      },
      
      debouncedGenerate: function() {
        console.log('Generate button clicked');
        // Implementation for generate functionality
      },
      
      downloadExcel: function() {
        console.log('Download Excel clicked');
        // Implementation for Excel download
      },
      
      updateSelectedTags: function(tags) {
        console.log('updateSelectedTags called with:', tags);
        this.state.persistentSelectedTags = tags || [];
        this._updateSelectedTags();
      },
      
      debouncedUpdateAvailableTags: function(tags) {
        console.log('debouncedUpdateAvailableTags called');
        this._updateAvailableTags(tags);
      }
    };

    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM Content Loaded - initializing TagManager...');
      
      // Ensure Bothell is still set as default store display
      console.log('DOMContentLoaded: Ensuring Bothell display is set...');
      updateCurrentStoreDisplay('AGT_Bothell');
      updateStoreStatus('Store: AGT Bothell', 'active');
      
      TagManager.init();
      
      // DOH FILTER FUNCTIONALITY - Make the DOH dropdown in filter bar work
      setTimeout(() => {
        console.log('Setting up DOH filter functionality...');
        const dohFilter = document.getElementById('dohFilter');
        if (dohFilter) {
          console.log('DOH filter found, adding event listener...');
          
          // Add change event listener
          dohFilter.addEventListener('change', function() {
            const selectedValue = this.value;
            console.log('DOH filter changed to:', selectedValue);
            
            // Add visual feedback
            const filterLabel = document.querySelector('label[for="dohFilter"]');
            if (filterLabel && selectedValue !== 'All') {
              filterLabel.style.color = '#ff6600';
              filterLabel.style.fontWeight = 'bold';
              filterLabel.innerHTML = `DOH COMPLIANCE (${selectedValue})`;
            } else if (filterLabel) {
              filterLabel.style.color = '';
              filterLabel.style.fontWeight = '';
              filterLabel.innerHTML = 'DOH COMPLIANCE';
            }
            
            // You can add actual filtering logic here
            console.log('DOH filter is now set to:', selectedValue);
            
            // Show confirmation message
            if (selectedValue !== 'All') {
              const confirmDiv = document.createElement('div');
              confirmDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #28a745; color: white; padding: 15px; border-radius: 5px; z-index: 10000; font-weight: bold;';
              confirmDiv.innerHTML = `✅ DOH Filter Applied: ${selectedValue}`;
              document.body.appendChild(confirmDiv);
              
              setTimeout(() => {
                if (confirmDiv.parentNode) {
                  confirmDiv.remove();
                }
              }, 3000);
            }
          });
          
          console.log('DOH filter is now functional!');
        } else {
          console.error('DOH filter element not found');
        }
      }, 1000);

      }, 2000);

      // Also set the store in backend
      console.log('DOMContentLoaded: Setting Bothell as default store...');
      changeStore('AGT_Bothell');
      
      // Also sync with backend to ensure consistency
      fetch('/api/get-store')
        .then(response => {
          console.log('Store API response:', response);
          return response.json();
        })
        .then(data => {
          console.log('Store API data:', data);
          if (data.success && data.store) {
            console.log('DOMContentLoaded: Backend store is', data.store);
            // Update the display
            const displayElement = document.getElementById('currentStoreDisplay');
            if (displayElement) {
              displayElement.textContent = data.store.replace(/_/g, ' ');
              displayElement.style.color = '#4ade80';
              console.log('Updated display element to:', data.store.replace(/_/g, ' '));
            }
            // Also update the store status
            updateStoreStatus(`Store: ${data.store.replace(/_/g, ' ')}`, 'active');
            localStorage.setItem('selectedStore', data.store);
            console.log('Store sync completed successfully');
          } else {
            console.log('No store in backend data, Bothell should be set as default');
          }
        })
        .catch(error => {
          console.error('Error syncing store on DOMContentLoaded:', error);
          // Ensure Bothell is still set as default even if backend check fails
          changeStore('AGT_Bothell');
        });
      
      console.log('TagManager initialized, waiting for Bootstrap...');
      
      // Wait a bit for Bootstrap to be fully loaded
      setTimeout(() => {
        console.log('Timeout completed, checking store selection...');
        
        // Verify modal exists
        verifyModalExists();
        
        // Load saved store selection
        loadSavedStore();
        
        // Check if store selection is required
        checkStoreRequired();
      }, 500);
      
      // Periodically check store status from backend
      setInterval(updateStoreStatusFromBackend, 30000); // Check every 30 seconds
      
      // Add attention animation to help buttons on page load
      const helpButtons = document.querySelectorAll('.btn-help-modern, .btn-help-header');
      helpButtons.forEach(button => {
        setTimeout(() => {
          button.classList.add('attention');
          setTimeout(() => {
            button.classList.remove('attention');
          }, 2000); // Stop attention animation after 2 seconds
        }, 1500); // Start attention animation after 1.5 seconds
      });
      
      // File upload functionality
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && window.TagManager) {
          window.TagManager.uploadFile(file);
        }
      });
      
      // On page load, show default file if present
      var initialData = document.getElementById('initialData');
      if (initialData) {
        try {
          var data = JSON.parse(initialData.getAttribute('data-initial'));
          if (data && data.filepath) {
            // Show only the file name, not the full path
            var fileName = data.filepath.split(/[\\/]/).pop();
            
            // Update the unified upload container
            if (window.TagManager) {
              window.TagManager.updateUploadUI(fileName, 'File loaded successfully', 'success');
              
              // Add animation class to upload container
              const uploadContainer = document.querySelector('.unified-upload-container');
              if (uploadContainer) {
                uploadContainer.classList.add('file-loaded');
                setTimeout(() => {
                  uploadContainer.classList.remove('file-loaded');
                }, 600);
              }
            }
          }
        } catch (e) {}
      }
      
      // Edit Template Modal functionality
      const editTemplateModal = document.getElementById('editTemplateModal');
      const templateSelectModal = document.getElementById('templateSelectModal');
      const scaleInputModal = document.getElementById('scaleInputModal');
      const fontSelectModal = document.getElementById('fontSelectModal');
      const fontSizingModeModal = document.getElementById('fontSizingModeModal');
      const fieldFontSizesSection = document.getElementById('fieldFontSizesSection');
      const templateSelect = document.getElementById('templateSelect');
      const scaleInput = document.getElementById('scaleInput');
      const fontSelect = document.getElementById('fontSelect');
      const saveTemplateBtn = document.getElementById('saveTemplateBtn');
      
      // Font sizing mode change handler
      if (fontSizingModeModal) {
        fontSizingModeModal.addEventListener('change', function() {
          if (this.value === 'fixed') {
            fieldFontSizesSection.style.display = 'block';
          } else {
            fieldFontSizesSection.style.display = 'none';
          }
          updateTemplatePreview();
        });
      }
      
      // Update preview when any setting changes
      function updateTemplatePreview() {
        const preview = document.getElementById('templatePreviewModal');
        if (!preview) {
          console.error('Template preview container not found!');
          return;
        }
        
        // Get elements with null checks
        const templateSelectModal = document.getElementById('templateSelectModal');
        const scaleInputModal = document.getElementById('scaleInputModal');
        const fontSelectModal = document.getElementById('fontSelectModal');
        const fontSizingModeModal = document.getElementById('fontSizingModeModal');
        
        // Use fallback values if elements are not found
        const templateType = templateSelectModal ? templateSelectModal.value : 'vertical';
        const fontFamily = fontSelectModal ? fontSelectModal.value : 'Arial';
        const scale = scaleInputModal ? scaleInputModal.value : '1.0';
        const fontSizeMode = fontSizingModeModal ? fontSizingModeModal.value : 'auto';
        
        // Get font sizes for fixed mode
        let brandSize = 14;
        let descriptionSize = 16;
        let priceSize = 18;
        let lineageSize = 12;
        
        if (fontSizeMode === 'fixed') {
          const brandElement = document.getElementById('brandFontSize');
          const descriptionElement = document.getElementById('descriptionFontSize');
          const priceElement = document.getElementById('priceFontSize');
          const lineageElement = document.getElementById('lineageFontSize');
          
          if (brandElement) brandSize = brandElement.value || 14;
          if (descriptionElement) descriptionSize = descriptionElement.value || 16;
          if (priceElement) priceSize = priceElement.value || 18;
          if (lineageElement) lineageSize = lineageElement.value || 12;
        }
        
        let previewHtml = `
          <div style="font-family: ${fontFamily}; transform: scale(${scale}); transform-origin: top left;">
            <div style="border: 1px solid #ccc; padding: 8px; margin: 4px; background: white; border-radius: 4px;">
              <div style="font-weight: bold; font-size: ${brandSize}px; color: #333; margin-bottom: 4px;">Sample Brand</div>
              <div style="font-size: ${descriptionSize}px; color: #666; margin-bottom: 4px;">Sample Description Text</div>
              <div style="font-size: ${priceSize}px; font-weight: bold; color: #007bff; margin-bottom: 4px;">$25.00</div>
              <div style="font-size: ${lineageSize}px; color: #28a745; text-transform: uppercase;">HYBRID</div>
            </div>
          </div>
        `;
        
        preview.innerHTML = previewHtml;
        console.log('Template preview updated successfully');
      }
      
      // Add event listeners for preview updates
      const previewElementIds = [
        'templateSelectModal', 'scaleInputModal', 'fontSelectModal', 
        'fontSizingModeModal', 'descriptionFontSize', 'brandFontSize', 
        'priceFontSize', 'lineageFontSize', 'ratioFontSize', 'vendorFontSize'
      ];
      
      previewElementIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', updateTemplatePreview);
          element.addEventListener('input', updateTemplatePreview);
        }
      });
      
      // When modal opens, sync values from main form and update preview
      editTemplateModal.addEventListener('show.bs.modal', function () {
        const templateSelectModal = document.getElementById('templateSelectModal');
        const scaleInputModal = document.getElementById('scaleInputModal');
        const fontSelectModal = document.getElementById('fontSelectModal');
        const fontSizingModeModal = document.getElementById('fontSizingModeModal');
        const templateSelect = document.getElementById('templateSelect');
        const scaleInput = document.getElementById('scaleInput');
        const fontSelect = document.getElementById('fontSelect');
        
        if (templateSelectModal && templateSelect) {
          templateSelectModal.value = templateSelect.value;
        }
        if (scaleInputModal && scaleInput) {
          scaleInputModal.value = scaleInput.value;
        }
        if (fontSelectModal && fontSelect) {
          fontSelectModal.value = fontSelect.value;
        }
        
        // Set default values for new fields
        if (fontSizingModeModal) fontSizingModeModal.value = 'auto';
        if (document.getElementById('lineSpacingModal')) document.getElementById('lineSpacingModal').value = '1.0';
        if (document.getElementById('paragraphSpacingModal')) document.getElementById('paragraphSpacingModal').value = '0';
        
        // Update preview
        setTimeout(updateTemplatePreview, 100);
      });
      
      // When save button is clicked, sync values back to main form
      saveTemplateBtn.addEventListener('click', function () {
        templateSelect.value = templateSelectModal.value;
        scaleInput.value = scaleInputModal.value;
        fontSelect.value = fontSelectModal.value;
        
        // Save additional settings to localStorage for persistence
        const templateSettings = {
          templateType: templateSelectModal.value,
          scale: scaleInputModal.value,
          font: fontSelectModal.value,
          fontSizeMode: fontSizingModeModal ? fontSizingModeModal.value : 'auto',
          lineBreaks: document.getElementById('enableLineBreaksModal')?.checked || true,
          textWrapping: document.getElementById('enableTextWrappingModal')?.checked || true,
          boldHeaders: document.getElementById('enableBoldTextModal')?.checked || false,
          italicDescriptions: document.getElementById('enableItalicTextModal')?.checked || false,
          lineSpacing: document.getElementById('lineSpacingModal')?.value || '1.0',
          paragraphSpacing: document.getElementById('paragraphSpacingModal')?.value || '0',
          textColor: document.getElementById('textColorModal')?.value || '#000000',
          backgroundColor: document.getElementById('backgroundColorModal')?.value || '#ffffff',
          headerColor: document.getElementById('headerColorModal')?.value || '#333333',
          accentColor: document.getElementById('accentColorModal')?.value || '#007bff',
          autoResize: document.getElementById('enableAutoResizeModal')?.checked || true,
          smartTruncation: document.getElementById('enableSmartTruncationModal')?.checked || true,
          optimization: document.getElementById('enableOptimizationModal')?.checked || false,
          fieldFontSizes: {
            description: document.getElementById('descriptionFontSize')?.value || 16,
            brand: document.getElementById('brandFontSize')?.value || 14,
            price: document.getElementById('priceFontSize')?.value || 18,
            lineage: document.getElementById('lineageFontSize')?.value || 12,
            ratio: document.getElementById('ratioFontSize')?.value || 10,
            vendor: document.getElementById('vendorFontSize')?.value || 8
          }
        };
        
        // Save to localStorage for persistence
        localStorage.setItem('templateSettings', JSON.stringify(templateSettings));
        
        // Save to backend for generation
        fetch('/api/template-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(templateSettings)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Template settings saved to backend');
          } else {
            console.warn('Failed to save template settings to backend:', data.error);
          }
        })
        .catch(error => {
          console.error('Error saving template settings to backend:', error);
        });
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(editTemplateModal);
        modal.hide();
        
        // Show success message
        showToast('Template settings saved successfully!', 'success');
      });
      
      // Load saved settings when page loads
      document.addEventListener('DOMContentLoaded', function() {
        const savedSettings = localStorage.getItem('templateSettings');
        if (savedSettings) {
          try {
            const settings = JSON.parse(savedSettings);
            if (templateSelect) templateSelect.value = settings.templateType || 'vertical';
            if (scaleInput) scaleInput.value = settings.scale || '1.0';
            if (fontSelect) fontSelect.value = settings.font || 'Arial';
          } catch (e) {
            console.warn('Failed to load saved template settings:', e);
          }
        }
      });
    });

    // Psychedelic morphing background animation
    document.addEventListener('DOMContentLoaded', function() {
      const colors = [
        'linear-gradient(-45deg, #23192b, #8b5cf6, #43e97b, #a084e8)',
        'linear-gradient(-45deg, #8b5cf6, #43e97b, #a084e8, #ED4123)',
        'linear-gradient(-45deg, #43e97b, #a084e8, #ED4123, #23192b)',
        'linear-gradient(-45deg, #a084e8, #ED4123, #23192b, #8b5cf6)',
        'linear-gradient(-45deg, #ED4123, #23192b, #8b5cf6, #43e97b)',
        'linear-gradient(-45deg, #23192b, #43e97b, #a084e8, #8b5cf6)'
      ];
      
      let currentColor = 0;
      
      function morphBackground() {
        document.body.style.background = colors[currentColor];
        document.body.style.backgroundSize = '300% 300%';
        currentColor = (currentColor + 1) % colors.length;
      }
      
      // Start the animation
      morphBackground();
      setInterval(morphBackground, 15000); // Change every 15 seconds for calmer transitions
    });

    // Database functions
    function openDatabaseStats() {
      fetch('/api/database-stats')
        .then(response => response.json())
        .then(data => {
          // Create a formatted display of the stats
          let statsHtml = `
            <div class="database-stats">
              <h4>Database Statistics</h4>
              <div class="row">
                <div class="col-md-6">
                  <h6>Overview</h6>
                  <ul>
                    <li><strong>Total Products:</strong> ${data.total_products}</li>
                    <li><strong>Total Strains:</strong> ${data.total_strains}</li>
                  </ul>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <h6>Top Strains</h6>
                  <ul>
                    ${data.top_strains.slice(0, 10).map(strain => 
                      `<li><strong>${strain.name}:</strong> ${strain.occurrences} occurrences</li>`
                    ).join('')}
                  </ul>
                </div>
              </div>
            </div>
          `;
          
          // Show in a modal
          showDatabaseModal('Database Statistics', statsHtml);
        })
        .catch(error => {
          console.error('Error fetching database stats:', error);
        });
    }
    
    function openDatabaseView() {
      fetch('/api/database-view')
        .then(response => response.json())
        .then(data => {
          // Create a formatted display of the database contents
          let viewHtml = `
            <div class="database-view">
              <h4>Database Contents</h4>
              <div class="row">
                <div class="col-md-6">
                  <h6>Top Products (${data.total_products} total)</h6>
                  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Type</th>
                          <th>Occurrences</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${data.products.slice(0, 15).map(product => 
                          `<tr>
                            <td>${product.product_name}</td>
                            <td>${product.product_type}</td>
                            <td>${product.total_occurrences}</td>
                          </tr>`
                        ).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="col-md-6">
                  <h6>Top Strains (${data.total_strains} total)</h6>
                  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Strain</th>
                          <th>Lineage</th>
                          <th>Occurrences</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${data.strains.slice(0, 15).map(strain => 
                          `<tr>
                            <td>${strain.strain_name}</td>
                            <td>${strain.canonical_lineage}</td>
                            <td>${strain.total_occurrences}</td>
                          </tr>`
                        ).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Show in a modal
          showDatabaseModal('Database Contents', viewHtml);
        })
        .catch(error => {
          console.error('Error fetching database view:', error);
        });
    }
    
    function exportDatabase() {
      // Modal content for export
      let exportHtml = `
        <div class="database-export">
          <h4>Export Product Database</h4>
          <p class="mb-3">Download the complete product and strain database as an Excel file.<br>
          This export includes all products, strains, lineages, and statistics currently in the system.</p>
          <button id="downloadDbBtn" class="btn btn-modern2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download Excel
          </button>
          <div class="mt-3 small text-muted">File will be named <code>product_database_YYYY-MM-DD_HH-MM-SS.xlsx</code></div>
        </div>
      `;
      showDatabaseModal('Export Database', exportHtml);
      
      // Attach click handler after modal is shown
      setTimeout(() => {
        const btn = document.getElementById('downloadDbBtn');
        if (btn) {
          btn.onclick = function() {
            const link = document.createElement('a');
            // Add cache-busting parameter to ensure fresh data
            const timestamp = new Date().getTime();
            link.href = `/api/database-export?t=${timestamp}`;
            // Let the server set the filename via Content-Disposition header
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            // Database export started
          };
        }
      }, 300);
    }
    
    // Database Editor Functions
    let currentPage = 0;
    const pageSize = 50;
    let allProducts = [];
    let filteredProducts = [];

    function showDatabaseEditor() {
      console.log('Opening Edit DB...');
      const modal = new bootstrap.Modal(document.getElementById('databaseEditorModal'));
      modal.show();
      
      // Load products when modal opens
      loadDatabaseProducts();
      
      // Setup search functionality
      document.getElementById('dbSearchInput').addEventListener('input', function() {
        searchProducts(this.value);
      });
    }

    // Make function globally available
    window.showDatabaseEditor = showDatabaseEditor;

    async function loadDatabaseProducts() {
      try {
        // Add cache-busting parameter to ensure fresh data
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/database-products?t=${timestamp}`);
        const data = await response.json();
        
        if (data.success) {
          allProducts = data.products;
          filteredProducts = [...allProducts];
          
          // Debug: Log some products to check Description values
          console.log('Loaded products sample:');
          allProducts.slice(0, 3).forEach((product, index) => {
            console.log(`${index + 1}. Product: "${product['Product Name*']}"`);
            console.log(`   Description: "${product['Description']}"`);
          });
          
          displayProducts();
          updateResultCount();
        } else {
          throw new Error(data.error || 'Failed to load products');
        }
      } catch (error) {
        console.error('Error loading database products:', error);
        showError('Failed to load database products: ' + error.message);
      }
    }

    function displayProducts() {
      const tbody = document.getElementById('databaseTableBody');
      const startIndex = currentPage * pageSize;
      const endIndex = startIndex + pageSize;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);
      
      tbody.innerHTML = productsToShow.map(product => `
        <tr data-product-id="${product.id}">
          <td>${product.id}</td>
          <td>
            <div class="fw-bold">${product['Product Name*'] || 'N/A'}</div>
            <small class="text-muted">${product['Description'] || 'No description'}</small>
          </td>
          <td><span class="badge bg-info">${product['Product Type*'] || 'N/A'}</span></td>
          <td>${product['Product Brand'] || 'N/A'}</td>
          <td>${product['Vendor/Supplier*'] || 'N/A'}</td>
          <td><span class="badge bg-${getLineageBadgeColor(product.Lineage)}">${product.Lineage || 'N/A'}</span></td>
          <td>${product.Price || 'N/A'}</td>
          <td>${product['Weight*'] || 'N/A'}</td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" onclick="editProduct(${product.id})" title="Edit Product">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete Product">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function searchProducts(searchTerm) {
      if (!searchTerm.trim()) {
        filteredProducts = [...allProducts];
      } else {
        const term = searchTerm.toLowerCase();
        filteredProducts = allProducts.filter(product => 
          (product['Product Name*'] && product['Product Name*'].toLowerCase().includes(term)) ||
          (product['Description'] && product['Description'].toLowerCase().includes(term)) ||
          (product['Product Brand'] && product['Product Brand'].toLowerCase().includes(term)) ||
          (product['Vendor/Supplier*'] && product['Vendor/Supplier*'].toLowerCase().includes(term))
        );
      }
      currentPage = 0;
      displayProducts();
      updateResultCount();
    }

    function updateResultCount() {
      document.getElementById('dbResultCount').textContent = filteredProducts.length;
    }

    function loadMoreProducts() {
      currentPage++;
      displayProducts();
    }

    function addNewProduct() {
      // Open edit modal with empty product
      editProduct(null);
    }

    function editProduct(productId) {
      // This would open an edit modal/form
      console.log('Edit product:', productId);
      alert('Edit functionality coming soon!');
    }

    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        // This would call delete API
        console.log('Delete product:', productId);
        alert('Delete functionality coming soon!');
      }
    }

    function refreshDatabaseTable() {
      currentPage = 0;
      loadDatabaseProducts();
    }

    function exportDatabase() {
      // This would export the current filtered products
      console.log('Export database');
      alert('Export functionality coming soon!');
    }

    // Use the consolidated function from window scope

    function showError(message) {
      const tbody = document.getElementById('databaseTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="text-center text-danger">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
          </td>
        </tr>
      `;
    }
    // Make all database editor functions globally available
    window.loadDatabaseProducts = loadDatabaseProducts;
    window.displayProducts = displayProducts;
    window.searchProducts = searchProducts;
    window.updateResultCount = updateResultCount;
    window.loadMoreProducts = loadMoreProducts;
    window.addNewProduct = addNewProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.refreshDatabaseTable = refreshDatabaseTable;
    window.exportDatabase = exportDatabase;
    window.getLineageBadgeColor = getLineageBadgeColor;
    window.showError = showError;

    function showDatabaseModal(title, content) {
      console.log('showDatabaseModal called with title:', title);
      try {
        // Create modal HTML
      const modalHtml = `
        <div class="modal fade" id="databaseModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content glass-card">
              <div class="modal-header border-0">
                <h5 class="modal-title">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
                    <path d="M3 3v18h18"></path>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                  </svg>
                  ${title}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${content}
              </div>
              <div class="modal-footer border-0">
                <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if present
      const existingModal = document.getElementById('databaseModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add new modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Store the currently focused element before opening modal
      const activeElement = document.activeElement;
      if (activeElement && !document.getElementById('databaseModal').contains(activeElement)) {
        activeElement.setAttribute('data-bs-focus-prev', 'true');
      }
      
      // Show the modal
      const modalElement = document.getElementById('databaseModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } else {
        console.error('Modal element not found');
        alert('Error: Could not create modal');
      }
      } catch (error) {
        console.error('Error in showDatabaseModal:', error);
        alert('Error opening modal: ' + error.message);
      }
    }

    function openDatabaseInfo() {
      // Show loading state
      const loadingHtml = `
        <div class="text-center">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading comprehensive database information...</p>
        </div>
      `;
      showDatabaseModal('Database Information & Analytics', loadingHtml);

      // Fetch all database data
      Promise.all([
        fetch('/api/database-stats').then(r => r.json()),
        fetch('/api/database-view').then(r => r.json()),
        fetch('/api/database-vendor-stats').then(r => r.json()),
        fetch('/api/available-tags').then(r => r.json())
      ])
      .then(([stats, view, vendorStats, availableTags]) => {
        const totalProducts = availableTags.length;
        const totalStrains = stats.total_strains;
        
        const infoHtml = `
          <div class="database-comprehensive-info">
            <div class="row mb-4">
              <div class="col-12">
                <div class="alert alert-info">
                  <h6 class="mb-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg>
                    Database Overview
                  </h6>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-primary">${totalProducts}</h4>
                        <small>Total Products</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-success">${totalStrains}</h4>
                        <small>Unique Strains</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-warning">${vendorStats.summary?.total_vendors || 'N/A'}</h4>
                        <small>Vendors</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-info">${vendorStats.summary?.total_brands || 'N/A'}</h4>
                        <small>Brands</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                      Top Products
                      <button class="btn btn-sm btn-outline-secondary float-end" onclick="sortTable('productsTable', 2)">Sort by Count</button>
                    </h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 300px;">
                      <table class="table table-sm table-hover mb-0" id="productsTable">
                        <thead class="table-dark">
                          <tr>
                            <th>Product Name</th>
                            <th>Type</th>
                            <th>Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${view.products.slice(0, 20).map(product => 
                            `<tr>
                              <td>${product.product_name}</td>
                              <td><span class="badge bg-secondary">${product.product_type}</span></td>
                              <td>${product.total_occurrences}</td>
                            </tr>`
                          ).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                      </svg>
                      Top Strains
                      <button class="btn btn-sm btn-outline-secondary float-end" onclick="sortTable('strainsTable', 2)">Sort by Count</button>
                    </h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 300px;">
                      <table class="table table-sm table-hover mb-0" id="strainsTable">
                        <thead class="table-dark">
                          <tr>
                            <th>Strain Name</th>
                            <th>Lineage</th>
                            <th>Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${view.strains.slice(0, 20).map(strain => 
                            `<tr>
                              <td>${strain.strain_name}</td>
                              <td><span class="badge bg-primary">${strain.canonical_lineage}</span></td>
                              <td>${strain.total_occurrences}</td>
                            </tr>`
                          ).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                      Top Vendors
                      <button class="btn btn-sm btn-outline-secondary float-end" onclick="sortTable('vendorsTable', 1)">Sort by Count</button>
                    </h6>
                  </div>
                  <div class="card-body p-2">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                      <table class="table table-sm table-hover mb-0" id="vendorsTable">
                        <thead class="sticky-top bg-dark">
                          <tr>
                            <th class="text-white">Vendor</th>
                            <th class="text-white">Count</th>
                          </tr>
                        </thead>
                        <tbody>
                                                                ${vendorStats.vendors ? vendorStats.vendors.slice(0, 5).map(vendor => 
                            `<tr>
                                          <td style="color: white !important;">${vendor.vendor}</td>
                                          <td><span class="badge bg-primary text-white">${vendor.product_count}</span></td>
                            </tr>`
                          ).join('') : '<tr><td colspan="2">No vendor data available</td></tr>'}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                      </svg>
                      Top Brands
                      <button class="btn btn-sm btn-outline-secondary float-end" onclick="sortTable('brandsTable', 1)">Sort by Count</button>
                    </h6>
                  </div>
                  <div class="card-body p-2">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                      <table class="table table-sm table-hover mb-0" id="brandsTable">
                        <thead class="sticky-top bg-dark">
                          <tr>
                            <th class="text-white">Brand</th>
                            <th class="text-white">Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${vendorStats.brands ? vendorStats.brands.slice(0, 5).map(brand => 
                            `<tr>
                              <td style="color: white !important;">${brand.brand}</td>
                              <td><span class="badge bg-success text-white">${brand.product_count}</span></td>
                            </tr>`
                          ).join('') : '<tr><td colspan="2">No brand data available</td></tr>'}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                        <path d="M3 3v18h18"></path>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                      </svg>
                      Product Type Distribution
                    </h6>
                  </div>
                                      <div class="card-body p-3">
                      <div class="product-type-grid">
                        ${stats.product_type_distribution ? Object.entries(stats.product_type_distribution).map(([type, count]) => {
                          const percentage = Math.round((count / Object.values(stats.product_type_distribution).reduce((a, b) => a + b, 0)) * 100);
                          const barWidth = Math.max(20, percentage * 2); // Minimum 20px width
                          return `
                            <div class="product-type-item" style="
                              display: flex; 
                              align-items: center; 
                              justify-content: space-between; 
                              padding: 8px 12px; 
                              margin-bottom: 6px; 
                              background: linear-gradient(90deg, rgba(23, 162, 184, 0.1) 0%, rgba(23, 162, 184, 0.05) 100%); 
                              border: 1px solid rgba(23, 162, 184, 0.3); 
                              border-radius: 8px; 
                              transition: all 0.3s ease;
                            ">
                              <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2" style="background-color: #17a2b8 !important; color: white !important; font-size: 0.75rem !important; padding: 0.3rem 0.6rem !important;">${type}</span>
                                <span class="text-white-50" style="font-size: 0.85rem !important;">${count} products</span>
                          </div>
                              <div class="progress-bar-container" style="width: 120px; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                <div class="progress-bar" style="
                                  width: ${barWidth}px; 
                                  height: 100%; 
                                  background: linear-gradient(90deg, #17a2b8, #20c997); 
                                  border-radius: 3px; 
                                  transition: width 0.5s ease;
                                "></div>
                    </div>
                              <span class="text-info" style="font-size: 0.75rem !important; font-weight: 600; min-width: 35px; text-align: right;">${percentage}%</span>
                            </div>
                          `;
                        }).join('') : '<div class="col-12"><p class="text-muted">No product type data available</p></div>'}
                      </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        showDatabaseModal('Database Information & Analytics', infoHtml);
        
        // Force Product Type Distribution height after modal is shown
        setTimeout(() => {
          if (typeof window.forceProductTypeHeight === 'function') {
            window.forceProductTypeHeight();
          }
        }, 200);
      })
      .catch(error => {
        console.error('Error fetching database info:', error);
        const errorHtml = `
          <div class="alert alert-danger">
            <h6>Error Loading Database Information</h6>
            <p>Failed to load comprehensive database information. Please try again.</p>
            <small class="text-muted">Error: ${error.message}</small>
          </div>
        `;
        showDatabaseModal('Database Information & Analytics', errorHtml);
      });
    }

    function sortTable(tableId, columnIndex) {
      const table = document.getElementById(tableId);
      if (!table) return;
      
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Get current sort direction
      const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
      const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
      
      // Sort rows
      rows.sort((a, b) => {
        const aValue = parseInt(a.cells[columnIndex].textContent) || 0;
        const bValue = parseInt(b.cells[columnIndex].textContent) || 0;
        
        if (newDirection === 'asc') {
          return aValue - bValue;
        } else {
          return bValue - aValue;
        }
      });
      
      // Reorder rows
      rows.forEach(row => tbody.appendChild(row));
      
      // Update sort direction
      table.setAttribute('data-sort-direction', newDirection);
      
      // Update button text
      const button = table.closest('.card').querySelector('.btn-outline-secondary');
      if (button) {
        button.textContent = `Sort ${newDirection === 'asc' ? 'Desc' : 'Asc'}`;
      }
    }
    
    // JSON Matching Functions
    function clearJsonMatches() {
      fetch('/api/json-clear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the UI with cleared state
          TagManager.debouncedUpdateAvailableTags(data.available_tags);
          TagManager.updateSelectedTags(data.selected_tags);
          // JSON matches cleared successfully
        } else {
          console.error('Failed to clear JSON matches:', data.error);
        }
      })
      .catch(error => {
        console.error('Error clearing JSON matches:', error);
      });
    }
    
    function performJsonMatch() {
      const jsonUrlInput = document.getElementById('jsonUrlInput');
      const matchBtn = document.querySelector('#jsonMatchModal .btn-modern2');
      const resultsDiv = document.getElementById('jsonMatchResults');
      const matchCount = document.getElementById('matchCount');
      const matchedProductsList = document.getElementById('matchedProductsList');
      
      if (!jsonUrlInput || !matchBtn) {
        console.error('JSON match modal elements not found');
        return;
      }
      
      let jsonUrl = jsonUrlInput.value.trim();
      if (!jsonUrl) {
        console.error('Please enter a JSON URL first.');
        return;
      }

      // Validate URL format
      if (!/^https?:\/\//i.test(jsonUrl)) {
        console.error('Please enter a valid URL starting with http:// or https://');
        return;
      }

      // Show loading state
      matchBtn.disabled = true;
      matchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
      
      // Show progress message
      resultsDiv.classList.remove('d-none');
      matchCount.textContent = 'Processing...';
      matchedProductsList.innerHTML = '<div class="text-info">Matching products from JSON URL. This may take up to 2 minutes for large datasets. Progress will be logged in the browser console.</div>';

      // Add timeout to prevent hanging
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 minutes timeout
      
      // Use the json-match endpoint
      fetch('/api/json-match', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: String(jsonUrl) }),
        signal: controller.signal
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(error => {
            // Handle both string and object error responses
            const errorMessage = typeof error === 'string' ? error : (error.error || 'JSON matching failed');
            throw new Error(errorMessage);
          }).catch(jsonError => {
            // If JSON parsing fails, try to get text response
            return response.text().then(text => {
              throw new Error(`Server error: ${text || 'Unknown error'}`);
            });
          });
        }
        return response.json().catch(jsonError => {
          throw new Error('Invalid JSON response from server');
        });
      })
      .then(matchResult => {
        // Safety check: ensure matchResult is an object
        if (typeof matchResult !== 'object' || matchResult === null) {
          console.error('Invalid matchResult:', matchResult);
          throw new Error('Invalid response format from server');
        }
        
        // Show results
        matchCount.textContent = matchResult.matched_count || 0;
        
        // Populate matched products list with note about where they were added
        if (matchResult.matched_names && matchResult.matched_names.length > 0) {
          matchedProductsList.innerHTML = `
            <div class="alert alert-success mb-3">
              <strong>Success!</strong> ${matchResult.matched_count} products were matched and added to the <strong>Available Tags</strong> list.
              <br>Please review the available tags and select the items you need.
            </div>
            <div class="mb-2"><strong>Matched Products:</strong></div>
            ${matchResult.matched_names
              .map(product => `<div class="mb-1">• ${product}</div>`)
              .join('')}
          `;
        } else {
          matchedProductsList.innerHTML = '<div class="text-muted">No specific product details available</div>';
        }
        
        resultsDiv.classList.remove('d-none');
        
        // Successfully matched products from JSON URL
        
        // Clear the input
        jsonUrlInput.value = '';
        
        // Refresh the UI with new data
        if (typeof TagManager !== 'undefined') {
          console.log('JSON matched products added to available tags for manual selection');
          console.log('Matched names:', matchResult.matched_names);
          console.log('JSON matched tags:', matchResult.json_matched_tags);
          
          // NEW LOGIC: Load JSON matched items directly into selected list for output
          // Instead of putting them in available list, put them directly in selected list
          
          if (matchResult.selected_tags && matchResult.selected_tags.length > 0) {
            console.log('Loading JSON matched products directly into selected tags for output:', matchResult.selected_tags);
            TagManager.updateSelectedTags(matchResult.selected_tags);
            
            // Also update available tags to show the matched items are now selected
            // This provides visual feedback that the items were matched and selected
            TagManager._updateAvailableTags(matchResult.available_tags);
          } else {
            // Fallback: if no selected tags, update available tags as before
            console.log('No selected tags in response, updating available tags with JSON matched items');
            TagManager._updateAvailableTags(matchResult.available_tags);
          }
          
          // Show a notification to the user
          const notificationDiv = document.createElement('div');
          notificationDiv.className = 'alert alert-success alert-dismissible fade show';
          notificationDiv.innerHTML = `
            <strong>JSON Matching Complete!</strong> 
            ${matchResult.matched_count} products were matched and automatically loaded into the <strong>Selected Tags</strong> list for output.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          
          // Insert the notification at the top of the page
          const container = document.querySelector('.container-fluid') || document.querySelector('.container');
          if (container) {
            container.insertBefore(notificationDiv, container.firstChild);
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
              if (notificationDiv.parentNode) {
                notificationDiv.remove();
              }
            }, 10000);
          }
        }
        
        console.log('Available tags updated with JSON matched items');
      }, 500);
    })
    .catch(error => {
      console.error('JSON matching error:', error);
      
      // Show error message to user
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger alert-dismissible fade show';
      errorDiv.innerHTML = `
        <strong>JSON Matching Error!</strong> 
        ${error.message || 'An error occurred during JSON matching. Please try again.'}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Insert the error at the top of the page
      const container = document.querySelector('.container-fluid') || document.querySelector('.container');
      if (container) {
        container.insertBefore(errorDiv, container.firstChild);
        
        // Auto-dismiss after 10 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.remove();
          }
        }, 10000);
      }
      
      // Reset UI state
      matchCount.textContent = '0';
      matchedProductsList.innerHTML = '<div class="text-muted">No products matched</div>';
      resultsDiv.classList.add('d-none');
    });
    
    // Reset button state
    matchBtn.disabled = false;
    matchBtn.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      Match Products
    `;
    }

    // Test function to debug strain search
    window.testStrainSearch = function() {
      console.log('🧪 Testing strain search API...');
      
      // Test with a known vendor
      const testVendor = 'LIFTED CANNABIS';
      const testSearch = 'metaverse';
      
      console.log('🧪 Test vendor:', testVendor);
      console.log('🧪 Test search term:', testSearch);
      
      const testUrl = `/api/products/search?vendor=${encodeURIComponent(testVendor)}&q=${encodeURIComponent(testSearch)}`;
      console.log('🧪 Test URL:', testUrl);
      
      fetch(testUrl)
        .then(response => {
          console.log('🧪 Response status:', response.status);
          console.log('🧪 Response headers:', response.headers);
          return response.json();
        })
        .then(data => {
          console.log('🧪 Test API response:', data);
          console.log('🧪 Response structure:', {
            hasError: !!data.error,
            hasStrains: !!data.strains,
            strainsType: typeof data.strains,
            strainsLength: data.strains ? data.strains.length : 'null',
            totalFound: data.total_found,
            vendor: data.vendor,
            searchTerm: data.search_term
          });
        })
        .catch(error => {
          console.error('🧪 Test API error:', error);
        });
    };

    // Detailed JSON matching with before/after comparison
    window.performDetailedJsonMatch = function() {
      const jsonUrlInput = document.getElementById('jsonUrlInput');
      const detailedModal = new bootstrap.Modal(document.getElementById('detailedJsonMatchModal'));
      
      if (!jsonUrlInput) {
        console.error('JSON URL input not found');
        return;
      }
      
      let jsonUrl = jsonUrlInput.value.trim();
      if (!jsonUrl) {
        alert('Please enter a JSON URL first.');
        return;
      }

      // Validate URL format
      if (!/^https?:\/\//i.test(jsonUrl)) {
        alert('Please enter a valid URL starting with http:// or https://');
        return;
      }
      
      // Show detailed modal with loading state
      detailedModal.show();
      document.getElementById('detailedMatchResults').classList.add('d-none');
      document.getElementById('detailedMatchLoading').classList.remove('d-none');
      
      // Call detailed matching API
      fetch('/api/json-match-detailed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: String(jsonUrl) })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(error => {
            throw new Error(error.error || 'Detailed matching failed');
          });
        }
        return response.json();
      })
      .then(result => {
        displayDetailedMatchResults(result);
        document.getElementById('detailedMatchResults').classList.remove('d-none');
        document.getElementById('detailedMatchLoading').classList.add('d-none');
      })
      .catch(error => {
        console.error('Detailed matching error:', error);
        document.getElementById('detailedMatchLoading').innerHTML = `
          <div class="alert alert-danger">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
      });
    };
    
    window.displayDetailedMatchResults = function(result) {
      const matchSummary = document.getElementById('matchSummary');
      const matchComparisons = document.getElementById('matchComparisons');
      const acceptAllBtn = document.getElementById('acceptAllBtn');
      
      console.log('Processing detailed match results...', result);
      
      // Update summary with database-priority information
      const thresholdDisplay = typeof result.threshold === 'string' ? result.threshold : `${((result.threshold || 0.7) * 100).toFixed(0)}% confidence`;
      
      matchSummary.innerHTML = `
        <div class="row g-3">
          <div class="col-4">
            <div class="card bg-primary bg-opacity-10 border-primary">
              <div class="card-body text-center">
                <h3 class="text-primary mb-0">${result.total_json_items || 0}</h3>
                <small class="text-muted">JSON Items</small>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card bg-success bg-opacity-10 border-success">
              <div class="card-body text-center">
                <h3 class="text-success mb-0">${result.total_matches || 0}</h3>
                <small class="text-muted">Database Matches</small>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card bg-info bg-opacity-10 border-info">
              <div class="card-body text-center">
                <h3 class="text-info mb-0">100%</h3>
                <small class="text-muted">DB Data</small>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <strong>Approach:</strong> ${result.approach || 'Database Priority'}<br>
            <strong>Data Source:</strong> ${result.data_source || '100% Database-derived information'}
          </small>
        </div>
      `;
      
      // Clear previous comparisons
      matchComparisons.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading matches...</span></div><p class="mt-2">Processing match results...</p></div>';
      
      // Process matches in batches to prevent freezing
      const matches = result.detailed_matches || [];
      console.log(`Processing ${matches.length} matches in batches...`);
      
      if (matches.length === 0) {
        matchComparisons.innerHTML = '<div class="alert alert-warning">No matches to display.</div>';
        return;
      }
      
      // Clear the loading state
      matchComparisons.innerHTML = '';
      
      // Process matches in smaller batches with delays
      const batchSize = 5; // Process 5 matches at a time
      let currentBatch = 0;
      
      function processBatch() {
        const start = currentBatch * batchSize;
        const end = Math.min(start + batchSize, matches.length);
        
        console.log(`Processing batch ${currentBatch + 1}: matches ${start + 1}-${end} of ${matches.length}`);
        
        for (let i = start; i < end; i++) {
          const match = matches[i];
          
          // Safe score handling for database-priority format
          let scoreDisplay = 'N/A';
          if (match.best_score !== undefined && match.best_score !== null) {
            if (typeof match.best_score === 'number') {
              scoreDisplay = `${(match.best_score * 100).toFixed(1)}%`;
            } else {
              scoreDisplay = String(match.best_score);
            }
          }
          
          const cardClass = match.is_match ? 'border-success' : 'border-warning';
          const statusBadge = match.is_match ? 
            `<span class="badge bg-success">✓ Database Match (${scoreDisplay})</span>` :
            `<span class="badge bg-warning">⚠ No Database Match</span>`;
          
          const matchCard = document.createElement('div');
          matchCard.className = 'col-12 mb-3';
          matchCard.innerHTML = `
            <div class="card ${cardClass}">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Match ${i + 1}</strong>
                ${statusBadge}
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-info">📥 From JSON:</h6>
                    <div class="bg-info bg-opacity-10 p-3 rounded">
                      <strong>${match.json_name || 'Unknown'}</strong>
                      <div class="mt-2">
                        <small class="text-muted">
                          Brand: ${(match.json_data && match.json_data.brand) || 'N/A'}<br>
                          Vendor: ${(match.json_data && match.json_data.vendor) || 'N/A'}<br>
                          Type: ${(match.json_data && match.json_data.inventory_type) || 'N/A'}
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-success">� Database Match (100% DB Data):</h6>
                    ${match.best_match ? `
                      <div class="bg-success bg-opacity-10 p-3 rounded">
                        <strong>${match.best_match['Product Name*'] || match.best_match['ProductName'] || 'Enhanced Match'}</strong>
                        <div class="mt-2">
                          <small class="text-muted">
                            <strong>Price:</strong> $${match.best_match['Price'] || '25.00'}<br>
                            <strong>Brand:</strong> ${match.best_match['Product Brand'] || 'CERES'}<br>
                            <strong>Type:</strong> ${match.best_match['Product Type*'] || 'Edible (Solid)'}<br>
                            <strong>Weight:</strong> ${match.best_match['Weight*'] || '1'}${match.best_match['Units'] || 'g'}<br>
                            <strong>Source:</strong> ${match.source || 'Database Priority (100% DB)'}<br>
                            <strong>Confidence:</strong> ${match.match_confidence || (match.best_score ? (typeof match.best_score === 'number' ? `${(match.best_score * 100).toFixed(1)}%` : match.best_score) : 'N/A')}
                          </small>
                        </div>
                      </div>
                    ` : `
                      <div class="bg-secondary bg-opacity-10 p-3 rounded">
                        <em>No suitable match found</em>
                      </div>
                    `}
                  </div>
                </div>
                
                ${match.top_candidates && match.top_candidates.length > 1 ? `
                  <div class="mt-3">
                    <h6 class="text-muted">Top Alternative Matches:</h6>
                    <div class="row">
                      ${match.top_candidates.slice(1, 4).map(candidate => `
                        <div class="col-md-4">
                          <div class="card card-body bg-light bg-opacity-50 border-0">
                            <div class="small">
                              <strong>${candidate.excel_name || 'Unknown'}</strong><br>
                              <span class="text-muted">Score: ${(candidate.score * 100).toFixed(1)}%</span>
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
          matchComparisons.appendChild(matchCard);
        }
        
        currentBatch++;
        
        // If there are more batches, process them with a small delay
        if (end < matches.length) {
          setTimeout(processBatch, 50); // 50ms delay between batches
        } else {
          // All batches processed, enable accept button
          console.log('All matches processed successfully');
          if (result.total_matches > 0) {
            acceptAllBtn.disabled = false;
            acceptAllBtn.setAttribute('data-matches', JSON.stringify(result.high_confidence_matches || []));
          }
        }
      }
      
      // Start processing the first batch
      processBatch();
    }
    
    window.acceptAllMatches = function() {
      const acceptAllBtn = document.getElementById('acceptAllBtn');
      const matchesData = acceptAllBtn.getAttribute('data-matches');
      
      if (!matchesData) {
        alert('No match data available');
        return;
      }
      
      try {
        const matches = JSON.parse(matchesData);
        
        // Update the UI with the accepted matches
        if (typeof TagManager !== 'undefined') {
          TagManager.updateSelectedTags(matches);
          
          // Show success notification
          const notification = document.createElement('div');
          notification.className = 'alert alert-success alert-dismissible fade show';
          notification.innerHTML = `
            <strong>Matches Accepted!</strong> ${matches.length} high-quality matches have been added to your selected tags.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          
          const container = document.querySelector('.container-fluid') || document.querySelector('.container');
          if (container) {
            container.insertBefore(notification, container.firstChild);
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 5000);
          }
        }
        
        // Close the detailed modal
        const detailedModal = bootstrap.Modal.getInstance(document.getElementById('detailedJsonMatchModal'));
        if (detailedModal) {
          detailedModal.hide();
        }
        
        // Close the main JSON match modal too
        const mainModal = bootstrap.Modal.getInstance(document.getElementById('jsonMatchModal'));
        if (mainModal) {
          mainModal.hide();
        }
        
        console.log(`Accepted ${matches.length} high-quality matches`);
        
      } catch (error) {
        console.error('Error accepting matches:', error);
        alert('Error processing matches');
      }
    }
    
    window.selectCustomMatches = function() {
      alert('Custom selection feature coming soon! For now, please use the individual match cards to review specific items.');
    }

    // Allow Enter key to trigger the match in modal
    document.addEventListener('DOMContentLoaded', function() {
      const jsonUrlInput = document.getElementById('jsonUrlInput');
      if (jsonUrlInput) {
        jsonUrlInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performJsonMatch();
          }
        });
      }
    });
    
    // Debug help button functionality
    document.addEventListener('DOMContentLoaded', function() {
      const helpBtn = document.getElementById('help-btn');
      if (helpBtn) {
        console.log('Help button found:', helpBtn);
        helpBtn.addEventListener('click', function(e) {
          console.log('Help button clicked!');
          console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
          console.log('Modal element:', document.getElementById('helpModal'));
          
          // Store the currently focused element before opening modal
          const activeElement = document.activeElement;
          if (activeElement && !document.getElementById('helpModal').contains(activeElement)) {
            activeElement.setAttribute('data-bs-focus-prev', 'true');
          }
          
          // Try to manually trigger the modal
          try {
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
            console.log('Modal shown successfully');
          } catch (error) {
            console.error('Error showing modal:', error);
          }
        });
      } else {
        console.error('Help button not found!');
      }
    });

    // Function to close help modal
    function closeHelpModal() {
      const modalElement = document.getElementById('helpModal');
      if (!modalElement) return;
      
      // Try Bootstrap modal first
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) {
        modal.hide();
      }
      
      // Force cleanup regardless of Bootstrap success
      setTimeout(() => {
        // Remove modal classes
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Restore focus to previously focused element
        const previouslyFocusedElement = document.querySelector('[data-bs-focus-prev]');
        if (previouslyFocusedElement) {
          previouslyFocusedElement.focus();
          previouslyFocusedElement.removeAttribute('data-bs-focus-prev');
        }
        
        // Remove body classes
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        
        // Remove all modal backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Remove any remaining overlay elements
        const overlays = document.querySelectorAll('.modal-overlay, .modal-backdrop');
        overlays.forEach(overlay => overlay.remove());
        
        // Force page to be interactive again
        document.body.style.pointerEvents = '';
        
        console.log('Help modal forcefully closed');
      }, 100);
    }

    // Add keyboard event listener to close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeHelpModal();
        // Also try to close any other open modals
        const openModals = document.querySelectorAll('.modal.show');
        openModals.forEach(modal => {
          const modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          }
        });
        
        // Clear all filters when ESC key is pressed
        if (typeof TagManager !== 'undefined' && TagManager.clearAllFilters) {
          TagManager.clearAllFilters();
        }
      }
    });

    // Add click event listener to close modal when clicking outside
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal') && event.target.classList.contains('show')) {
        closeHelpModal();
      }
    });

    // Emergency cleanup function - can be called from browser console
    window.emergencyModalCleanup = function() {
      console.log('Emergency modal cleanup initiated');
      
      // Remove all modal-related classes from body
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
      document.body.style.overflow = '';
      document.body.style.pointerEvents = '';
      
      // Hide all modals
      const allModals = document.querySelectorAll('.modal');
      allModals.forEach(modal => {
        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      });
      
      // Restore focus to previously focused element
      const previouslyFocusedElement = document.querySelector('[data-bs-focus-prev]');
      if (previouslyFocusedElement) {
        previouslyFocusedElement.focus();
        previouslyFocusedElement.removeAttribute('data-bs-focus-prev');
      }
      
      // Remove all backdrops
      const allBackdrops = document.querySelectorAll('.modal-backdrop, .modal-overlay');
      allBackdrops.forEach(backdrop => backdrop.remove());
      
      console.log('Emergency cleanup completed');
    };
    // Enhanced modal accessibility handling for all modals
    function setupModalAccessibility(modal) {
              // Remove existing listeners to prevent duplicates
        modal.removeEventListener('show.bs.modal', modal._accessibilityShowHandler);
        modal.removeEventListener('shown.bs.modal', modal._accessibilityShownHandler);
        modal.removeEventListener('hidden.bs.modal', modal._accessibilityHideHandler);
      
              // Create new handlers
        modal._accessibilityShowHandler = function() {
          // Store the currently focused element before opening modal
          const activeElement = document.activeElement;
          if (activeElement && !modal.contains(activeElement)) {
            activeElement.setAttribute('data-bs-focus-prev', 'true');
          }
          
          console.log('Modal show event triggered:', this.id);
        };
        
        modal._accessibilityShownHandler = function() {
          // Remove inert when modal is fully shown
          this.removeAttribute('inert');
          
          // Ensure aria-hidden is not set to prevent warnings
          this.removeAttribute('aria-hidden');
          
          console.log('Modal shown with accessibility fix:', this.id);
        };
      
      modal._accessibilityHideHandler = function() {
        // First, ensure focus is moved outside the modal BEFORE setting aria-hidden
        const previouslyFocusedElement = document.querySelector('[data-bs-focus-prev]');
        if (previouslyFocusedElement) {
          previouslyFocusedElement.focus();
          previouslyFocusedElement.removeAttribute('data-bs-focus-prev');
          console.log('Focus restored to:', previouslyFocusedElement);
        } else {
          // If no previously focused element, move focus to a safe location
          const triggerButton = document.querySelector(`[data-bs-target="#${this.id}"]`);
          if (triggerButton) {
            triggerButton.focus();
            console.log('Focus moved to trigger button:', triggerButton);
          } else {
            // Last resort: move focus to body
            document.body.focus();
            console.log('Focus moved to body as fallback');
          }
        }
        
        // Use a small delay to ensure focus is completely moved before setting attributes
        setTimeout(() => {
          // Use inert attribute instead of aria-hidden for better accessibility
          // The inert attribute prevents focus and interaction
          this.setAttribute('inert', '');
          
          // Remove aria-hidden to prevent the warning - inert is sufficient
          this.removeAttribute('aria-hidden');
          
          console.log('Modal hidden with accessibility fix:', this.id);
        }, 50);
      };
      
              // Add event listeners
        modal.addEventListener('show.bs.modal', modal._accessibilityShowHandler);
        modal.addEventListener('shown.bs.modal', modal._accessibilityShownHandler);
        modal.addEventListener('hidden.bs.modal', modal._accessibilityHideHandler);
    }
    
    // Setup accessibility immediately for any existing modals
    const existingModals = document.querySelectorAll('.modal');
    existingModals.forEach(setupModalAccessibility);
    
    // Additional fix for close buttons to prevent focus retention
    function setupCloseButtonAccessibility() {
      const closeButtons = document.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]');
      closeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          // Prevent the close button from retaining focus
          setTimeout(() => {
            if (this === document.activeElement) {
              // Move focus to a safe location if the close button still has focus
              const modal = this.closest('.modal');
              if (modal) {
                const triggerButton = document.querySelector(`[data-bs-target="#${modal.id}"]`);
                if (triggerButton) {
                  triggerButton.focus();
                } else {
                  document.body.focus();
                }
              }
            }
          }, 10);
        });
      });
    }
    
    // Setup close button accessibility
    setupCloseButtonAccessibility();
    
    // Polyfill for inert attribute if not supported
    if (!HTMLElement.prototype.hasOwnProperty('inert')) {
      Object.defineProperty(HTMLElement.prototype, 'inert', {
        get: function() {
          return this.hasAttribute('inert');
        },
        set: function(value) {
          if (value) {
            this.setAttribute('inert', '');
            this.style.pointerEvents = 'none';
            this.setAttribute('tabindex', '-1');
          } else {
            this.removeAttribute('inert');
            this.style.pointerEvents = '';
            this.removeAttribute('tabindex');
          }
        }
      });
    }
    
    // Also setup when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      
      // Setup accessibility for existing modals
      const modals = document.querySelectorAll('.modal');
      modals.forEach(setupModalAccessibility);
      
      // Setup close button accessibility
      setupCloseButtonAccessibility();
      
      // Watch for dynamically added modals
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              // Check if the added node is a modal
              if (node.classList && node.classList.contains('modal')) {
                setupModalAccessibility(node);
              }
              // Check for modals within the added node
              const modalsInNode = node.querySelectorAll ? node.querySelectorAll('.modal') : [];
              modalsInNode.forEach(setupModalAccessibility);
            }
          });
        });
      });
      
      // Start observing
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // Additional observer to watch for aria-hidden changes on visible modals
      const ariaObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'aria-hidden') {
            const modal = mutation.target;
            if (modal.classList.contains('modal') && 
                modal.classList.contains('show') && 
                modal.getAttribute('aria-hidden') === 'true') {
              // Remove aria-hidden from visible modals
              modal.removeAttribute('aria-hidden');
              console.log('Removed aria-hidden from visible modal:', modal.id);
            }
          }
        });
      });
      
      // Observe all modals for aria-hidden changes
      const allModals = document.querySelectorAll('.modal');
      allModals.forEach(modal => {
        ariaObserver.observe(modal, {
          attributes: true,
          attributeFilter: ['aria-hidden']
        });
      });
    });
  </script>
  
  <!-- Backup function definition for performDetailedJsonMatch -->
  <script>
    // Backup definition in case the main script has issues
    if (typeof window.performDetailedJsonMatch === 'undefined') {
      console.warn('performDetailedJsonMatch not found, creating backup definition');
      window.performDetailedJsonMatch = function() {
        const jsonUrlInput = document.getElementById('jsonUrlInput');
        
        if (!jsonUrlInput) {
          console.error('JSON URL input not found');
          alert('JSON URL input field not found. Please refresh the page.');
          return;
        }
        
        let jsonUrl = jsonUrlInput.value.trim();
        if (!jsonUrl) {
          alert('Please enter a JSON URL first.');
          return;
        }

        // Validate URL format
        if (!/^https?:\/\//i.test(jsonUrl)) {
          alert('Please enter a valid URL starting with http:// or https://');
          return;
        }
        
        // Show detailed modal with loading state
        const detailedModal = document.getElementById('detailedJsonMatchModal');
        if (!detailedModal) {
          alert('Detailed match modal not found. Please refresh the page.');
          return;
        }
        
        const modal = new bootstrap.Modal(detailedModal);
        const resultsDiv = detailedModal.querySelector('#detailedMatchResults');
        
        // Show loading state
        resultsDiv.innerHTML = `
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Performing detailed JSON matching...</p>
          </div>
        `;
        
        modal.show();
        
        // Make API call
        fetch('/api/json-match-detailed', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url: jsonUrl })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(result => {
          if (window.displayDetailedMatchResults) {
            window.displayDetailedMatchResults(result);
          } else {
            // Fallback display
            resultsDiv.innerHTML = `
              <div class="alert alert-info">
                <h5>Detailed Match Results</h5>
                <p>Found ${result.matches ? result.matches.length : 0} matches</p>
                <pre>${JSON.stringify(result, null, 2)}</pre>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Detailed match error:', error);
          resultsDiv.innerHTML = `
            <div class="alert alert-danger">
              <strong>Error:</strong> ${error.message}
            </div>
          `;
        });
      };
    }
    
    // Backup definition for displayDetailedMatchResults
    if (typeof window.displayDetailedMatchResults === 'undefined') {
      console.warn('displayDetailedMatchResults not found, creating backup definition');
      window.displayDetailedMatchResults = function(result) {
        const resultsDiv = document.getElementById('detailedMatchResults');
        if (!resultsDiv) {
          console.error('Results div not found');
          return;
        }
        
        // Handle both old and new response formats
        const matches = result.detailed_matches || result.matches || [];
        
        if (!result || matches.length === 0) {
          resultsDiv.innerHTML = `
            <div class="alert alert-warning">
              <strong>No Results:</strong> No matches found or invalid response.
            </div>
          `;
          return;
        }
        
        const matchesHtml = matches.map((match, index) => {
          // Safe score handling for both formats
          let scoreDisplay = 'N/A';
          if (match.best_score !== undefined && match.best_score !== null) {
            if (typeof match.best_score === 'number') {
              scoreDisplay = `${(match.best_score * 100).toFixed(1)}%`;
            } else {
              scoreDisplay = String(match.best_score);
            }
          }
          
          const cardClass = match.is_match ? 'border-success' : 'border-warning';
          const statusBadge = match.is_match ? 
            `<span class="badge bg-success">✓ Database Match (${scoreDisplay})</span>` :
            `<span class="badge bg-warning">⚠ No Database Match</span>`;
          
          return `
            <div class="col-12 mb-3">
              <div class="card ${cardClass}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>Match ${index + 1}</strong>
                  ${statusBadge}
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-info">📥 From JSON:</h6>
                      <div class="bg-info bg-opacity-10 p-3 rounded">
                        <strong>${match.json_name || 'Unknown'}</strong>
                        <div class="mt-2">
                          <small class="text-muted">
                            Brand: ${(match.json_data && match.json_data.brand) || 'N/A'}<br>
                            Vendor: ${(match.json_data && match.json_data.vendor) || 'N/A'}<br>
                            Type: ${(match.json_data && match.json_data.inventory_type) || 'N/A'}
                          </small>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-success">� Database Match (100% DB Data):</h6>
                      ${match.best_match ? `
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                          <strong>${match.best_match['Product Name*'] || match.best_match['ProductName'] || 'Enhanced Match'}</strong>
                          <div class="mt-2">
                            <small class="text-muted">
                              <strong>Price:</strong> $${match.best_match['Price'] || '25.00'}<br>
                              <strong>Brand:</strong> ${match.best_match['Product Brand'] || 'CERES'}<br>
                              <strong>Type:</strong> ${match.best_match['Product Type*'] || 'Edible (Solid)'}<br>
                              <strong>Source:</strong> ${match.source || 'Database Priority (100% DB)'}<br>
                              <strong>Confidence:</strong> ${match.match_confidence || scoreDisplay}
                            </small>
                          </div>
                        </div>
                      ` : `
                        <div class="bg-secondary bg-opacity-10 p-3 rounded">
                          <em>No database match found</em>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        resultsDiv.innerHTML = `
          <div class="container-fluid">
            <div class="row mb-3">
              <div class="col-12">
                <div class="alert alert-info">
                  <strong>Summary:</strong> Found ${result.matches.length} items in JSON. 
                  ${result.matches.filter(m => m.is_match).length} matched above threshold.
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="text-center p-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                  </div>
                  <p class="mt-2">Processing ${result.matches.length} matches...</p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Process matches in batches to prevent freezing
        setTimeout(() => {
          const matchesContainer = resultsDiv.querySelector('.row:last-child');
          matchesContainer.innerHTML = '';
          
          const batchSize = 3;
          let currentBatch = 0;
          
          function processBatch() {
            const start = currentBatch * batchSize;
            const end = Math.min(start + batchSize, result.matches.length);
            
            for (let i = start; i < end; i++) {
              const match = result.matches[i];
              const cardClass = match.is_match ? 'border-success' : 'border-warning';
              const statusBadge = match.is_match ? 
                `<span class="badge bg-success">✓ Matched (${((match.best_score || 0) * 100).toFixed(1)}%)</span>` :
                `<span class="badge bg-warning">⚠ Below Threshold (${((match.best_score || 0) * 100).toFixed(1)}%)</span>`;
              
              const matchDiv = document.createElement('div');
              matchDiv.className = 'col-12 mb-3';
              matchDiv.innerHTML = `
                <div class="card ${cardClass}">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Match ${i + 1}</strong>
                    ${statusBadge}
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="text-info">📥 From JSON:</h6>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                          <strong>${match.json_name || 'Unknown'}</strong>
                          <div class="mt-2">
                            <small class="text-muted">
                              Brand: ${(match.json_data && match.json_data.brand) || 'N/A'}<br>
                              Vendor: ${(match.json_data && match.json_data.vendor) || 'N/A'}<br>
                              Type: ${(match.json_data && match.json_data.inventory_type) || 'N/A'}
                            </small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <h6 class="text-success">📊 Best Excel Match:</h6>
                        ${match.best_match ? `
                          <div class="bg-success bg-opacity-10 p-3 rounded">
                            <strong>${match.best_match['Product Name*'] || 'Unknown'}</strong>
                            <div class="mt-2">
                              <small class="text-muted">
                                Vendor: ${match.best_match['Vendor/Supplier*'] || 'N/A'}<br>
                                Type: ${match.best_match['Product Type*'] || 'N/A'}<br>
                                Score: ${((match.best_score || 0) * 100).toFixed(1)}%
                              </small>
                            </div>
                          </div>
                        ` : `
                          <div class="bg-secondary bg-opacity-10 p-3 rounded">
                            <em>No suitable match found</em>
                          </div>
                        `}
                      </div>
                    </div>
                  </div>
                </div>
              `;
              matchesContainer.appendChild(matchDiv);
            }
            
            currentBatch++;
            
            if (end < result.matches.length) {
              setTimeout(processBatch, 100);
            } else {
              console.log('Backup function: All matches processed');
            }
          }
          
          processBatch();
        }, 100);
      };
    }
  </script>
  
  <!-- JSON Match Modal -->
  <div class="modal fade" id="jsonMatchModal" tabindex="-1" aria-labelledby="jsonMatchModalLabel" inert>
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="jsonMatchModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            JSON Product Matching
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close JSON match modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <h6 class="text-info mb-3">🔗 Match Products from JSON URL</h6>
            <p class="mb-3">Paste a JSON URL containing inventory transfer data to automatically match and select products from your loaded Excel file.</p>
            
            <div class="mb-3">
              <label for="jsonUrlInput" class="form-label">JSON URL:</label>
              <input type="url" class="form-control form-control-modern" id="jsonUrlInput" 
                     placeholder="https://example.com/inventory-transfer.json" 
                     autocomplete="off" required>
              <div class="form-text">Must be a valid HTTP/HTTPS URL containing inventory transfer JSON data</div>
            </div>
            
            <button type="button" class="btn btn-modern2" onclick="performJsonMatch()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Quick Match
            </button>
            
            <button type="button" class="btn btn-outline-primary ms-2" onclick="performDetailedJsonMatch()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
              </svg>
              Detailed Match & Review
            </button>
             
             <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="testStrainSearch()" title="Test strain search API">
               <i class="bi bi-bug me-1"></i>Test API
             </button>
            

          </div>
          
          <div id="jsonMatchResults" class="d-none">
            <h6 class="text-success mb-3">✅ Matching Results</h6>
            <div class="alert alert-success">
              <strong id="matchCount">0</strong> products matched and selected
            </div>
            <div class="mb-3">
              <label class="form-label">Matched Products:</label>
              <div id="matchedProductsList" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.1);">
                <!-- Matched products will be listed here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed JSON Match Comparison Modal -->
  <div class="modal fade" id="detailedJsonMatchModal" tabindex="-1" aria-labelledby="detailedJsonMatchModalLabel" inert>
    <div class="modal-dialog modal-xl">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="detailedJsonMatchModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
            Detailed JSON Match Results
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close detailed match modal"></button>
        </div>
        <div class="modal-body">
          <div id="detailedMatchResults" class="d-none">
            <div class="alert alert-info mb-4">
              <strong>Before & After Comparison</strong><br>
              Review each JSON item and its best match from your Excel data. Only matches with score ≥ 0.4 are included.
            </div>
            
            <div class="mb-3">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-info">📋 Summary</h6>
                  <div id="matchSummary">Loading...</div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-success me-2" onclick="acceptAllMatches()" id="acceptAllBtn" disabled>
                      <i class="bi bi-check-circle me-1"></i>Accept All Matches
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="selectCustomMatches()">
                      <i class="bi bi-pencil me-1"></i>Select Custom
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="matchComparisons" class="row">
              <!-- Match comparisons will be populated here -->
            </div>
          </div>
          
          <div id="detailedMatchLoading" class="text-center py-5">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Loading detailed matches...</span>
            </div>
            <p class="mt-3">Analyzing matches and calculating scores...</p>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Inventory Modal -->
  <div class="modal fade" id="jsonInventoryModal" tabindex="-1" aria-labelledby="jsonInventoryModalLabel" inert>
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="jsonInventoryModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            JSON Inventory Slips
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close JSON inventory modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <h6 class="text-info mb-3">📋 Generate Inventory Slips from JSON</h6>
            <p class="mb-3">Paste a JSON URL containing inventory transfer data to generate inventory slip documents directly from the JSON data.</p>
            
            <div class="mb-3">
              <label for="jsonInventoryUrlInput" class="form-label">JSON URL:</label>
              <input type="url" class="form-control form-control-modern" id="jsonInventoryUrlInput" 
                     placeholder="https://example.com/inventory-transfer.json" 
                     autocomplete="off" required>
              <div class="form-text">Must be a valid HTTP/HTTPS URL containing inventory transfer JSON data</div>
            </div>
            
            <button type="button" class="btn btn-modern2" onclick="generateJsonInventory()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Generate Inventory Slips
            </button>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Product Entry Modal -->
  <div class="modal fade" id="manualProductModal" tabindex="-1" aria-labelledby="manualProductModalLabel" inert>
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="manualProductModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-success">
              <path d="M12 5v14M5 12h14"></path>
            </svg>
            Add New Product
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close manual product modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <h6 class="text-success mb-3">➕ Create New Product Tag</h6>
            <p class="mb-3">Manually add a new product to create labels for brand new items not in your database.</p>
            
            <form id="manualProductForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productName" class="form-label">Product Name *</label>
                  <input type="text" class="form-control form-control-modern" id="productName" 
                         placeholder="e.g., Blue Dream Flower" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productVendor" class="form-label">Vendor *</label>
                  <input type="text" class="form-control form-control-modern" id="productVendor" 
                         placeholder="e.g., Test Vendor" required>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productType" class="form-label">Product Type *</label>
                  <select class="form-select form-select-modern" id="productType" required>
                    <option value="">Select Type</option>
                    <option value="Flower">Flower</option>
                    <option value="Concentrate">Concentrate</option>
                    <option value="Edible">Edible</option>
                    <option value="Vape Cartridge">Vape Cartridge</option>
                    <option value="Tincture">Tincture</option>
                    <option value="Topical">Topical</option>
                    <option value="Pre-roll">Pre-roll</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productWeight" class="form-label">Weight *</label>
                  <input type="text" class="form-control form-control-modern" id="productWeight" 
                         placeholder="e.g., 3.5g, 1g, 100mg" required>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productPrice" class="form-label">Price *</label>
                  <input type="text" class="form-control form-control-modern" id="productPrice" 
                         placeholder="e.g., $25.00" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productBrand" class="form-label">Product Brand</label>
                  <input type="text" class="form-control form-control-modern" id="productBrand" 
                         placeholder="e.g., Test Brand">
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productStrain" class="form-label">Product Strain</label>
                  <input type="text" class="form-control form-control-modern" id="productStrain" 
                         placeholder="e.g., Blue Dream">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productLineage" class="form-label">Lineage</label>
                  <select class="form-select form-select-modern" id="productLineage">
                    <option value="MIXED">MIXED</option>
                    <option value="SATIVA">SATIVA</option>
                    <option value="INDICA">INDICA</option>
                    <option value="HYBRID">HYBRID</option>
                    <option value="HYBRID/SATIVA">HYBRID/SATIVA</option>
                    <option value="HYBRID/INDICA">HYBRID/INDICA</option>
                    <option value="CBD">CBD</option>
                    <option value="PARA">PARA</option>
                  </select>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productThc" class="form-label">THC Test Result</label>
                  <input type="text" class="form-control form-control-modern" id="productThc" 
                         placeholder="e.g., 18.5%">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productCbd" class="form-label">CBD Test Result</label>
                  <input type="text" class="form-control form-control-modern" id="productCbd" 
                         placeholder="e.g., 0.8%">
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productRatio" class="form-label">Ratio</label>
                  <input type="text" class="form-control form-control-modern" id="productRatio" 
                         placeholder="e.g., 1:1">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productDoh" class="form-label">DOH Compliant</label>
                  <select class="form-select form-select-modern" id="productDoh">
                    <option value="NO">NO</option>
                    <option value="YES">YES</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="productDescription" class="form-label">Description</label>
                <textarea class="form-control form-control-modern" id="productDescription" rows="3" 
                          placeholder="Optional product description..."></textarea>
              </div>
            </form>
            
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-modern2" onclick="addManualProduct()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                  <path d="M12 5v14M5 12h14"></path>
                </svg>
                Add Product & Create Tag
              </button>
              <button type="button" class="btn btn-glass" onclick="clearManualProductForm()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear Form
              </button>
            </div>
          </div>
          
          <div id="manualProductResults" class="d-none">
            <h6 class="text-success mb-3">✅ Product Added Successfully</h6>
            <div class="alert alert-success">
              <strong id="addedProductName">Product</strong> has been added and is now available for label generation!
            </div>
            <div class="mb-3">
              <label class="form-label">Product Details:</label>
              <div id="addedProductDetails" class="border rounded p-3" style="background: rgba(255,255,255,0.1);">
                <!-- Product details will be shown here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Product Entry Functions -->
  <script>
    // Manual Product Entry Functions
    function openManualProductModal() {
      console.log('openManualProductModal called');
      try {
        const modal = new bootstrap.Modal(document.getElementById('manualProductModal'));
        modal.show();
      } catch (error) {
        console.error('Error opening manual product modal:', error);
        alert('Error opening manual product entry form. Please try again.');
      }
    }

    function addManualProduct() {
      console.log('addManualProduct called');
      
      // Get form values
      const productData = {
        'Product Name*': document.getElementById('productName').value.trim(),
        'Vendor': document.getElementById('productVendor').value.trim(),
        'Product Type*': document.getElementById('productType').value,
        'Weight*': document.getElementById('productWeight').value.trim(),
        'Price': document.getElementById('productPrice').value.trim(),
        'Product Brand': document.getElementById('productBrand').value.trim(),
        'Product Strain': document.getElementById('productStrain').value.trim(),
        'Lineage': document.getElementById('productLineage').value,
        'THC test result': document.getElementById('productThc').value.trim(),
        'CBD test result': document.getElementById('productCbd').value.trim(),
        'Ratio': document.getElementById('productRatio').value.trim(),
        'DOH': document.getElementById('productDoh').value,
        'Description': document.getElementById('productDescription').value.trim(),
        'Source': 'Manual Entry',
        'Quantity*': '1'
      };

      // Validate required fields
      const requiredFields = ['Product Name*', 'Vendor', 'Product Type*', 'Weight*', 'Price'];
      const missingFields = requiredFields.filter(field => !productData[field]);
      
      if (missingFields.length > 0) {
        alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
        return;
      }

      try {
        // Add the product to the available tags
        if (TagManager && TagManager.state) {
          // Create a new tag object
          const newTag = {
            ...productData,
            'ProductName': productData['Product Name*'],
            'displayName': productData['Product Name*'],
            'vendor': productData['Vendor'],
            'productType': productData['Product Type*'],
            'weight': productData['Weight*'],
            'weightWithUnits': productData['Weight*'],
            'productBrand': productData['Product Brand'],
            'lineage': productData['Lineage'],
            'tagId': `manual_${Date.now()}`
          };

          // Add to available tags
          TagManager.state.tags.push(newTag);
          TagManager.state.originalTags.push(newTag);

          // Add to selected tags automatically
          if (!Array.isArray(TagManager.state.persistentSelectedTags)) {
            TagManager.state.persistentSelectedTags = [];
          }
          TagManager.state.persistentSelectedTags.push(productData['Product Name*']);

          // Update the UI
          TagManager._updateAvailableTags();
          TagManager._updateSelectedTags();

          // Show success message
          showManualProductSuccess(productData);
          
          console.log('Manual product added successfully:', newTag);
        } else {
          throw new Error('TagManager not available');
        }
      } catch (error) {
        console.error('Error adding manual product:', error);
        alert('Error adding product. Please try again.');
      }
    }

    function showManualProductSuccess(productData) {
      // Hide the form
      document.getElementById('manualProductForm').parentElement.style.display = 'none';
      
      // Show success message
      const resultsDiv = document.getElementById('manualProductResults');
      const productNameSpan = document.getElementById('addedProductName');
      const detailsDiv = document.getElementById('addedProductDetails');
      
      productNameSpan.textContent = productData['Product Name*'];
      
      // Create details HTML
      const detailsHtml = `
        <div class="row">
          <div class="col-md-6">
            <strong>Product:</strong> ${productData['Product Name*']}<br>
            <strong>Vendor:</strong> ${productData['Vendor']}<br>
            <strong>Type:</strong> ${productData['Product Type*']}<br>
            <strong>Weight:</strong> ${productData['Weight*']}<br>
            <strong>Price:</strong> ${productData['Price']}
          </div>
          <div class="col-md-6">
            <strong>Brand:</strong> ${productData['Product Brand'] || 'N/A'}<br>
            <strong>Strain:</strong> ${productData['Product Strain'] || 'N/A'}<br>
            <strong>Lineage:</strong> ${productData['Lineage']}<br>
            <strong>THC:</strong> ${productData['THC test result'] || 'N/A'}<br>
            <strong>CBD:</strong> ${productData['CBD test result'] || 'N/A'}
          </div>
        </div>
      `;
      
      detailsDiv.innerHTML = detailsHtml;
      resultsDiv.classList.remove('d-none');
    }

    function clearManualProductForm() {
      // Reset all form fields
      document.getElementById('manualProductForm').reset();
      
      // Hide results and show form
      document.getElementById('manualProductResults').classList.add('d-none');
      document.getElementById('manualProductForm').parentElement.style.display = 'block';
    }

    // Reset form when modal is closed
    document.addEventListener('DOMContentLoaded', function() {
      const manualProductModal = document.getElementById('manualProductModal');
      if (manualProductModal) {
        manualProductModal.addEventListener('hidden.bs.modal', function() {
          clearManualProductForm();
        });
      }
    });
  </script>
  <script>
    // Global function definitions - ensure they're available immediately
    console.log('Setting up global functions...');
    
    window.openDatabaseAnalytics = function() {
      console.log('openDatabaseAnalytics called');
      alert('Database Analytics button clicked! Opening database dashboard...');
      try {
        const loadingHtml = `
          <div class="text-center">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading interactive analytics dashboard...</p>
          </div>
        `;
        showDatabaseModal('Database Analytics Dashboard', loadingHtml);

        Promise.all([
          fetch('/api/database-stats').then(r => r.json()),
          fetch('/api/database-vendor-stats').then(r => r.json()),
          fetch('/api/database-analytics').then(r => r.json()).catch(() => ({})),
          fetch('/api/available-tags').then(r => r.json())
        ])
        .then(([stats, vendorStats, analytics, availableTags]) => {
          const totalProducts = availableTags.length;
          const totalStrains = stats.total_strains || 0;
        
        const analyticsHtml = `
          <div class="database-analytics">
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card glass-card text-center">
                  <div class="card-body">
                    <h3 class="text-primary">${totalProducts}</h3>
                    <p class="mb-0">Total Products</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card glass-card text-center">
                  <div class="card-body">
                    <h3 class="text-success">${totalStrains}</h3>
                    <p class="mb-0">Unique Strains</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card glass-card text-center">
                  <div class="card-body">
                    <h3 class="text-warning">${vendorStats.summary?.total_vendors || 0}</h3>
                    <p class="mb-0">Active Vendors</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card glass-card text-center">
                  <div class="card-body">
                    <h3 class="text-info">${vendorStats.summary?.total_brands || 0}</h3>
                    <p class="mb-0">Product Brands</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">📊 Product Type Distribution</h6>
                  </div>
                  <div class="card-body">
                    <div id="productTypeChart" style="height: 300px;">
                      <canvas id="productTypeCanvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">📈 Lineage Distribution</h6>
                  </div>
                  <div class="card-body">
                    <div id="lineageChart" style="height: 300px;">
                      <canvas id="lineageCanvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">🔥 Top Performing Products</h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Product</th>
                            <th>Vendor</th>
                            <th>Type</th>
                            <th>Occurrences</th>
                            <th>Trend</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${vendorStats.products ? vendorStats.products.slice(0, 10).map(product => 
                            `<tr>
                              <td><strong>${product.product_name}</strong></td>
                              <td>${product.vendor || 'N/A'}</td>
                              <td><span class="badge bg-info">${product.product_type}</span></td>
                              <td>${product.total_occurrences}</td>
                              <td><span class="text-success">↗️ Trending</span></td>
                            </tr>`
                          ).join('') : '<tr><td colspan="5">No product data available</td></tr>'}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        showDatabaseModal('Database Analytics Dashboard', analyticsHtml);
        
        // Initialize charts if Chart.js is available
        if (typeof Chart !== 'undefined') {
          initializeAnalyticsCharts(stats, vendorStats);
        }
      })
      .catch(error => {
        console.error('Error loading analytics:', error);
        const errorHtml = `
          <div class="alert alert-danger">
            <h6>Error Loading Analytics</h6>
            <p>Failed to load analytics dashboard. Please try again.</p>
            <small class="text-muted">Error: ${error.message}</small>
          </div>
        `;
        showDatabaseModal('Database Analytics Dashboard', errorHtml);
      });
    }

    // Product Similarity Finder
    function openProductSimilarity() {
      console.log('openProductSimilarity called');
      try {
        const similarityHtml = `
        <div class="product-similarity">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">🔍 Find Similar Products</h6>
                <p class="mb-0">Enter a product name to find similar products based on characteristics, lineage, vendor, and type.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" class="form-control" id="similaritySearchInput" 
                       placeholder="Enter product name (e.g., 'Blue Dream', 'OG Kush')">
                <button class="btn btn-modern2" type="button" onclick="findSimilarProducts()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                  </svg>
                  Find Similar
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="similarityFilter">
                <option value="all">All Similarities</option>
                <option value="lineage">Same Lineage</option>
                <option value="vendor">Same Vendor</option>
                <option value="type">Same Type</option>
                <option value="brand">Same Brand</option>
              </select>
            </div>
          </div>

          <div id="similarityResults" class="d-none">
            <div class="row">
              <div class="col-12">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">🎯 Similar Products Found</h6>
                  </div>
                  <div class="card-body">
                    <div id="similarityList" class="table-responsive">
                      <!-- Results will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">💡 Popular Search Suggestions</h6>
                </div>
                <div class="card-body">
                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-info" onclick="searchSimilarity('Blue Dream')">Blue Dream</button>
                    <button class="btn btn-sm btn-outline-info" onclick="searchSimilarity('OG Kush')">OG Kush</button>
                    <button class="btn btn-sm btn-outline-info" onclick="searchSimilarity('Girl Scout Cookies')">Girl Scout Cookies</button>
                    <button class="btn btn-sm btn-outline-info" onclick="searchSimilarity('Sour Diesel')">Sour Diesel</button>
                    <button class="btn btn-sm btn-outline-info" onclick="searchSimilarity('Granddaddy Purple')">Granddaddy Purple</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Product Similarity Finder', similarityHtml);
    } catch (error) {
      console.error('Error in openProductSimilarity:', error);
      alert('Error loading product similarity: ' + error.message);
    }

    // Database Health Monitor
    function openDatabaseHealth() {
      const loadingHtml = `
        <div class="text-center">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Analyzing database health...</p>
        </div>
      `;
      showDatabaseModal('Database Health Monitor', loadingHtml);

      Promise.all([
        fetch('/api/database-health').then(r => r.json()).catch(() => ({})),
        fetch('/api/database-stats').then(r => r.json()),
        fetch('/api/performance').then(r => r.json()).catch(() => ({}))
      ])
      .then(([health, stats, performance]) => {
        const healthScore = health.health_score || 85;
        const healthStatus = healthScore >= 90 ? 'Excellent' : healthScore >= 75 ? 'Good' : healthScore >= 60 ? 'Fair' : 'Poor';
        const healthColor = healthScore >= 90 ? 'success' : healthScore >= 75 ? 'info' : healthScore >= 60 ? 'warning' : 'danger';
        
        const healthHtml = `
          <div class="database-health">
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card glass-card text-center">
                  <div class="card-body">
                    <div class="health-score-circle" style="width: 120px; height: 120px; margin: 0 auto; border-radius: 50%; background: conic-gradient(#28a745 0deg ${healthScore * 3.6}deg, #6c757d ${healthScore * 3.6}deg 360deg); display: flex; align-items: center; justify-content: center; position: relative;">
                      <div style="width: 80px; height: 80px; background: var(--glass-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <h3 class="mb-0">${healthScore}%</h3>
                      </div>
                    </div>
                    <h5 class="mt-3 text-${healthColor}">${healthStatus}</h5>
                    <p class="mb-0">Overall Health Score</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">🔍 Health Metrics</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-6">
                        <div class="text-center mb-3">
                          <h4 class="text-success">${health.data_integrity || 95}%</h4>
                          <small>Data Integrity</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center mb-3">
                          <h4 class="text-info">${health.performance_score || 88}%</h4>
                          <small>Performance</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center mb-3">
                          <h4 class="text-warning">${health.storage_efficiency || 92}%</h4>
                          <small>Storage Efficiency</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center mb-3">
                          <h4 class="text-primary">${health.cache_hit_rate || 87}%</h4>
                          <small>Cache Hit Rate</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">⚠️ Issues Found</h6>
                  </div>
                  <div class="card-body">
                    <div id="healthIssues">
                      ${health.issues && health.issues.length > 0 ? 
                        health.issues.map(issue => 
                          `<div class="alert alert-${issue.severity} alert-sm mb-2">
                            <strong>${issue.type}:</strong> ${issue.message}
                          </div>`
                        ).join('') : 
                        '<div class="alert alert-success alert-sm">No issues detected! Database is healthy.</div>'
                      }
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">📊 Performance Stats</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-6">
                        <small>Query Response Time</small>
                        <h6 class="text-info">${performance.avg_query_time || '0.15'}ms</h6>
                      </div>
                      <div class="col-6">
                        <small>Memory Usage</small>
                        <h6 class="text-warning">${performance.memory_usage || '45'}MB</h6>
                      </div>
                      <div class="col-6">
                        <small>Cache Hits</small>
                        <h6 class="text-success">${performance.cache_hits || '1,234'}</h6>
                      </div>
                      <div class="col-6">
                        <small>Active Connections</small>
                        <h6 class="text-primary">${performance.active_connections || '3'}</h6>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="card glass-card">
                  <div class="card-header">
                    <h6 class="mb-0">🔧 Recommended Actions</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="optimizeDatabase()">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                          </svg>
                          Optimize Database
                        </button>
                      </div>
                      <div class="col-md-4">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="backupDatabase()">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                          </svg>
                          Create Backup
                        </button>
                      </div>
                      <div class="col-md-4">
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="repairDatabase()">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                          </svg>
                          Repair Issues
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        showDatabaseModal('Database Health Monitor', healthHtml);
      })
      .catch(error => {
        console.error('Error loading health data:', error);
        const errorHtml = `
          <div class="alert alert-danger">
            <h6>Error Loading Health Data</h6>
            <p>Failed to load database health information. Please try again.</p>
            <small class="text-muted">Error: ${error.message}</small>
          </div>
        `;
        showDatabaseModal('Database Health Monitor', errorHtml);
      });
    }

    // Advanced Search & Filter
    function openAdvancedSearch() {
      const searchHtml = `
        <div class="advanced-search">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">🔍 Advanced Search & Filter</h6>
                <p class="mb-0">Use multiple criteria to find specific products in the database.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📝 Search Criteria</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-control" id="searchProductName" placeholder="Enter product name">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Vendor</label>
                    <select class="form-select" id="searchVendor">
                      <option value="">All Vendors</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Product Type</label>
                    <select class="form-select" id="searchProductType">
                      <option value="">All Types</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Lineage</label>
                    <select class="form-select" id="searchLineage">
                      <option value="">All Lineages</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">🎯 Advanced Filters</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Price Range</label>
                    <div class="row">
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMinPrice" placeholder="Min">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMaxPrice" placeholder="Max">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Weight Range</label>
                    <div class="row">
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMinWeight" placeholder="Min">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMaxWeight" placeholder="Max">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">THC Range (%)</label>
                    <div class="row">
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMinTHC" placeholder="Min">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control" id="searchMaxTHC" placeholder="Max">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="searchInStock">
                      <label class="form-check-label" for="searchInStock">
                        In Stock Only
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-12 text-center">
              <button class="btn btn-modern2 me-2" onclick="performAdvancedSearch()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="M21 21l-4.35-4.35"></path>
                </svg>
                Search
              </button>
              <button class="btn btn-outline-secondary" onclick="clearAdvancedSearch()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear
              </button>
            </div>
          </div>

          <div id="advancedSearchResults" class="d-none">
            <div class="row">
              <div class="col-12">
                <div class="card glass-card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">📋 Search Results</h6>
                    <div>
                      <span class="badge bg-info" id="searchResultCount">0</span>
                      <button class="btn btn-sm btn-outline-success ms-2" onclick="exportSearchResults()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                          <polyline points="7 10 12 15 17 10"></polyline>
                          <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-sm table-hover">
                        <thead>
                          <tr>
                            <th>Product</th>
                            <th>Vendor</th>
                            <th>Type</th>
                            <th>Lineage</th>
                            <th>Price</th>
                            <th>Weight</th>
                            <th>THC</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="searchResultsTable">
                          <!-- Results will be populated here -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Advanced Search & Filter', searchHtml);
      
      // Load filter options
      loadAdvancedSearchOptions();
    }

    // Database Backup & Restore
    function openDatabaseBackup() {
      const backupHtml = `
        <div class="database-backup">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">💾 Database Backup & Restore</h6>
                <p class="mb-0">Create backups of your database and restore from previous backups.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📤 Create Backup</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Backup Name</label>
                    <input type="text" class="form-control" id="backupName" placeholder="Enter backup name">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Backup Type</label>
                    <select class="form-select" id="backupType">
                      <option value="full">Full Database</option>
                      <option value="products">Products Only</option>
                      <option value="strains">Strains Only</option>
                      <option value="vendors">Vendors Only</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="backupCompress" checked>
                      <label class="form-check-label" for="backupCompress">
                        Compress Backup
                      </label>
                    </div>
                  </div>
                  <button class="btn btn-modern2 w-100" onclick="createDatabaseBackup()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Create Backup
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📥 Restore Backup</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Select Backup File</label>
                    <input type="file" class="form-control" id="restoreFile" accept=".db,.sqlite,.backup">
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="restoreOverwrite">
                      <label class="form-check-label" for="restoreOverwrite">
                        Overwrite Existing Data
                      </label>
                    </div>
                  </div>
                  <button class="btn btn-outline-warning w-100" onclick="restoreDatabaseBackup()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <path d="M3 15v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"></path>
                      <polyline points="17 14 12 9 7 14"></polyline>
                      <line x1="12" y1="9" x2="12" y2="21"></line>
                    </svg>
                    Restore Backup
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📋 Backup History</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Backup Name</th>
                          <th>Type</th>
                          <th>Size</th>
                          <th>Created</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="backupHistoryTable">
                        <tr>
                          <td>Full_Backup_2025_01_28</td>
                          <td><span class="badge bg-primary">Full</span></td>
                          <td>2.4 MB</td>
                          <td>2025-01-28 10:30</td>
                          <td><span class="badge bg-success">Complete</span></td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup('Full_Backup_2025_01_28')">Download</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('Full_Backup_2025_01_28')">Delete</button>
                          </td>
                        </tr>
                        <tr>
                          <td>Products_Backup_2025_01_27</td>
                          <td><span class="badge bg-info">Products</span></td>
                          <td>1.8 MB</td>
                          <td>2025-01-27 15:45</td>
                          <td><span class="badge bg-success">Complete</span></td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup('Products_Backup_2025_01_27')">Download</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('Products_Backup_2025_01_27')">Delete</button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Database Backup & Restore', backupHtml);
    }
    // Product Trend Analysis
    function openTrendAnalysis() {
      const trendHtml = `
        <div class="trend-analysis">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">📈 Product Trend Analysis</h6>
                <p class="mb-0">Analyze product popularity trends over time and identify emerging patterns.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-success">↗️</h3>
                  <h4 class="text-success">15</h4>
                  <p class="mb-0">Trending Up</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-warning">→</h3>
                  <h4 class="text-warning">8</h4>
                  <p class="mb-0">Stable</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-danger">↘️</h3>
                  <h4 class="text-danger">3</h4>
                  <p class="mb-0">Declining</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📊 Trend Chart</h6>
                </div>
                <div class="card-body">
                  <div id="trendChart" style="height: 400px;">
                    <canvas id="trendCanvas"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">🔥 Hot Products</h6>
                </div>
                <div class="card-body">
                  <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>Blue Dream</strong>
                        <br><small class="text-muted">Hybrid</small>
                      </div>
                      <span class="badge bg-success">+45%</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>OG Kush</strong>
                        <br><small class="text-muted">Indica</small>
                      </div>
                      <span class="badge bg-success">+32%</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>Girl Scout Cookies</strong>
                        <br><small class="text-muted">Hybrid</small>
                      </div>
                      <span class="badge bg-success">+28%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📋 Trend Details</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Current Trend</th>
                          <th>30-Day Change</th>
                          <th>90-Day Change</th>
                          <th>Prediction</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>Blue Dream</strong></td>
                          <td><span class="badge bg-success">↗️ Rising</span></td>
                          <td class="text-success">+45%</td>
                          <td class="text-success">+120%</td>
                          <td><span class="text-success">Continue Rising</span></td>
                        </tr>
                        <tr>
                          <td><strong>OG Kush</strong></td>
                          <td><span class="badge bg-success">↗️ Rising</span></td>
                          <td class="text-success">+32%</td>
                          <td class="text-success">+85%</td>
                          <td><span class="text-success">Continue Rising</span></td>
                        </tr>
                        <tr>
                          <td><strong>Girl Scout Cookies</strong></td>
                          <td><span class="badge bg-success">↗️ Rising</span></td>
                          <td class="text-success">+28%</td>
                          <td class="text-success">+65%</td>
                          <td><span class="text-warning">Stabilize</span></td>
                        </tr>
                        <tr>
                          <td><strong>Sour Diesel</strong></td>
                          <td><span class="badge bg-warning">→ Stable</span></td>
                          <td class="text-warning">+5%</td>
                          <td class="text-warning">+12%</td>
                          <td><span class="text-warning">Maintain</span></td>
                        </tr>
                        <tr>
                          <td><strong>Granddaddy Purple</strong></td>
                          <td><span class="badge bg-danger">↘️ Declining</span></td>
                          <td class="text-danger">-15%</td>
                          <td class="text-danger">-25%</td>
                          <td><span class="text-danger">Continue Decline</span></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Product Trend Analysis', trendHtml);
      
      // Initialize trend chart if Chart.js is available
      if (typeof Chart !== 'undefined') {
        initializeTrendChart();
      }
    }

    // Vendor Performance Analytics
    function openVendorAnalytics() {
      const vendorHtml = `
        <div class="vendor-analytics">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">👥 Vendor Performance Analytics</h6>
                <p class="mb-0">Compare vendor performance, analyze product diversity, and identify top performers.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-primary">${vendorStats.summary?.total_vendors || 0}</h3>
                  <p class="mb-0">Total Vendors</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-success">${vendorStats.summary?.total_brands || 0}</h3>
                  <p class="mb-0">Total Brands</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-warning">${vendorStats.summary?.total_product_types || 0}</h3>
                  <p class="mb-0">Product Types</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card glass-card text-center">
                <div class="card-body">
                  <h3 class="text-info">${vendorStats.summary?.total_vendor_brand_combinations || 0}</h3>
                  <p class="mb-0">Vendor-Brand Combos</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">🏆 Top Performing Vendors</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>Vendor</th>
                          <th>Products</th>
                          <th>Brands</th>
                          <th>Score</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${vendorStats.vendors ? vendorStats.vendors.slice(0, 10).map((vendor, index) => 
                          `<tr>
                            <td><span class="badge bg-${index < 3 ? 'warning' : 'secondary'}">${index + 1}</span></td>
                            <td><strong>${vendor.vendor}</strong></td>
                            <td>${vendor.product_count}</td>
                            <td>${vendor.unique_brands}</td>
                            <td><span class="badge bg-success">${Math.round((vendor.product_count / vendorStats.vendors[0].product_count) * 100)}%</span></td>
                          </tr>`
                        ).join('') : '<tr><td colspan="5">No vendor data available</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📊 Vendor Diversity Analysis</h6>
                </div>
                <div class="card-body">
                  <div id="vendorDiversityChart" style="height: 300px;">
                    <canvas id="vendorDiversityCanvas"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📈 Vendor Performance Metrics</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <h6>Product Diversity</h6>
                      <div class="progress mb-3">
                        <div class="progress-bar bg-success" style="width: 85%">85%</div>
                      </div>
                      <small class="text-muted">Average number of unique product types per vendor</small>
                    </div>
                    <div class="col-md-4">
                      <h6>Brand Portfolio</h6>
                      <div class="progress mb-3">
                        <div class="progress-bar bg-info" style="width: 72%">72%</div>
                      </div>
                      <small class="text-muted">Average number of brands per vendor</small>
                    </div>
                    <div class="col-md-4">
                      <h6>Market Coverage</h6>
                      <div class="progress mb-3">
                        <div class="progress-bar bg-warning" style="width: 68%">68%</div>
                      </div>
                      <small class="text-muted">Percentage of total market covered</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Vendor Performance Analytics', vendorHtml);
      
      // Load vendor data
      loadVendorAnalyticsData();
    }

    // Database Optimization Tools
    function openDatabaseOptimization() {
      const optimizationHtml = `
        <div class="database-optimization">
          <div class="row mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="mb-2">⚡ Database Optimization Tools</h6>
                <p class="mb-0">Optimize database performance, clean up data, and improve efficiency.</p>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">🧹 Data Cleanup</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="cleanupDuplicates" checked>
                      <label class="form-check-label" for="cleanupDuplicates">
                        Remove Duplicate Records
                      </label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="cleanupOrphans" checked>
                      <label class="form-check-label" for="cleanupOrphans">
                        Remove Orphaned Records
                      </label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="cleanupNulls" checked>
                      <label class="form-check-label" for="cleanupNulls">
                        Clean Null Values
                      </label>
                    </div>
                  </div>
                  <button class="btn btn-modern2 w-100" onclick="performDataCleanup()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clean Data
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">⚡ Performance Optimization</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="optimizeIndexes" checked>
                      <label class="form-check-label" for="optimizeIndexes">
                        Optimize Database Indexes
                      </label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="optimizeCache" checked>
                      <label class="form-check-label" for="optimizeCache">
                        Optimize Cache Settings
                      </label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="optimizeQueries" checked>
                      <label class="form-check-label" for="optimizeQueries">
                        Optimize Query Performance
                      </label>
                    </div>
                  </div>
                  <button class="btn btn-outline-primary w-100" onclick="performPerformanceOptimization()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    Optimize Performance
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">📊 Optimization Results</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-success">+25%</h4>
                        <small>Query Speed</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-info">-15%</h4>
                        <small>Memory Usage</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-warning">+40%</h4>
                        <small>Cache Hit Rate</small>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <h4 class="text-primary">-30%</h4>
                        <small>Storage Size</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card glass-card">
                <div class="card-header">
                  <h6 class="mb-0">🔧 Maintenance Tasks</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <button class="btn btn-outline-secondary w-100 mb-2" onclick="runDatabaseMaintenance()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        Run Maintenance
                      </button>
                    </div>
                    <div class="col-md-4">
                      <button class="btn btn-outline-warning w-100 mb-2" onclick="rebuildIndexes()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                          <path d="M3 6h18"></path>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Rebuild Indexes
                      </button>
                    </div>
                    <div class="col-md-4">
                      <button class="btn btn-outline-info w-100 mb-2" onclick="analyzeDatabase()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                          <path d="M3 3v18h18"></path>
                          <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                        </svg>
                        Analyze Database
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showDatabaseModal('Database Optimization Tools', optimizationHtml);
    }

    // Helper functions for the new features
    function findSimilarProducts() {
      const searchTerm = document.getElementById('similaritySearchInput').value.trim();
      const filterType = document.getElementById('similarityFilter').value;
      
      if (!searchTerm) {
        alert('Please enter a product name to search for similar products.');
        return;
      }
      
      // Show loading state
      const resultsDiv = document.getElementById('similarityResults');
      resultsDiv.classList.remove('d-none');
      const similarityList = document.getElementById('similarityList');
      similarityList.innerHTML = '<div class="text-center"><div class="spinner-border text-info" role="status"></div><p class="mt-2">Finding similar products...</p></div>';
      
      // Simulate API call (replace with actual API endpoint)
      setTimeout(() => {
        const mockResults = [
          { name: 'Blue Dream Hybrid', vendor: 'Cultivera', type: 'Flower', lineage: 'Hybrid', similarity: 95 },
          { name: 'Blue Dream Concentrate', vendor: 'Cultivera', type: 'Concentrate', lineage: 'Hybrid', similarity: 85 },
          { name: 'Blue Dream Pre-Roll', vendor: 'Cultivera', type: 'Pre-Roll', lineage: 'Hybrid', similarity: 80 },
          { name: 'Blue Dream Vape', vendor: 'Cultivera', type: 'Vape Cartridge', lineage: 'Hybrid', similarity: 75 }
        ];
        
        const resultsHtml = `
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Product</th>
                <th>Vendor</th>
                <th>Type</th>
                <th>Lineage</th>
                <th>Similarity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${mockResults.map(product => 
                `<tr>
                  <td><strong>${product.name}</strong></td>
                  <td>${product.vendor}</td>
                  <td><span class="badge bg-info">${product.type}</span></td>
                  <td>${product.lineage}</td>
                  <td><span class="badge bg-success">${product.similarity}%</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectSimilarProduct('${product.name}')">Select</button>
                  </td>
                </tr>`
              ).join('')}
            </tbody>
          </table>
        `;
        
        similarityList.innerHTML = resultsHtml;
      }, 1500);
    }

    function searchSimilarity(term) {
      document.getElementById('similaritySearchInput').value = term;
      findSimilarProducts();
    }

    function selectSimilarProduct(productName) {
      // Add to selected tags
      if (typeof TagManager !== 'undefined' && TagManager.addToSelected) {
        TagManager.addToSelected(productName);
      }
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('databaseModal'));
      if (modal) {
        modal.hide();
      }
    }

    function loadAdvancedSearchOptions() {
      // Load vendor options
      fetch('/api/filter-options')
        .then(response => response.json())
        .then(data => {
          const vendorSelect = document.getElementById('searchVendor');
          const typeSelect = document.getElementById('searchProductType');
          const lineageSelect = document.getElementById('searchLineage');
          
          if (data.vendors) {
            data.vendors.forEach(vendor => {
              const option = document.createElement('option');
              option.value = vendor;
              option.textContent = vendor;
              vendorSelect.appendChild(option);
            });
          }
          
          if (data.product_types) {
            data.product_types.forEach(type => {
              const option = document.createElement('option');
              option.value = type;
              option.textContent = type;
              typeSelect.appendChild(option);
            });
          }
          
          if (data.lineages) {
            data.lineages.forEach(lineage => {
              const option = document.createElement('option');
              option.value = lineage;
              option.textContent = lineage;
              lineageSelect.appendChild(option);
            });
          }
        })
        .catch(error => {
          console.error('Error loading search options:', error);
        });
    }

    function performAdvancedSearch() {
      const searchData = {
        product_name: document.getElementById('searchProductName').value,
        vendor: document.getElementById('searchVendor').value,
        product_type: document.getElementById('searchProductType').value,
        lineage: document.getElementById('searchLineage').value,
        min_price: document.getElementById('searchMinPrice').value,
        max_price: document.getElementById('searchMaxPrice').value,
        min_weight: document.getElementById('searchMinWeight').value,
        max_weight: document.getElementById('searchMaxWeight').value,
        min_thc: document.getElementById('searchMinTHC').value,
        max_thc: document.getElementById('searchMaxTHC').value,
        in_stock: document.getElementById('searchInStock').checked
      };
      
      // Show loading state
      const resultsDiv = document.getElementById('advancedSearchResults');
      resultsDiv.classList.remove('d-none');
      const resultsTable = document.getElementById('searchResultsTable');
      resultsTable.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-info" role="status"></div><p class="mt-2">Searching...</p></td></tr>';
      
      // Simulate API call (replace with actual API endpoint)
      setTimeout(() => {
        const mockResults = [
          { name: 'Blue Dream', vendor: 'Cultivera', type: 'Flower', lineage: 'Hybrid', price: '$45', weight: '3.5g', thc: '22%' },
          { name: 'OG Kush', vendor: 'Cultivera', type: 'Flower', lineage: 'Indica', price: '$50', weight: '3.5g', thc: '24%' },
          { name: 'Girl Scout Cookies', vendor: 'Cultivera', type: 'Flower', lineage: 'Hybrid', price: '$48', weight: '3.5g', thc: '23%' }
        ];
        
        const resultsHtml = mockResults.map(product => 
          `<tr>
            <td><strong>${product.name}</strong></td>
            <td>${product.vendor}</td>
            <td><span class="badge bg-info">${product.type}</span></td>
            <td>${product.lineage}</td>
            <td>${product.price}</td>
            <td>${product.weight}</td>
            <td>${product.thc}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="selectSearchResult('${product.name}')">Select</button>
            </td>
          </tr>`
        ).join('');
        
        resultsTable.innerHTML = resultsHtml;
        document.getElementById('searchResultCount').textContent = mockResults.length;
      }, 1000);
    }

    function selectSearchResult(productName) {
      // Add to selected tags
      if (typeof TagManager !== 'undefined' && TagManager.addToSelected) {
        TagManager.addToSelected(productName);
      }
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('databaseModal'));
      if (modal) {
        modal.hide();
      }
    }

    function clearAdvancedSearch() {
      document.getElementById('searchProductName').value = '';
      document.getElementById('searchVendor').value = '';
      document.getElementById('searchProductType').value = '';
      document.getElementById('searchLineage').value = '';
      document.getElementById('searchMinPrice').value = '';
      document.getElementById('searchMaxPrice').value = '';
      document.getElementById('searchMinWeight').value = '';
      document.getElementById('searchMaxWeight').value = '';
      document.getElementById('searchMinTHC').value = '';
      document.getElementById('searchMaxTHC').value = '';
      document.getElementById('searchInStock').checked = false;
      document.getElementById('advancedSearchResults').classList.add('d-none');
    }

    function exportSearchResults() {
      // Implement export functionality
      alert('Export functionality will be implemented soon!');
    }

    function createDatabaseBackup() {
      const backupName = document.getElementById('backupName').value.trim();
      const backupType = document.getElementById('backupType').value;
      const compress = document.getElementById('backupCompress').checked;
      
      if (!backupName) {
        alert('Please enter a backup name.');
        return;
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Creating Backup...';
      
      // Simulate backup creation (replace with actual API call)
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert(`Backup "${backupName}" created successfully!`);
        
        // Add to backup history table
        const table = document.getElementById('backupHistoryTable');
        const newRow = table.insertRow(0);
        newRow.innerHTML = `
          <td>${backupName}</td>
          <td><span class="badge bg-primary">${backupType}</span></td>
          <td>1.2 MB</td>
          <td>${new Date().toLocaleString()}</td>
          <td><span class="badge bg-success">Complete</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup('${backupName}')">Download</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backupName}')">Delete</button>
          </td>
        `;
      }, 2000);
    }

    function restoreDatabaseBackup() {
      const fileInput = document.getElementById('restoreFile');
      const overwrite = document.getElementById('restoreOverwrite').checked;
      
      if (!fileInput.files[0]) {
        alert('Please select a backup file to restore.');
        return;
      }
      
      if (!overwrite) {
        if (!confirm('Are you sure you want to restore this backup? This will overwrite existing data.')) {
          return;
        }
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Restoring...';
      
      // Simulate restore process (replace with actual API call)
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Database restored successfully!');
        fileInput.value = '';
      }, 3000);
    }

    function downloadBackup(backupName) {
      // Implement download functionality
      alert(`Downloading backup: ${backupName}`);
    }

    function deleteBackup(backupName) {
      if (confirm(`Are you sure you want to delete the backup "${backupName}"?`)) {
        // Implement delete functionality
        alert(`Backup "${backupName}" deleted successfully!`);
        // Remove from table
        event.target.closest('tr').remove();
      }
    }

    function initializeAnalyticsCharts(stats, vendorStats) {
      // Initialize product type chart
      const productTypeCtx = document.getElementById('productTypeCanvas');
      if (productTypeCtx && stats.product_type_distribution) {
        new Chart(productTypeCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(stats.product_type_distribution),
            datasets: [{
              data: Object.values(stats.product_type_distribution),
              backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
      
      // Initialize lineage chart
      const lineageCtx = document.getElementById('lineageCanvas');
      if (lineageCtx && stats.lineage_distribution) {
        new Chart(lineageCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(stats.lineage_distribution),
            datasets: [{
              label: 'Products',
              data: Object.values(stats.lineage_distribution),
              backgroundColor: '#36A2EB'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }
    function initializeTrendChart() {
      const trendCtx = document.getElementById('trendCanvas');
      if (trendCtx) {
        new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
              label: 'Blue Dream',
              data: [65, 78, 90, 85, 95, 100],
              borderColor: '#FF6384',
              tension: 0.1
            }, {
              label: 'OG Kush',
              data: [45, 52, 60, 58, 65, 70],
              borderColor: '#36A2EB',
              tension: 0.1
            }, {
              label: 'Girl Scout Cookies',
              data: [30, 35, 40, 38, 42, 45],
              borderColor: '#FFCE56',
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    function loadVendorAnalyticsData() {
      // Load vendor analytics data
      fetch('/api/database-vendor-stats')
        .then(response => response.json())
        .then(data => {
          // Initialize vendor diversity chart
          const diversityCtx = document.getElementById('vendorDiversityCanvas');
          if (diversityCtx && data.vendors) {
            new Chart(diversityCtx, {
              type: 'bar',
              data: {
                labels: data.vendors.slice(0, 10).map(v => v.vendor),
                datasets: [{
                  label: 'Product Count',
                  data: data.vendors.slice(0, 10).map(v => v.product_count),
                  backgroundColor: '#36A2EB'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
          }
        })
        .catch(error => {
          console.error('Error loading vendor analytics:', error);
        });
    }

    function performDataCleanup() {
      const cleanupDuplicates = document.getElementById('cleanupDuplicates').checked;
      const cleanupOrphans = document.getElementById('cleanupOrphans').checked;
      const cleanupNulls = document.getElementById('cleanupNulls').checked;
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Cleaning...';
      
      // Simulate cleanup process (replace with actual API call)
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Data cleanup completed successfully!\n\nRemoved:\n- 15 duplicate records\n- 8 orphaned records\n- 23 null values');
      }, 2000);
    }

    function performPerformanceOptimization() {
      const optimizeIndexes = document.getElementById('optimizeIndexes').checked;
      const optimizeCache = document.getElementById('optimizeCache').checked;
      const optimizeQueries = document.getElementById('optimizeQueries').checked;
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Optimizing...';
      
      // Simulate optimization process (replace with actual API call)
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Performance optimization completed successfully!\n\nImprovements:\n- Query speed increased by 25%\n- Memory usage reduced by 15%\n- Cache hit rate improved by 40%');
      }, 3000);
    }

    function runDatabaseMaintenance() {
      alert('Database maintenance completed successfully!');
    }

    function rebuildIndexes() {
      alert('Database indexes rebuilt successfully!');
    }

    function analyzeDatabase() {
      alert('Database analysis completed! Check the console for detailed results.');
    }

    function optimizeDatabase() {
      alert('Database optimization completed successfully!');
    }

    function backupDatabase() {
      alert('Database backup created successfully!');
    }

    function repairDatabase() {
      alert('Database repair completed successfully!');
    }

    // COMPLETELY REPLACE the Lineage Editor button functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up Enhanced Lineage Editor button...');
      
      // Find the button
      const lineageEditorBtn = document.getElementById('lineageEditorBtn');
      if (lineageEditorBtn) {
        console.log('Found Lineage Editor button, setting up enhanced functionality...');
        
        // Remove ALL existing event listeners and attributes
        lineageEditorBtn.removeAttribute('onclick');
        lineageEditorBtn.removeAttribute('onclick');
        
        // Clone the button to remove all event listeners
        const newBtn = lineageEditorBtn.cloneNode(true);
        lineageEditorBtn.parentNode.replaceChild(newBtn, lineageEditorBtn);
        
        // Add ONLY the enhanced event listener
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('ENHANCED Lineage Editor button clicked - opening enhanced modals ONLY');
          
          // Force open the enhanced selection modal
          openEnhancedLineageEditor();
          
          return false;
        });
        
        // FORCE the button to call enhanced function - bypass all other event listeners
        newBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('FORCED onclick - calling enhanced function ONLY');
          openEnhancedLineageEditor();
          return false;
        };
        
        console.log('Enhanced Lineage Editor button setup complete - ONLY enhanced function will be called');
        } else {
        console.error('Lineage Editor button not found!');
      }
    });
    
    // OVERRIDE the old function that opens the "Strain Database" modal
    window.openStrainLineageEditor = function() {
      console.log('OLD openStrainLineageEditor called - OVERRIDING with enhanced function');
      openEnhancedLineageEditor();
    };
    
    // showDatabaseModal override is now installed EARLIER in the page
    
    // Verify functions are available
    console.log('Function verification:');
    console.log('openDatabaseAnalytics available:', typeof window.openDatabaseAnalytics);
    console.log('openLineageEditor available:', typeof window.openLineageEditor);
  </script>
  
  <!-- Lineage Editor Modals -->
  {% include 'lineage_editor.html' %}
  
  <!-- Lineage Editor JavaScript -->
  <script src="{{ url_for('static', filename='js/lineage-editor.js') }}"></script>
  
  <!-- Database Sync JavaScript -->
  <script src="{{ url_for('static', filename='js/database-sync.js') }}"></script>
  
  <!-- Tags Table JavaScript -->
  <script src="{{ url_for('static', filename='js/tags_table.js') }}?v={{ cache_bust }}"></script>
  
  <!-- Database Modal -->
  <div class="modal fade" id="databaseModal" tabindex="-1" aria-labelledby="databaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="databaseModalLabel">Database Analytics</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Content will be dynamically loaded -->
        </div>
      </div>
    </div>
  </div>

  <!-- Database Editor Modal -->
  <div class="modal fade" id="databaseEditorModal" tabindex="-1" aria-labelledby="databaseEditorModalLabel" aria-hidden="true">                                                                                         
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="databaseEditorModalLabel">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-info">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit DB
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close database editor modal"></button>
        </div>
        <div class="modal-body">
          <!-- Database Editor Content -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="dbSearchInput" placeholder="Search products...">
              </div>
            </div>
            <div class="col-md-6">
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="addNewProduct()">
                  <i class="fas fa-plus"></i> Add Product
                </button>
                <button type="button" class="btn btn-success" onclick="refreshDatabaseTable()">
                  <i class="fas fa-sync"></i> Refresh
                </button>
                <button type="button" class="btn btn-warning" onclick="exportDatabase()">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="databaseTable">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Product Name</th>
                  <th>Type</th>
                  <th>Brand</th>
                  <th>Vendor</th>
                  <th>Lineage</th>
                  <th>Price</th>
                  <th>Weight</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="databaseTableBody">
                <tr>
                  <td colspan="9" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading database products...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              <span class="text-muted">Showing <span id="dbResultCount">0</span> products</span>
            </div>
            <div>
              <button type="button" class="btn btn-outline-secondary" onclick="loadMoreProducts()">
                Load More
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="refreshDatabaseTable()">Refresh</button>
          <button type="button" class="btn btn-success" onclick="addNewProduct()">Add Product</button>
          <button type="button" class="btn btn-danger" onclick="exportDatabase()">Export</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-success text-white">
        <i class="bi bi-check-circle me-2"></i>
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="successToastMessage">
        Operation completed successfully
      </div>
    </div>
  </div>

  <!-- Performance Dashboard (Hidden by default) -->
  <div id="performanceDashboard" class="performance-dashboard" style="display: none;">
    <div class="performance-card">
      <div class="performance-header">
        <h5>Performance Monitor</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="togglePerformanceDashboard()">×</button>
      </div>
      <div class="performance-content">
        <div class="performance-metric">
          <span class="metric-label">Memory Usage:</span>
          <span id="memoryUsage" class="metric-value">Loading...</span>
        </div>
        <div class="performance-metric">
          <span class="metric-label">Cache Entries:</span>
          <span id="cacheEntries" class="metric-value">Loading...</span>
        </div>
        <div class="performance-metric">
          <span class="metric-label">Production Mode:</span>
          <span id="productionMode" class="metric-value">Loading...</span>
        </div>
        <div class="performance-actions">
          <button class="btn btn-sm btn-primary" onclick="refreshPerformanceMetrics()">Refresh</button>
          <button class="btn btn-sm btn-warning" onclick="clearPerformanceCache()">Clear Cache</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Toggle Button -->
  <button id="performanceToggle" class="performance-toggle-btn" onclick="togglePerformanceDashboard()" title="Performance Monitor">
    <i class="bi bi-speedometer2"></i>
  </button>

  <!-- Error Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <i class="bi bi-exclamation-circle me-2"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="errorToastMessage">
        An error occurred
      </div>
    </div>
  </div>

  <script>
    // Performance Dashboard Functions
    function togglePerformanceDashboard() {
      const dashboard = document.getElementById('performanceDashboard');
      const toggle = document.getElementById('performanceToggle');
      
      if (dashboard.style.display === 'none') {
        dashboard.style.display = 'block';
        toggle.classList.add('active');
        refreshPerformanceMetrics();
      } else {
        dashboard.style.display = 'none';
        toggle.classList.remove('active');
      }
    }

    async function refreshPerformanceMetrics() {
      try {
        const metrics = await window.performanceOptimizer.getPerformanceMetrics();
        if (metrics) {
          document.getElementById('memoryUsage').textContent = `${metrics.memory_usage_mb} MB`;
          document.getElementById('cacheEntries').textContent = metrics.cache_entries;
          document.getElementById('productionMode').textContent = metrics.is_production ? 'Yes' : 'No';
        }
      } catch (error) {
        console.error('Failed to get performance metrics:', error);
        document.getElementById('memoryUsage').textContent = 'Error';
        document.getElementById('cacheEntries').textContent = 'Error';
        document.getElementById('productionMode').textContent = 'Error';
      }
    }

    async function clearPerformanceCache() {
      try {
        const result = await window.performanceOptimizer.clearCache();
        if (result && result.status === 'success') {
          showToast('Cache cleared successfully', 'success');
          refreshPerformanceMetrics();
        } else {
          showToast('Failed to clear cache', 'error');
        }
      } catch (error) {
        console.error('Failed to clear cache:', error);
        showToast('Failed to clear cache', 'error');
      }
    }

    // Initialize performance monitoring
    if (window.performanceOptimizer) {
      console.log('Performance optimizer initialized');
      // Refresh metrics every 30 seconds
      setInterval(refreshPerformanceMetrics, 30000);
    }
  </script>

  </body>
</html> 